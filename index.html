<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Bull English Academy</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet"/>
<style>
/* ═══════════════════════════════════════════════════════════
   BULL ENGLISH ACADEMY  v3.0
   Aesthetic: Premium Dark Academia — Deep Obsidian + Warm Gold
   New: Speaking (SpeechRecognition) + Listening (SpeechSynthesis)
   Fix: Drag & Drop with unique chip IDs
   Profile: Hexagonal radar (6 skills)
   ═══════════════════════════════════════════════════════════ */

:root {
  /* Core palette */
  --ink:     #08080f;
  --ink2:    #0f0f1a;
  --ink3:    #161625;
  --ink4:    #1e1e35;
  --gold:    #d4a843;
  --gold2:   #f0c96a;
  --gold-g:  rgba(212,168,67,0.22);
  --blue:    #4a7cf7;
  --blue2:   #7aa2ff;
  --blue-g:  rgba(74,124,247,0.22);
  --ok:      #2dd4bf;
  --ok2:     #5eead4;
  --ok-g:    rgba(45,212,191,0.18);
  --err:     #f4657a;
  --err2:    #ff8fa3;
  --err-g:   rgba(244,101,122,0.18);
  --purp:    #a78bfa;
  --amber:   #fbbf24;
  --rose:    #fb7185;
  /* Text */
  --t1: #f0eee8;
  --t2: #a09898;
  --t3: #5a5468;
  --t4: #2e2b3a;
  /* Glass */
  --g1: rgba(255,255,255,0.045);
  --g2: rgba(255,255,255,0.075);
  --g3: rgba(255,255,255,0.11);
  --gb: rgba(255,255,255,0.07);
  --gbo: rgba(255,255,255,0.09);
  /* Type */
  --fh: 'Syne', sans-serif;
  --fb: 'DM Sans', sans-serif;
  --fi: 'DM Serif Display', serif;
  /* Radii */
  --r1:4px; --r2:8px; --r3:14px; --r4:20px; --r5:30px; --r6:50px;
  /* Nav */
  --nav: 68px;
  /* Shadows */
  --sh1: 0 2px 12px rgba(0,0,0,0.45);
  --sh2: 0 6px 28px rgba(0,0,0,0.55);
  --sh3: 0 16px 48px rgba(0,0,0,0.65);
  --shg: 0 0 32px rgba(212,168,67,0.15);
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0 }
html { height:100%; font-size:16px }
body {
  font-family: var(--fb);
  background: var(--ink);
  color: var(--t1);
  min-height: 100%;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
button { cursor:pointer; border:none; background:none; font-family:inherit; -webkit-tap-highlight-color:transparent }
input  { font-family:inherit }
img,canvas { display:block; max-width:100% }
::selection { background: var(--gold-g); color: var(--gold) }

/* Scrollbar */
::-webkit-scrollbar { width:4px }
::-webkit-scrollbar-track { background:transparent }
::-webkit-scrollbar-thumb { background:var(--t4); border-radius:2px }

/* ── Fixed user identity chip ─────────────────────── */
.user-chip {
  position: fixed;
  top: 10px;
  left: 12px;
  z-index: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px 6px 6px;
  background: rgba(8,8,15,0.88);
  border: 1px solid rgba(212,168,67,0.3);
  border-radius: 30px;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow: 0 2px 14px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05);
  cursor: pointer;
  transition: all .22s;
  animation: slideDown .3s ease;
}
.user-chip:hover {
  background: rgba(20,20,35,0.96);
  border-color: rgba(212,168,67,0.6);
  box-shadow: 0 4px 20px rgba(212,168,67,0.12);
  transform: translateY(-1px);
}
.user-chip.off { display:none }
.uc-av {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--ink4), #2a1e3e);
  border: 1.5px solid rgba(212,168,67,0.4);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; flex-shrink: 0;
}
.uc-info { display:flex; flex-direction:column; gap:1px; min-width:0 }
.uc-name {
  font-family: var(--fh);
  font-size: 0.72rem; font-weight: 700; color: var(--t1);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 90px;
}
.uc-status { font-size:0.56rem; font-weight:600; color:var(--ok); letter-spacing:.06em; text-transform:uppercase }

/* ─── Noise texture overlay ─────────────────────────── */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:9998;
  opacity:0.45;
}

/* ═══════════════════════════════════════════════════════════
   ANIMATIONS
   ═══════════════════════════════════════════════════════════ */
@keyframes fadeUp   { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:none} }
@keyframes fadeIn   { from{opacity:0} to{opacity:1} }
@keyframes scIn     { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
@keyframes shake    { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-9px)} 40%{transform:translateX(9px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
@keyframes popIn    { 0%{transform:scale(.35);opacity:0} 65%{transform:scale(1.06)} 100%{transform:scale(1);opacity:1} }
@keyframes coinRise { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-60px) scale(1.4)} }
@keyframes starPop  { 0%{transform:scale(0)rotate(-20deg);opacity:0} 60%{transform:scale(1.3)rotate(5deg);opacity:1} 100%{transform:scale(1)rotate(0);opacity:1} }
@keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:.5} }
@keyframes spin     { to{transform:rotate(360deg)} }
@keyframes breathe  { 0%,100%{box-shadow:0 0 18px var(--gold-g)} 50%{box-shadow:0 0 36px var(--gold-g),0 0 72px rgba(212,168,67,.08)} }
@keyframes recordPulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.15);opacity:.7} }
@keyframes slideDown{ from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:none} }
@keyframes waveBar  { 0%,100%{transform:scaleY(.3)} 50%{transform:scaleY(1)} }

/* ═══════════════════════════════════════════════════════════
   SCREEN SYSTEM (THE FIX — unified, no ID overrides)
   .scr        = display:none
   .scr.active = display:flex
   ═══════════════════════════════════════════════════════════ */
.scr {
  display: none;
  position: fixed;
  inset: 0;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--ink);
  padding-bottom: calc(var(--nav) + 10px);
}
.scr.active { display:flex; animation:fadeIn .25s ease }
.scr.nonav  { padding-bottom:0 }

/* ═══════════════════════════════════════════════════════════
   BOTTOM NAV
   ═══════════════════════════════════════════════════════════ */
#nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--nav);
  background: rgba(8,8,15,0.96);
  backdrop-filter: blur(24px) saturate(1.6);
  -webkit-backdrop-filter: blur(24px);
  border-top: 1px solid rgba(255,255,255,0.07);
  display: flex;
  align-items: center;
  z-index: 500;
  padding: 0 6px 2px;
}
#nav.off { display:none }

.nb {
  flex: 1;
  height: 56px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  color: var(--t3);
  font-size: 0.58rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  border-radius: var(--r3);
  transition: color .18s, background .18s;
  position: relative;
}
.nb:hover { color: var(--t2) }
.nb.on  { color: var(--gold) }
.nb .ni { font-size: 1.2rem; line-height: 1 }
.nb.on .ni { filter: drop-shadow(0 0 6px var(--gold-g)) }

.nbadge {
  position: absolute;
  top: 6px; right: calc(50% - 20px);
  background: var(--err);
  color: #fff;
  font-size: 0.5rem;
  font-weight: 700;
  min-width: 14px; height: 14px;
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 3px;
  border: 1.5px solid var(--ink);
}
.nbadge.off { display:none }

/* ═══════════════════════════════════════════════════════════
   SHARED COMPONENTS
   ═══════════════════════════════════════════════════════════ */
.hdr {
  position: sticky;
  top: 0;
  z-index: 200;
  padding: 54px 20px 14px;
  background: linear-gradient(180deg,rgba(8,8,15,.99) 0%,rgba(8,8,15,.94) 100%);
  backdrop-filter: blur(20px) saturate(1.4);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.hdr-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.hdr-title {
  font-family: var(--fh);
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -.01em;
}
.hdr-sub {
  font-size: 0.72rem;
  color: var(--t3);
  font-weight: 500;
  margin-top: 2px;
  letter-spacing: .04em;
  text-transform: uppercase;
}

/* HUD pills */
.hud { display:flex; align-items:center; gap:7px }
.pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 13px;
  background: rgba(0,0,0,0.55);
  border: 1.5px solid rgba(255,255,255,0.14);
  border-radius: var(--r6);
  font-family: var(--fh);
  font-size: 0.84rem;
  font-weight: 800;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.pill-gold  { color: var(--gold2); border-color: rgba(212,168,67,.45); text-shadow: 0 0 10px rgba(212,168,67,.5) }
.pill-purp  { color: #c4b5fd;      border-color: rgba(167,139,250,.45); text-shadow: 0 0 10px rgba(167,139,250,.4) }

/* Cards */
.card {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: var(--r4);
}
.card:hover { background: var(--g2); border-color: rgba(255,255,255,0.11) }

/* Gold divider line */
.gdiv {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-g), transparent);
  margin: 0 20px;
}

/* Btn primary */
.btn-primary {
  width: 100%;
  padding: 15px 22px;
  background: linear-gradient(135deg, var(--gold) 0%, #b8892e 100%);
  border-radius: var(--r5);
  color: var(--ink);
  font-family: var(--fh);
  font-size: 0.95rem;
  font-weight: 700;
  letter-spacing: .03em;
  box-shadow: 0 4px 20px rgba(212,168,67,.3);
  transition: all .2s;
  position: relative;
  overflow: hidden;
}
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(212,168,67,.4) }
.btn-primary:active { transform:translateY(0) }

/* Skill tags */
.stag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: var(--r6);
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .1em;
}
.sk-vocabulary { background:rgba(74,124,247,.15);  color:var(--blue2);  border:1px solid rgba(74,124,247,.2) }
.sk-grammar    { background:rgba(45,212,191,.12);  color:var(--ok2);    border:1px solid rgba(45,212,191,.2) }
.sk-reading    { background:rgba(167,139,250,.12); color:var(--purp);   border:1px solid rgba(167,139,250,.2) }
.sk-listening  { background:rgba(251,191,36,.12);  color:var(--amber);  border:1px solid rgba(251,191,36,.2) }
.sk-speaking   { background:rgba(251,113,133,.12); color:var(--rose);   border:1px solid rgba(251,113,133,.2) }
.sk-writing    { background:rgba(212,168,67,.12);  color:var(--gold2);  border:1px solid rgba(212,168,67,.2) }

/* ═══════════════════════════════════════════════════════════
   SPLASH  /  ONBOARDING
   ═══════════════════════════════════════════════════════════ */
#s-splash {
  justify-content: center;
  align-items: center;
  background:
    radial-gradient(ellipse at 20% 15%, rgba(74,124,247,.07) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 85%, rgba(212,168,67,.06) 0%, transparent 55%),
    var(--ink);
}

.onb {
  width: 100%;
  max-width: 440px;
  padding: 40px 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 26px;
  text-align: center;
  animation: fadeUp .55s ease;
}

.onb-logo {
  width: 90px; height: 90px;
  border-radius: 24px;
  background: linear-gradient(145deg, #1e1a2e, #2a2240);
  border: 2px solid rgba(212,168,67,.35);
  display: flex; align-items: center; justify-content: center;
  font-size: 3rem;
  box-shadow: var(--shg);
  animation: breathe 4s ease-in-out infinite;
}

.onb-wordmark {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  margin-top: -8px;
}
.onb-title {
  font-family: var(--fh);
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: -.02em;
  line-height: 1.05;
  color: var(--t1);
}
.onb-title span { color: var(--gold) }
.onb-tagline {
  font-family: var(--fi);
  font-size: 0.88rem;
  font-style: italic;
  color: var(--t2);
  letter-spacing: .05em;
}

.onb-form {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.fg { display:flex; flex-direction:column; gap:8px; text-align:left }
.flbl {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--t3);
  padding-left: 2px;
}

.finp {
  width: 100%;
  padding: 13px 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: var(--r3);
  color: var(--t1);
  font-family: var(--fb);
  font-size: 1rem;
  font-weight: 500;
  outline: none;
  transition: all .2s;
}
.finp::placeholder { color: var(--t3) }
.finp:focus { border-color: var(--gold); background: rgba(212,168,67,.05); box-shadow: 0 0 0 3px var(--gold-g) }
.finp.has-err { border-color: var(--err) }

.lvl-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 9px }

.lv-btn {
  padding: 12px 6px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--r3);
  color: var(--t2);
  font-family: var(--fh);
  font-size: 0.78rem;
  font-weight: 700;
  line-height: 1.5;
  transition: all .2s;
}
.lv-btn:hover { border-color: var(--gold-g); color: var(--gold2) }
.lv-btn.sel {
  background: rgba(212,168,67,.12);
  border-color: var(--gold);
  color: var(--gold);
  box-shadow: 0 0 16px var(--gold-g);
}

.onb-foot {
  font-size: 0.68rem;
  color: var(--t3);
  line-height: 1.7;
  letter-spacing: .02em;
}

/* ═══════════════════════════════════════════════════════════
   MAP SCREEN
   ═══════════════════════════════════════════════════════════ */
.map-body { padding: 14px 16px; display:flex; flex-direction:column; gap:11px }

.world-card {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r4);
  overflow: hidden;
  transition: border-color .2s;
}
.world-card.open { border-color: rgba(255,255,255,.12) }

.world-head {
  display: flex;
  align-items: center;
  gap: 13px;
  padding: 15px 18px;
  cursor: pointer;
  transition: background .18s;
}
.world-head:hover { background: var(--g2) }

.world-gem {
  width: 46px; height: 46px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
  position: relative;
}
.world-gem::after {
  content:'';
  position:absolute;
  inset:0;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
}

.world-info { flex:1; min-width:0 }
.world-name {
  font-family: var(--fh);
  font-size: 1rem;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: -.01em;
}
.world-cefr {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .12em;
  margin-top: 2px;
}
.world-chev { color: var(--t3); transition: transform .28s; flex-shrink:0; font-size: .9rem }
.world-card.open .world-chev { transform:rotate(180deg) }

.world-zones {
  display: none;
  flex-direction: column;
  gap: 7px;
  padding: 0 14px 14px;
}
.world-card.open .world-zones { display:flex }

/* World accent colors */
.w-a1 .world-gem { background:linear-gradient(135deg,#1a2a5e,#0f1a40) }
.w-a1 .world-cefr { color: var(--blue2) }
.w-a1.open { border-color: rgba(74,124,247,.25) }

.w-b1 .world-gem { background:linear-gradient(135deg,#2a1e3e,#1a1228) }
.w-b1 .world-cefr { color: var(--purp) }
.w-b1.open { border-color: rgba(167,139,250,.25) }

.w-c1 .world-gem { background:linear-gradient(135deg,#3a2a00,#201500) }
.w-c1 .world-cefr { color: var(--gold2) }
.w-c1.open { border-color: rgba(212,168,67,.3) }

/* Zone row */
.zone-row {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--r3);
  padding: 11px 13px;
  display: flex;
  align-items: center;
  gap: 11px;
  cursor: pointer;
  transition: all .2s;
}
.zone-row:hover:not(.lck) {
  background: var(--g2);
  border-color: rgba(255,255,255,.12);
  transform: translateX(3px);
}
.zone-row.lck { opacity:.38; cursor:not-allowed; filter:grayscale(.7) }
.zone-row.done { border-color: rgba(45,212,191,.25); background: rgba(45,212,191,.04) }

.zone-ico {
  width: 38px; height: 38px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
  background: var(--g2);
}
.zone-info { flex:1; min-width:0 }
.zone-name { font-size:.88rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.zone-sub  { font-size:.65rem; color:var(--t3); margin-top:2px; text-transform:uppercase; letter-spacing:.07em }
.zone-stars { font-size:.8rem; letter-spacing:2px; flex-shrink:0 }

/* Boss zone highlight */
.zone-row.boss-zone {
  background: linear-gradient(135deg, rgba(212,168,67,.05), rgba(212,168,67,.02));
  border-color: rgba(212,168,67,.2);
}
.zone-row.boss-zone:hover:not(.lck) { border-color: rgba(212,168,67,.4) }

/* ═══════════════════════════════════════════════════════════
   EXERCISE SCREEN
   ═══════════════════════════════════════════════════════════ */
#s-ex {
  background: linear-gradient(180deg, var(--ink2) 0%, var(--ink) 60%);
}

.ex-hdr {
  position: sticky;
  top: 0;
  z-index: 200;
  padding: 14px 16px 12px;
  background: rgba(8,8,15,.96);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255,255,255,.06);
  display: flex;
  align-items: center;
  gap: 12px;
}

.ex-close-btn {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.08);
  color: var(--t2);
  font-size: .9rem;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: all .18s;
}
.ex-close-btn:hover { background: rgba(244,101,122,.15); color: var(--err); border-color:var(--err-g) }

.ex-prog { flex:1 }
.ex-prog-track {
  height: 6px;
  background: rgba(255,255,255,.07);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 4px;
}
.ex-prog-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--ok) 0%, var(--blue) 100%);
  border-radius: 3px;
  transition: width .4s ease;
}
.ex-prog-lbl { font-size:.62rem; font-weight:600; color:var(--t3); letter-spacing:.06em }

.ex-lives { font-size:.95rem; letter-spacing:3px; flex-shrink:0 }

.ex-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding: 22px 18px;
  max-width: 640px;
  width: 100%;
  margin: 0 auto;
}

.ex-q-wrap {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ex-q {
  font-family: var(--fi);
  font-size: 1.3rem;
  font-weight: 400;
  line-height: 1.42;
  color: var(--t1);
}

.ex-con { display:flex; flex-direction:column; gap:9px }
.ex-con.shk { animation: shake .38s ease }

/* ── MC ── */
.mc-opt {
  width: 100%;
  padding: 13px 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  color: var(--t1);
  font-size: .92rem;
  font-weight: 500;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all .2s;
  font-family: var(--fb);
}
.mc-opt:hover:not(:disabled) {
  background: var(--g2);
  border-color: rgba(212,168,67,.3);
  transform: translateX(3px);
}
.mc-opt.cor { background: rgba(45,212,191,.1); border-color: var(--ok); color: var(--ok2) }
.mc-opt.wrg { background: rgba(244,101,122,.1); border-color: var(--err); color: var(--err2) }

.mc-letter {
  width: 26px; height: 26px;
  border-radius: 8px;
  background: rgba(255,255,255,.07);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--fh);
  font-size: .72rem;
  font-weight: 700;
  flex-shrink: 0;
  transition: background .18s;
}
.mc-opt.cor .mc-letter { background: var(--ok); color: var(--ink) }
.mc-opt.wrg .mc-letter { background: var(--err); color: #fff }

/* ── TF ── */
.tf-stmt {
  padding: 14px 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  font-family: var(--fi);
  font-size: 1rem;
  font-style: italic;
  color: var(--t1);
  line-height: 1.6;
}
.tf-wrap { display:grid; grid-template-columns:1fr 1fr; gap:10px }
.tf-btn {
  padding: 20px 10px;
  border-radius: var(--r3);
  font-family: var(--fh);
  font-size: 1.1rem;
  font-weight: 700;
  border: 1px solid rgba(255,255,255,.08);
  color: var(--t1);
  transition: all .2s;
  letter-spacing:.03em;
}
.tf-t { background: rgba(45,212,191,.07) }
.tf-f { background: rgba(244,101,122,.07) }
.tf-btn:hover:not(:disabled) { transform:scale(1.03); border-color:rgba(255,255,255,.15) }
.tf-btn.cor { background:rgba(45,212,191,.2); border-color:var(--ok); color:var(--ok2) }
.tf-btn.wrg { background:rgba(244,101,122,.2); border-color:var(--err); color:var(--err2) }

/* ── FIB ── */
.fib-hint {
  padding: 8px 12px;
  background: rgba(74,124,247,.07);
  border: 1px solid rgba(74,124,247,.18);
  border-radius: var(--r2);
  font-size: .78rem;
  color: var(--blue2);
  font-style: italic;
}
.fib-inp {
  width: 100%;
  padding: 13px 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: var(--r3);
  color: var(--t1);
  font-family: var(--fb);
  font-size: .98rem;
  font-weight: 500;
  outline: none;
  transition: all .2s;
}
.fib-inp::placeholder { color:var(--t3) }
.fib-inp:focus { border-color:var(--gold); background:rgba(212,168,67,.04); box-shadow:0 0 0 3px var(--gold-g) }
.fib-inp.cor { border-color:var(--ok); background:rgba(45,212,191,.07) }
.fib-inp.wrg { border-color:var(--err); background:rgba(244,101,122,.07) }

/* ── DRAG & DROP (FIXED) ── */
.dd-pool {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px;
  background: rgba(255,255,255,.025);
  border: 1px dashed rgba(255,255,255,.12);
  border-radius: var(--r3);
  min-height: 54px;
}

.chip {
  padding: 7px 14px;
  border-radius: var(--r6);
  font-size: .85rem;
  font-weight: 600;
  cursor: grab;
  user-select: none;
  transition: all .18s;
  border: 1px solid transparent;
  font-family: var(--fb);
}
.chip-word {
  background: rgba(74,124,247,.18);
  color: var(--blue2);
  border-color: rgba(74,124,247,.25);
}
.chip-word:hover:not(.used) { background:rgba(74,124,247,.28); transform:scale(1.05) }
.chip-word.used { opacity:.28; cursor:default; transform:none }
.chip-word.dragging { opacity:.3 }

.dd-targets { display:flex; flex-direction:column; gap:9px }
.dd-row { display:flex; align-items:center; gap:10px }
.dd-pfx { font-weight:600; font-size:.88rem; min-width:70px; color:var(--t2); flex-shrink:0 }

.dd-zone {
  flex: 1;
  min-height: 42px;
  border: 1.5px dashed rgba(255,255,255,.12);
  border-radius: var(--r3);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 7px 12px;
  font-size: .83rem;
  color: var(--t3);
  transition: all .2s;
  font-family: var(--fb);
}
.dd-zone.over { border-color: var(--gold); background: rgba(212,168,67,.07) }
.dd-zone.filled { border-color: rgba(45,212,191,.4); background:rgba(45,212,191,.07); color:var(--ok2); font-weight:600; border-style:solid }
.dd-zone.bad  { border-color: var(--err); background:rgba(244,101,122,.07) }

/* ── SENTENCE BUILDER (FIXED) ── */
.sb-zone {
  min-height: 54px;
  border: 1.5px dashed rgba(74,124,247,.4);
  border-radius: var(--r3);
  padding: 10px 13px;
  display: flex;
  flex-wrap: wrap;
  gap: 7px;
  align-items: center;
  background: rgba(74,124,247,.04);
  transition: all .2s;
}
.sb-zone.over { background:rgba(74,124,247,.1); border-style:solid }
.sb-zone em { color:var(--t3); font-size:.82rem; font-style:normal }

.sb-chip-pool { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }

.sb-chip {
  padding: 6px 13px;
  background: rgba(74,124,247,.16);
  border: 1px solid rgba(74,124,247,.25);
  border-radius: var(--r6);
  color: var(--blue2);
  font-size: .85rem;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  transition: all .18s;
  font-family: var(--fb);
}
.sb-chip:hover:not(.used) { background:rgba(74,124,247,.26); transform:translateY(-2px) }
.sb-chip.used { opacity:.22; cursor:default; transform:none }
.sb-chip.in-zone {
  background: rgba(45,212,191,.16);
  border-color: rgba(45,212,191,.35);
  color: var(--ok2);
}
.sb-chip.in-zone:hover { background:rgba(45,212,191,.26) }

/* ── ERROR SPOTTING ── */
.es-text {
  font-family: var(--fi);
  font-size: 1rem;
  line-height: 2;
  padding: 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
}
.word-sp {
  cursor: pointer;
  padding: 1px 2px;
  border-radius: 3px;
  transition: background .15s;
}
.word-sp:hover { background:rgba(212,168,67,.2) }
.word-sp.sel   { background:rgba(244,101,122,.25); color:var(--err2) }
.word-sp.wOK   { background:rgba(45,212,191,.25); color:var(--ok2) }
.word-sp.wBAD  { background:rgba(244,101,122,.15); color:var(--err); text-decoration:line-through }

/* ── LISTENING ── */
.listen-card {
  background: linear-gradient(135deg, rgba(251,191,36,.06), rgba(251,191,36,.02));
  border: 1px solid rgba(251,191,36,.2);
  border-radius: var(--r4);
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  text-align: center;
}

.listen-wave {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  height: 40px;
}
.wave-bar {
  width: 4px;
  background: var(--amber);
  border-radius: 2px;
  animation: waveBar .8s ease-in-out infinite;
}
.wave-bar:nth-child(2) { animation-delay:.1s; height:28px }
.wave-bar:nth-child(3) { animation-delay:.2s; height:36px }
.wave-bar:nth-child(4) { animation-delay:.3s; height:22px }
.wave-bar:nth-child(5) { animation-delay:.4s; height:32px }
.wave-bar:nth-child(1) { height:18px }
.wave-bar:nth-child(6) { animation-delay:.15s; height:26px }
.wave-bar.paused { animation-play-state:paused; transform:scaleY(.3) }

.listen-txt {
  font-family: var(--fi);
  font-size: 1.05rem;
  color: var(--t2);
  font-style: italic;
  display: none;
}
.listen-txt.revealed { display:block }

.btn-listen {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 11px 22px;
  background: rgba(251,191,36,.12);
  border: 1px solid rgba(251,191,36,.3);
  border-radius: var(--r5);
  color: var(--amber);
  font-family: var(--fh);
  font-size: .88rem;
  font-weight: 700;
  transition: all .2s;
  letter-spacing: .03em;
}
.btn-listen:hover { background:rgba(251,191,36,.2); border-color:rgba(251,191,36,.5) }
.btn-listen.playing { animation: pulse 1.2s ease-in-out infinite }

/* ── SPEAKING ── */
.speak-card {
  background: linear-gradient(135deg, rgba(251,113,133,.06), rgba(251,113,133,.02));
  border: 1px solid rgba(251,113,133,.2);
  border-radius: var(--r4);
  padding: 22px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  text-align: center;
}

.speak-prompt {
  font-family: var(--fi);
  font-size: 1.15rem;
  font-style: italic;
  color: var(--t1);
  padding: 14px 18px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  width: 100%;
  text-align: center;
}

.speak-label {
  font-size: .75rem;
  color: var(--t3);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .1em;
}

.btn-mic {
  width: 70px; height: 70px;
  border-radius: 50%;
  background: rgba(251,113,133,.15);
  border: 2px solid rgba(251,113,133,.35);
  color: var(--rose);
  font-size: 1.8rem;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
}
.btn-mic:hover { background:rgba(251,113,133,.25); transform:scale(1.07) }
.btn-mic.recording {
  background: rgba(251,113,133,.3);
  border-color: var(--rose);
  animation: recordPulse 1s ease-in-out infinite;
  box-shadow: 0 0 24px rgba(251,113,133,.3);
}

.speak-status {
  font-size: .8rem;
  color: var(--t3);
  font-weight: 500;
  min-height: 18px;
}
.speak-status.active { color: var(--rose) }

.speak-transcript {
  width: 100%;
  min-height: 36px;
  padding: 10px 14px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--r2);
  font-family: var(--fi);
  font-size: .9rem;
  color: var(--t2);
  font-style: italic;
  text-align: center;
}

.speak-fallback {
  display: none;
  width: 100%;
  flex-direction: column;
  gap: 8px;
}
.speak-fallback.visible { display:flex }

/* ── SHARED exercise buttons ── */
.btn-check {
  width: 100%;
  padding: 13px 20px;
  border-radius: var(--r5);
  background: linear-gradient(135deg, var(--blue) 0%, #3560d4 100%);
  color: #fff;
  font-family: var(--fh);
  font-size: .9rem;
  font-weight: 700;
  letter-spacing: .03em;
  box-shadow: 0 4px 16px var(--blue-g);
  transition: all .2s;
}
.btn-check:hover { transform:translateY(-2px); box-shadow:0 8px 24px var(--blue-g) }
.btn-check.sec {
  background: var(--g1);
  color: var(--t2);
  border: 1px solid rgba(255,255,255,.1);
  box-shadow: none;
}

/* ── Feedback ── */
.ex-fb {
  border-radius: var(--r3);
  padding: 14px 16px;
  display: none;
  flex-direction: column;
  gap: 8px;
  animation: scIn .26s ease;
}
.ex-fb.show { display:flex }
.ex-fb.ok   { background:rgba(45,212,191,.1); border:1px solid rgba(45,212,191,.3) }
.ex-fb.ng   { background:rgba(244,101,122,.1); border:1px solid rgba(244,101,122,.3) }
.fb-top  { display:flex; align-items:center; gap:10px }
.fb-icon { font-size:1.4rem }
.fb-title{ font-family:var(--fh); font-size:.92rem; font-weight:700 }
.fb-body { font-size:.8rem; color:var(--t2); line-height:1.6 }
.fb-rew  { display:flex; gap:8px; flex-wrap:wrap; margin-top:2px }
.rew-tag { display:flex; align-items:center; gap:4px; padding:3px 10px; border-radius:var(--r6); font-size:.75rem; font-weight:700 }
.rw-c  { background:rgba(212,168,67,.15); color:var(--gold); border:1px solid rgba(212,168,67,.25) }
.rw-x  { background:rgba(167,139,250,.15); color:var(--purp); border:1px solid rgba(167,139,250,.25) }
.rw-g  { background:rgba(251,191,36,.15); color:var(--amber); border:1px solid rgba(251,191,36,.25) }

.btn-next {
  width: 100%;
  padding: 14px;
  border-radius: var(--r5);
  font-family: var(--fh);
  font-size: .92rem;
  font-weight: 700;
  color: var(--ink);
  display: none;
  transition: all .2s;
  letter-spacing: .03em;
}
.btn-next.show { display:block; animation:fadeUp .26s ease }
.btn-next.ok { background:linear-gradient(135deg, var(--ok), #18a890); box-shadow:0 4px 16px var(--ok-g) }
.btn-next.ng { background:linear-gradient(135deg, var(--gold), #b8892e); box-shadow:0 4px 16px var(--gold-g); color:var(--ink) }
.btn-next:hover { transform:translateY(-2px) }

/* ═══════════════════════════════════════════════════════════
   EXERCISE COMPLETE
   ═══════════════════════════════════════════════════════════ */
#s-done {
  position: fixed; inset:0; z-index:900;
  display: none;
  align-items: center; justify-content: center;
  background: rgba(4,4,10,.9);
  backdrop-filter: blur(18px);
  padding: 20px;
}
#s-done.show { display:flex; animation:fadeIn .3s ease }

.done-card {
  background: linear-gradient(160deg, var(--ink4), var(--ink3));
  border: 1px solid rgba(212,168,67,.2);
  border-radius: var(--r5);
  padding: 36px 28px;
  max-width: 400px;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 18px;
  text-align: center;
  animation: popIn .42s ease;
  box-shadow: var(--shg), var(--sh3);
}

.done-stars { display:flex; gap:10px; font-size:2.6rem }
.d-star { animation:starPop .4s ease forwards; opacity:0 }
.d-star:nth-child(1){ animation-delay:.1s }
.d-star:nth-child(2){ animation-delay:.3s }
.d-star:nth-child(3){ animation-delay:.5s }

.done-title { font-family:var(--fh); font-size:1.6rem; font-weight:700; letter-spacing:-.01em }
.done-sub   { font-family:var(--fi); font-size:.88rem; color:var(--t2); margin-top:-10px; font-style:italic }

.done-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:9px; width:100% }
.ds-cell {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  padding: 13px 8px;
  display: flex; flex-direction:column; align-items:center; gap:4px;
}
.ds-val { font-family:var(--fh); font-size:1.3rem; font-weight:700 }
.ds-lbl { font-size:.6rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t3) }

/* ═══════════════════════════════════════════════════════════
   GYM SCREEN
   ═══════════════════════════════════════════════════════════ */
.gym-hero {
  padding: 28px 20px 16px;
  text-align: center;
  display: flex; flex-direction:column; align-items:center; gap:10px;
  background: linear-gradient(180deg, rgba(251,191,36,.04) 0%, transparent 100%);
  border-bottom: 1px solid rgba(255,255,255,.04);
}
.gym-ico { font-size:3rem; display:block }
.gym-title { font-family:var(--fh); font-size:1.25rem; font-weight:700; letter-spacing:-.01em }
.gym-desc  { font-size:.84rem; color:var(--t2); line-height:1.65; max-width:290px }

.wk-list  { padding:0 16px 16px; display:flex; flex-direction:column; gap:8px }
.wk-item {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--r3);
  padding: 12px 14px;
  display: flex; align-items:center; gap:11px;
}
.wk-ico { width:34px; height:34px; border-radius:9px; background:rgba(244,101,122,.12); border:1px solid rgba(244,101,122,.2); display:flex; align-items:center; justify-content:center; font-size:.95rem; flex-shrink:0 }
.wk-info { flex:1; min-width:0 }
.wk-q  { font-size:.84rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.wk-id { font-size:.62rem; color:var(--t3); margin-top:2px; text-transform:uppercase; letter-spacing:.06em }

.btn-gym {
  margin: 0 16px 16px;
  width: calc(100% - 32px);
  padding: 15px;
  background: linear-gradient(135deg, var(--amber), #d97706);
  border-radius: var(--r5);
  color: var(--ink);
  font-family: var(--fh);
  font-size: .95rem;
  font-weight: 700;
  letter-spacing: .03em;
  box-shadow: 0 4px 20px rgba(251,191,36,.25);
  transition: all .2s;
}
.btn-gym:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(251,191,36,.35) }

.gym-empty { padding:52px 20px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:14px }
.ge-ico   { font-size:4rem }
.ge-title { font-family:var(--fh); font-size:1.2rem; font-weight:700 }
.ge-desc  { font-size:.84rem; color:var(--t2); line-height:1.65; max-width:270px }

/* ═══════════════════════════════════════════════════════════
   PROFILE SCREEN
   ═══════════════════════════════════════════════════════════ */
.pro-hero {
  padding: 28px 20px 20px;
  display: flex; flex-direction:column; align-items:center; gap:14px;
  text-align: center;
  background: linear-gradient(180deg, rgba(212,168,67,.04) 0%, transparent 100%);
  border-bottom: 1px solid rgba(255,255,255,.04);
}

.av-wrap { position:relative; display:inline-block }
.av-ring {
  width: 88px; height: 88px;
  border-radius: 50%;
  border: 2.5px solid var(--gold);
  box-shadow: 0 0 28px var(--gold-g), inset 0 0 0 3px var(--ink);
  display: flex; align-items:center; justify-content:center;
  font-size: 2.4rem;
  transition: all .3s;
}
.av-lv {
  position: absolute;
  bottom: 0; right: -4px;
  background: var(--gold);
  color: var(--ink);
  font-family: var(--fh);
  font-size: .58rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: var(--r6);
  border: 2px solid var(--ink);
  letter-spacing:.04em;
}
/* Avatar skin backgrounds */
.sk-default  { background:linear-gradient(145deg,#1e1a2e,#12103d) }
.sk-hacker   { background:linear-gradient(145deg,#0a1e0e,#051208) }
.sk-fire     { background:linear-gradient(145deg,#2e0a08,#3e1500) }
.sk-ocean    { background:linear-gradient(145deg,#061828,#04102e) }
.sk-galaxy   { background:linear-gradient(145deg,#110a30,#0a0620) }
.sk-dragon   { background:linear-gradient(145deg,#2e0808,#1a0404) }

.pro-name  { font-family:var(--fh); font-size:1.5rem; font-weight:700; letter-spacing:-.01em }
.pro-title { font-family:var(--fi); font-size:.82rem; color:var(--t2); font-style:italic }

.pro-stats { display:flex; gap:9px; flex-wrap:wrap; justify-content:center }
.pro-stat {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  padding: 10px 14px;
  display: flex; flex-direction:column; align-items:center; gap:2px;
  min-width: 72px;
}
.ps-val { font-family:var(--fh); font-size:1.1rem; font-weight:700 }
.ps-lbl { font-size:.58rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t3) }

.pro-section { margin:0 16px 16px }
.sec-lbl { font-size:.65rem; font-weight:700; text-transform:uppercase; letter-spacing:.14em; color:var(--t3); margin-bottom:12px; padding:0 2px }

.xp-card {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r3);
  padding: 15px;
}
.xp-row { display:flex; justify-content:space-between; font-size:.75rem; font-weight:600; color:var(--t2); margin-bottom:9px }
.xp-track { height:8px; background:rgba(255,255,255,.07); border-radius:4px; overflow:hidden }
.xp-fill  { height:100%; background:linear-gradient(90deg,var(--purp),#c084fc); border-radius:4px; transition:width 1.2s ease }

/* Hexagonal radar — 6 axes */
.radar-wrap { display:flex; justify-content:center; padding:8px 0 4px }
.radar-legend {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 10px;
}
.rl-item { display:flex; align-items:center; gap:7px; font-size:.76rem; font-weight:500 }
.rl-dot  { width:8px; height:8px; border-radius:50%; flex-shrink:0 }
.rl-bar  { flex:1; height:4px; background:rgba(255,255,255,.08); border-radius:2px; overflow:hidden }
.rl-fill { height:100%; border-radius:2px; transition:width 1s ease }
.rl-pct  { font-size:.65rem; color:var(--t3); min-width:28px; text-align:right; font-family:var(--fh) }

/* ═══════════════════════════════════════════════════════════
   SHOP SCREEN
   ═══════════════════════════════════════════════════════════ */
.bal-banner {
  margin: 16px;
  background: linear-gradient(135deg, rgba(212,168,67,.1), rgba(212,168,67,.04));
  border: 1px solid rgba(212,168,67,.25);
  border-radius: var(--r4);
  padding: 16px 18px;
  display: flex; align-items:center; gap:14px;
}
.bb-ico  { font-size:1.8rem }
.bb-lbl  { font-size:.65rem; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t3) }
.bb-val  { font-family:var(--fh); font-size:1.5rem; font-weight:700; color:var(--gold) }

.shop-section-lbl { padding:0 18px 10px; font-size:.65rem; font-weight:700; text-transform:uppercase; letter-spacing:.14em; color:var(--t3) }

.shop-grid { display:grid; grid-template-columns:1fr 1fr; gap:11px; padding:0 16px 16px }

.shop-card {
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r4);
  padding: 18px 12px;
  display: flex; flex-direction:column; align-items:center; gap:9px;
  text-align: center;
  transition: all .22s;
}
.shop-card:hover { border-color:rgba(255,255,255,.14); transform:translateY(-3px); box-shadow:var(--sh2) }
.shop-card.owned  { border-color:rgba(45,212,191,.25); background:rgba(45,212,191,.03) }
.shop-card.equip  { border-color:rgba(212,168,67,.4); background:rgba(212,168,67,.05); box-shadow:var(--shg) }

.sc-av {
  width: 66px; height:66px;
  border-radius: 50%;
  display: flex; align-items:center; justify-content:center;
  font-size: 2rem;
  transition: transform .22s;
  border: 2px solid rgba(255,255,255,.1);
}
.shop-card:hover .sc-av { transform:scale(1.1) }
.sc-name { font-family:var(--fh); font-size:.85rem; font-weight:700 }
.sc-desc { font-size:.66rem; color:var(--t3); line-height:1.5 }
.sc-price { display:flex; align-items:center; gap:4px; font-family:var(--fh); font-size:.85rem; font-weight:700; color:var(--gold) }

.sh-btn {
  width: 100%;
  padding: 8px;
  border-radius: var(--r5);
  font-family: var(--fh);
  font-size: .75rem;
  font-weight: 700;
  transition: all .18s;
  letter-spacing: .04em;
}
.sb-buy    { background:linear-gradient(135deg,var(--gold),#9e6d1a); color:var(--ink) }
.sb-buy:hover { transform:scale(1.04) }
.sb-equip  { background:rgba(74,124,247,.18); color:var(--blue2); border:1px solid rgba(74,124,247,.3) }
.sb-equip:hover { background:var(--blue); color:#fff }
.sb-equipped{ background:rgba(212,168,67,.15); color:var(--gold2); cursor:default; border:1px solid rgba(212,168,67,.25) }
.sb-owned  { background:rgba(45,212,191,.12); color:var(--ok2); cursor:default; border:1px solid rgba(45,212,191,.2) }
.sh-btn:disabled { opacity:.4; cursor:not-allowed }

/* ═══════════════════════════════════════════════════════════
   RANK SCREEN
   ═══════════════════════════════════════════════════════════ */
.podium-area {
  padding: 24px 20px 0;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 10px;
  min-height: 160px;
}
.pod-pos { display:flex; flex-direction:column; align-items:center; gap:5px }
.pod-av { width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.35rem; border:2px solid rgba(255,255,255,.1); background:var(--g2) }
.pod-name { font-size:.66rem; font-weight:700; max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--t2) }
.pod-xp   { font-size:.6rem; color:var(--t3); font-family:var(--fh) }
.pod-blk  { border-radius:4px 4px 0 0; width:64px; display:flex; align-items:center; justify-content:center; font-size:1rem; font-weight:800 }
.pb1 { height:90px; background:linear-gradient(180deg,#d4a843,#8c6e1f) }
.pb2 { height:70px; background:linear-gradient(180deg,#8a9aaa,#4a5a6a) }
.pb3 { height:54px; background:linear-gradient(180deg,#9a6a3a,#5a3a1a) }

.rank-note { padding:10px 18px 2px; text-align:center; font-size:.82rem; color:var(--t2); font-weight:500 }

.rank-tbl {
  margin: 12px 16px;
  background: var(--g1);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--r4);
  overflow: hidden;
}
.rank-hd { display:grid; grid-template-columns:36px 1fr 72px; padding:9px 14px; border-bottom:1px solid rgba(255,255,255,.05); font-size:.62rem; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t3) }
.rank-row { display:grid; grid-template-columns:36px 1fr 72px; padding:11px 14px; border-bottom:1px solid rgba(255,255,255,.03); align-items:center; gap:8px; transition:background .15s }
.rank-row:last-child { border-bottom:none }
.rank-row:hover { background:rgba(255,255,255,.025) }
.rank-row.you { background:rgba(212,168,67,.07); border-left:2px solid var(--gold) }
.rr-pos { font-family:var(--fh); font-size:.85rem; font-weight:700; color:var(--t3); text-align:center }
.rr-pos.g { color:var(--gold) }.rr-pos.s { color:#8a9aaa }.rr-pos.b { color:#9a6a3a }
.rr-player { display:flex; align-items:center; gap:9px; min-width:0 }
.rr-av { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.9rem; flex-shrink:0; background:var(--g2) }
.rr-nm { font-size:.85rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.rr-xp { font-family:var(--fh); font-size:.85rem; font-weight:700; color:var(--purp); text-align:right }

/* ═══════════════════════════════════════════════════════════
   CERTIFICATE MODAL
   ═══════════════════════════════════════════════════════════ */
#s-cert {
  position:fixed; inset:0; z-index:1000;
  display:none; align-items:center; justify-content:center;
  background:rgba(4,4,10,.96);
  backdrop-filter:blur(22px);
  padding:16px;
  overflow-y:auto;
}
#s-cert.show { display:flex; animation:fadeIn .3s ease }
.cert-card {
  background:linear-gradient(160deg,var(--ink4),var(--ink3));
  border:1px solid rgba(212,168,67,.35);
  border-radius:var(--r5);
  padding:28px 22px;
  max-width:480px; width:100%;
  display:flex; flex-direction:column; align-items:center; gap:14px;
  text-align:center;
  box-shadow:0 0 80px rgba(212,168,67,.1),var(--sh3);
  animation:popIn .38s ease;
  margin:auto;
}
.cert-trophy { font-size:3.2rem; animation:bounce 2s ease-in-out infinite }
.cert-title { font-family:var(--fh); font-size:1.4rem; font-weight:700; color:var(--gold) }
.cert-text  { font-size:.82rem; color:var(--t2); line-height:1.65; max-width:340px }
.cert-prev  { width:100%; border-radius:var(--r3); overflow:hidden; border:1px solid rgba(212,168,67,.25); box-shadow:0 4px 24px rgba(0,0,0,.5) }
.btn-cert-dl { width:100%; padding:14px; background:linear-gradient(135deg,var(--gold),#9e6d1a); border-radius:var(--r5); color:var(--ink); font-family:var(--fh); font-size:.9rem; font-weight:800; letter-spacing:.05em; transition:all .2s }
.btn-cert-dl:hover { transform:translateY(-2px); box-shadow:0 8px 24px var(--gold-g) }
.btn-cert-cl { width:100%; padding:11px; border-radius:var(--r5); border:1px solid rgba(255,255,255,.09); color:var(--t2); font-family:var(--fh); font-size:.84rem; font-weight:700; transition:all .18s }
.btn-cert-cl:hover { border-color:var(--gold-g); color:var(--gold) }

@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

/* ═══════════════════════════════════════════════════════════
   TOASTS + COIN FLOAT
   ═══════════════════════════════════════════════════════════ */
#toast-box { position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:2000; display:flex; flex-direction:column; gap:7px; pointer-events:none; width:calc(100% - 36px); max-width:350px }
.toast { padding:10px 15px; border-radius:var(--r3); font-size:.84rem; font-weight:600; display:flex; align-items:center; gap:9px; box-shadow:var(--sh2); animation:slideDown .28s ease; backdrop-filter:blur(12px) }
.t-ok   { background:rgba(45,212,191,.92); color:var(--ink); border:1px solid var(--ok) }
.t-err  { background:rgba(244,101,122,.92); color:#fff;       border:1px solid var(--err) }
.t-inf  { background:rgba(74,124,247,.92);  color:#fff;       border:1px solid var(--blue) }
.t-gold { background:rgba(15,12,25,.96);    color:var(--gold);border:1px solid rgba(212,168,67,.35) }

.coin-fx { position:fixed; font-family:var(--fh); font-size:1.15rem; font-weight:700; color:var(--gold); pointer-events:none; z-index:3000; animation:coinRise .88s ease-out forwards }

/* ═══════════════════════════════════════════════════════════
   MISC
   ═══════════════════════════════════════════════════════════ */
.divider { height:1px; background:rgba(255,255,255,.05); margin:0 16px 16px }

/* Logout */
.btn-logout {
  margin: 0 16px 24px;
  width: calc(100% - 32px);
  padding: 12px;
  border-radius: var(--r5);
  border: 1.5px solid rgba(244,101,122,.3);
  color: var(--err);
  font-family: var(--fh);
  font-size: .84rem;
  font-weight: 700;
  transition: all .2s;
  letter-spacing: .04em;
  background: rgba(244,101,122,.06);
}
.btn-logout:hover { background:rgba(244,101,122,.15); border-color:var(--err); box-shadow:0 0 16px rgba(244,101,122,.15) }
.nav-av-wrap { position:relative; display:inline-block; line-height:1 }
.nav-av-wrap::after {
  content:'';
  position:absolute;
  bottom:-1px; right:-2px;
  width:7px; height:7px;
  background: var(--ok);
  border-radius:50%;
  border:1.5px solid rgba(8,8,15,1);
}
.spinner { width:34px; height:34px; border:3px solid rgba(255,255,255,.07); border-top-color:var(--gold); border-radius:50%; animation:spin .7s linear infinite; margin:40px auto }
</style>
</head>
<body>
<div id="toast-box"></div>

<!-- Fixed user identity chip (shown after login) -->
<div id="user-chip" class="user-chip off">
  <div class="uc-av" id="uc-av">🐂</div>
  <div class="uc-info">
    <div class="uc-name" id="uc-name">Student</div>
    <div class="uc-status">● Online</div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════
     SPLASH
     ════════════════════════════════════════════════════ -->
<section id="s-splash" class="scr nonav active">
  <div class="onb">
    <div class="onb-logo">🐂</div>
    <div class="onb-wordmark">
      <h1 class="onb-title">Bull <span>English</span><br/>Academy</h1>
      <p class="onb-tagline">Mastery through practice · A1 → C2</p>
    </div>
    <div class="onb-form">
      <div class="fg">
        <label class="flbl" for="inp-name">Your Name</label>
        <input class="finp" id="inp-name" type="text" placeholder="Enter your name…" maxlength="30" autocomplete="off"/>
      </div>
      <div class="fg">
        <label class="flbl">Starting Level</label>
        <div class="lvl-grid" id="lvl-grid">
          <button class="lv-btn sel" data-lv="A1">A1<br/>Beginner</button>
          <button class="lv-btn" data-lv="A2">A2<br/>Elementary</button>
          <button class="lv-btn" data-lv="B1">B1<br/>Intermediate</button>
          <button class="lv-btn" data-lv="B2">B2<br/>Upper-Int.</button>
          <button class="lv-btn" data-lv="C1">C1<br/>Advanced</button>
          <button class="lv-btn" data-lv="C2">C2<br/>Mastery</button>
        </div>
      </div>
      <button class="btn-primary" id="btn-start">🚀 Start Learning</button>
    </div>
    <p class="onb-foot">Progress is saved locally in your browser.<br/>Speaking requires Chrome / Edge with microphone permission.</p>
  </div>
</section>

<!-- ════════════════════════════════════════════════════
     NAVIGATION
     ════════════════════════════════════════════════════ -->
<nav id="nav" class="off">
  <button class="nb" data-t="s-map"><span class="ni">🗺️</span><span>Map</span></button>
  <button class="nb" data-t="s-gym"><span class="ni">💪</span><span>Gym</span><span class="nbadge off" id="gbadge">!</span></button>
  <button class="nb" data-t="s-pro" id="nb-pro">
    <span class="ni nav-av-wrap"><span id="nav-av">👤</span></span>
    <span id="nav-nm">Profile</span>
  </button>
  <button class="nb" data-t="s-shop"><span class="ni">🛒</span><span>Shop</span></button>
  <button class="nb" data-t="s-rank"><span class="ni">🏆</span><span>Rank</span></button>
</nav>

<!-- MAP -->
<section id="s-map" class="scr">
  <div class="hdr">
    <div class="hdr-row">
      <div><h2 class="hdr-title">World Map</h2><p class="hdr-sub">Choose your next challenge</p></div>
      <div class="hud">
        <div class="pill pill-gold">🪙 <span id="hc-map">0</span></div>
        <div class="pill pill-purp">⚡ <span id="hx-map">0</span></div>
      </div>
    </div>
  </div>
  <div class="map-body" id="map-body"></div>
</section>

<!-- GYM -->
<section id="s-gym" class="scr">
  <div class="hdr"><div class="hdr-row"><div><h2 class="hdr-title">The Gym</h2><p class="hdr-sub">Train your weaknesses</p></div><div class="hud"><div class="pill pill-gold">🪙 <span id="hc-gym">0</span></div></div></div></div>
  <div id="gym-body"></div>
</section>

<!-- PROFILE -->
<section id="s-pro" class="scr">
  <div class="hdr"><div class="hdr-row"><h2 class="hdr-title">Profile</h2></div></div>
  <div id="pro-body"></div>
</section>

<!-- SHOP -->
<section id="s-shop" class="scr">
  <div class="hdr"><div class="hdr-row"><h2 class="hdr-title">Bull Shop</h2></div></div>
  <div id="shop-body"></div>
</section>

<!-- RANK -->
<section id="s-rank" class="scr">
  <div class="hdr"><div class="hdr-row"><h2 class="hdr-title">Rankings</h2></div></div>
  <div id="rank-body"></div>
</section>

<!-- EXERCISE -->
<section id="s-ex" class="scr nonav">
  <div class="ex-hdr">
    <button class="ex-close-btn" id="ex-close">✕</button>
    <div class="ex-prog">
      <div class="ex-prog-track"><div class="ex-prog-fill" id="ep-fill" style="width:0%"></div></div>
      <div class="ex-prog-lbl" id="ep-lbl">1 / 1</div>
    </div>
    <div class="ex-lives" id="ex-lives">❤️❤️❤️</div>
  </div>
  <div class="ex-body" id="ex-body"></div>
</section>

<!-- DONE OVERLAY -->
<div id="s-done">
  <div class="done-card">
    <div class="done-stars"><span class="d-star" id="ds1">⭐</span><span class="d-star" id="ds2">⭐</span><span class="d-star" id="ds3">⭐</span></div>
    <h2 class="done-title" id="d-title">Complete!</h2>
    <p class="done-sub" id="d-sub">Great work!</p>
    <div class="done-stats">
      <div class="ds-cell"><div class="ds-val" id="d-acc">0%</div><div class="ds-lbl">Accuracy</div></div>
      <div class="ds-cell"><div class="ds-val" id="d-xp" style="color:var(--purp)">+0</div><div class="ds-lbl">XP</div></div>
      <div class="ds-cell"><div class="ds-val" id="d-cn" style="color:var(--gold)">+0</div><div class="ds-lbl">Coins</div></div>
    </div>
    <button class="btn-primary" id="d-cont">Continue →</button>
  </div>
</div>

<!-- CERTIFICATE MODAL -->
<div id="s-cert">
  <div class="cert-card">
    <div class="cert-trophy">🏅</div>
    <h2 class="cert-title">Certificate Earned!</h2>
    <p class="cert-text">You passed the Boss Exam with flying colours. Download your official CEFR certificate.</p>
    <div class="cert-prev"><canvas id="cert-canvas" width="540" height="306"></canvas></div>
    <button class="btn-cert-dl" id="btn-cert-dl">⬇️ Download Certificate</button>
    <button class="btn-cert-cl" id="btn-cert-cl">Close</button>
  </div>
</div>

<script>
"use strict";
/* ═══════════════════════════════════════════════════════════
   SYLLABUS DB  (condensed — structure operacional)
   3 Worlds: A1, B1, C1
   Each: 1 lesson zone + 1 boss zone
   6 exercise types including listening & speaking
   ═══════════════════════════════════════════════════════════ */
const DB = { worlds: [

/* ══════════════════════════════════════════════════
   W1 · A1 · WELCOME CENTER
   ══════════════════════════════════════════════════ */
{ id:"W1", name:"Welcome Center", cefr:"A1", icon:"🏫", zones:[

  { id:"W1Z1", name:"Greetings & Self-Introduction", icon:"👋", type:"lesson", exercises:[
    { id:"E001", type:"mc", skill:"vocabulary",
      q:"What is the correct greeting for 8:00 AM?",
      opts:[{t:"Good evening",c:false},{t:"Good morning",c:true},{t:"Good night",c:false},{t:"Goodbye",c:false}],
      expl:"'Good morning' = sunrise to noon. Good afternoon = noon–6PM. Good evening = after 6PM." },
    { id:"E002", type:"tf", skill:"grammar",
      q:"Is this sentence correct: 'My name are John'?",
      stmt:"My name are John.",
      ans:false,
      expl:"'My name' is singular → IS. Correct: 'My name IS John.' Rule: I→am, He/She/It→is, We/You/They→are." },
    { id:"E003", type:"fib", skill:"vocabulary",
      q:"Complete: 'Nice to ___ you! I'm Maria.'",
      blank:"meet",
      hint:"Used when first encountering someone.",
      expl:"'Nice to meet you!' is the standard greeting on being introduced for the first time." },
    { id:"E004", type:"mc", skill:"grammar",
      q:"Choose the correct sentence:",
      opts:[{t:"I am name Tom.",c:false},{t:"My name is Tom.",c:true},{t:"Name my is Tom.",c:false},{t:"Tom name is my.",c:false}],
      expl:"Structure: My name + is + [Name]. 'My' is a possessive adjective; always first." },
    { id:"E005", type:"sb", skill:"grammar",
      q:"Build a correct self-introduction:",
      words:["Hello","my","name","is","Ana","and","I","am","from","Brazil"],
      correct:"Hello my name is Ana and I am from Brazil",
      expl:"Introduction: Hello + my name is + [Name] + and I am from + [Country]." },
    { id:"E006", type:"dd", skill:"grammar",
      q:"Match each pronoun to the correct form of 'To Be':",
      drag:["am","is","are"],
      tgts:[{pfx:"I →",ok:"am"},{pfx:"She →",ok:"is"},{pfx:"We →",ok:"are"}],
      expl:"I→am | He/She/It→is | You/We/They→are. These never change in the present tense." },
    { id:"E007", type:"listening", skill:"listening",
      q:"Listen and choose what you hear:",
      audio:"Hello! My name is Sarah and I am from Canada.",
      opts:[{t:"Hello! My name is Sara and I am from Canada.",c:false},{t:"Hello! My name is Sarah and I am from Canada.",c:true},{t:"Hello! My name is Sarah and I am from Australia.",c:false},{t:"Hi! My name is Sarah and I am from Canada.",c:false}],
      expl:"'Sarah' (not Sara) and 'Canada'. Listen carefully to proper nouns." },
    { id:"E008", type:"mc", skill:"vocabulary",
      q:"What do you say when someone says 'Thank you'?",
      opts:[{t:"Please.",c:false},{t:"Sorry.",c:false},{t:"You're welcome.",c:true},{t:"Excuse me.",c:false}],
      expl:"'You're welcome' = standard reply to 'Thank you'. Also: 'No problem', 'Of course'." },
    { id:"E009", type:"tf", skill:"vocabulary",
      q:"Is 'Goodbye' used when ARRIVING somewhere?",
      stmt:"Goodbye is used when arriving somewhere.",
      ans:false,
      expl:"'Goodbye' is used when LEAVING. When arriving say 'Hello' or 'Hi'." },
    { id:"E010", type:"fib", skill:"vocabulary",
      q:"Complete: 'Excuse ___, where is the bathroom?'",
      blank:"me",
      hint:"A polite way to get someone's attention.",
      expl:"'Excuse me' is used to politely interrupt or ask for attention." },
    { id:"E011", type:"mc", skill:"grammar",
      q:"Which is correct? 'How ___ you?'",
      opts:[{t:"is",c:false},{t:"are",c:true},{t:"am",c:false},{t:"be",c:false}],
      expl:"'How are you?' — 'you' (singular or plural) always takes 'are'." },
    { id:"E012", type:"sb", skill:"grammar",
      q:"Build the correct question:",
      words:["Where","are","you","from","?"],
      correct:"Where are you from ?",
      expl:"Question structure: Where + are + you + from? Asks about country or city of origin." },
    { id:"E013", type:"dd", skill:"vocabulary",
      q:"Match each farewell to when it is used:",
      drag:["Goodbye","Good night","See you tomorrow"],
      tgts:[{pfx:"Leaving formally →",ok:"Goodbye"},{pfx:"Before sleep →",ok:"Good night"},{pfx:"Parting briefly →",ok:"See you tomorrow"}],
      expl:"Goodbye(formal/permanent) | Good night(before bed) | See you [time](casual, meeting again soon)" },
    { id:"E014", type:"speaking", skill:"speaking",
      q:"Introduce yourself. Say this sentence:",
      prompt:"Hello! My name is [your name]. I am from [your country] and I am learning English.",
      target:"hello name learning english",
      keywords:["hello","name","learning","english"],
      expl:"Complete introduction: greeting + name + origin + activity. Learn this formula!" },
    { id:"E015", type:"listening", skill:"listening",
      q:"Listen and choose the best response:",
      audio:"Hi! How are you today?",
      opts:[{t:"My name is John.",c:false},{t:"I am fine, thank you! And you?",c:true},{t:"Goodbye, see you later.",c:false},{t:"Yes, I am from Spain.",c:false}],
      expl:"Reply to 'How are you?' with your state + reciprocate: 'Fine, thanks! And you?'" }
  ]},

  { id:"W1Z2", name:"Numbers, Colors & Time", icon:"🔢", type:"lesson", exercises:[
    { id:"E016", type:"mc", skill:"vocabulary",
      q:"How do you say the number 15 in English?",
      opts:[{t:"Fifty",c:false},{t:"Five",c:false},{t:"Fifteen",c:true},{t:"Fiveteen",c:false}],
      expl:"15=fifteen. 50=fifty. The '-teen' suffix means +10: 13=thirteen, 14=fourteen..." },
    { id:"E017", type:"fib", skill:"vocabulary",
      q:"What color do you get mixing red and blue?",
      blank:"purple",
      hint:"The color of lavender and violets.",
      expl:"Red + Blue = Purple. Primary: red, blue, yellow. Secondary: green, orange, purple." },
    { id:"E018", type:"dd", skill:"vocabulary",
      q:"Match each number to its written form:",
      drag:["seven","twelve","twenty"],
      tgts:[{pfx:"7 →",ok:"seven"},{pfx:"12 →",ok:"twelve"},{pfx:"20 →",ok:"twenty"}],
      expl:"7=seven | 12=twelve (irregular) | 20=twenty. Multiples of 10 end in '-ty'." },
    { id:"E019", type:"tf", skill:"vocabulary",
      q:"Is the color of grass 'green'?",
      stmt:"The color of grass is green.",
      ans:true,
      expl:"Correct! Grass=green, sky=blue, sun=yellow, blood=red, snow=white." },
    { id:"E020", type:"mc", skill:"vocabulary",
      q:"What time is it if the clock shows 3:00?",
      opts:[{t:"It is thirty o'clock.",c:false},{t:"It is three o'clock.",c:true},{t:"It is clock three.",c:false},{t:"It is the three.",c:false}],
      expl:"'It is [number] o'clock' for exact hours. 'O'clock' comes from 'of the clock'." },
    { id:"E021", type:"sb", skill:"grammar",
      q:"Build a sentence about color:",
      words:["The","sky","is","blue","and","the","sun","is","yellow"],
      correct:"The sky is blue and the sun is yellow",
      expl:"Subject + is + color. Use 'and' to join two color statements." },
    { id:"E022", type:"fib", skill:"vocabulary",
      q:"How many days in one week? Write in words.",
      blank:"seven",
      hint:"Monday to Sunday — count them.",
      expl:"7=seven. The days: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday." },
    { id:"E023", type:"listening", skill:"listening",
      q:"Listen and choose the correct number:",
      audio:"I have thirteen books and four pens on my desk.",
      opts:[{t:"30 books and 14 pens",c:false},{t:"13 books and 14 pens",c:false},{t:"13 books and 4 pens",c:true},{t:"30 books and 4 pens",c:false}],
      expl:"thirteen=13 (not 30). four=4. Key: -teen (13–19) vs -ty (30–90)." },
    { id:"E024", type:"mc", skill:"vocabulary",
      q:"Which day comes AFTER Wednesday?",
      opts:[{t:"Tuesday",c:false},{t:"Thursday",c:true},{t:"Monday",c:false},{t:"Friday",c:false}],
      expl:"Mon, Tue, WED, THU, Fri, Sat, Sun. Wednesday is the midpoint of the working week." },
    { id:"E025", type:"dd", skill:"vocabulary",
      q:"Match each color to something it describes:",
      drag:["red","white","black"],
      tgts:[{pfx:"Stop sign →",ok:"red"},{pfx:"Snow →",ok:"white"},{pfx:"Night sky →",ok:"black"}],
      expl:"Red=danger/stop | White=purity/snow | Black=darkness/night." },
    { id:"E026", type:"tf", skill:"vocabulary",
      q:"Is 'orange' both a color and a fruit in English?",
      stmt:"Orange is both a color and a fruit.",
      ans:true,
      expl:"Correct! The fruit came first (from Sanskrit 'naranga'). The color was named after the fruit." },
    { id:"E027", type:"mc", skill:"vocabulary",
      q:"How do you say '2:30' in English?",
      opts:[{t:"Two and thirty.",c:false},{t:"Half past two.",c:true},{t:"Thirty past two.",c:false},{t:"Two hours thirty.",c:false}],
      expl:"2:30 = 'half past two' (British) or 'two thirty' (American)." },
    { id:"E028", type:"fib", skill:"vocabulary",
      q:"The first month of the year is ___.",
      blank:"January",
      hint:"It comes before February.",
      expl:"January = month 1. From Roman god Janus. J-F-M-A-M-J-J-A-S-O-N-D." },
    { id:"E029", type:"speaking", skill:"speaking",
      q:"Say the sentence about colors:",
      prompt:"The banana is yellow and the apple is red.",
      target:"banana yellow apple red",
      keywords:["banana","yellow","apple","red"],
      expl:"Colors come AFTER the noun + 'is/are': The [noun] is [color]." },
    { id:"E030", type:"listening", skill:"listening",
      q:"Listen and select the correct time:",
      audio:"The class starts at nine thirty in the morning.",
      opts:[{t:"9:00 AM",c:false},{t:"9:30 AM",c:true},{t:"9:13 AM",c:false},{t:"9:30 PM",c:false}],
      expl:"nine thirty = 9:30. 'In the morning' = AM. 'In the afternoon/evening' = PM." }
  ]},

  { id:"W1Z3", name:"Family & Body", icon:"👨‍👩‍👧", type:"lesson", exercises:[
    { id:"E031", type:"mc", skill:"vocabulary",
      q:"What do you call your father's sister?",
      opts:[{t:"Niece",c:false},{t:"Cousin",c:false},{t:"Aunt",c:true},{t:"Grandmother",c:false}],
      expl:"Father's sister = Aunt. Father's brother = Uncle. Uncle/Aunt's child = Cousin." },
    { id:"E032", type:"dd", skill:"vocabulary",
      q:"Match each body part to its location:",
      drag:["knee","elbow","ankle"],
      tgts:[{pfx:"On the leg →",ok:"knee"},{pfx:"On the arm →",ok:"elbow"},{pfx:"On the foot →",ok:"ankle"}],
      expl:"Knee(mid-leg) | Elbow(mid-arm) | Ankle(connects leg to foot). All are joints." },
    { id:"E033", type:"fib", skill:"vocabulary",
      q:"You use your ___ to smell flowers.",
      blank:"nose",
      hint:"In the middle of your face.",
      expl:"Nose=smell | Eyes=sight | Ears=hearing | Tongue=taste | Skin=touch. Five senses." },
    { id:"E034", type:"tf", skill:"vocabulary",
      q:"Is a 'sibling' either a brother or a sister?",
      stmt:"A sibling is either a brother or a sister.",
      ans:true,
      expl:"Correct! 'Sibling' is the gender-neutral term for brother or sister." },
    { id:"E035", type:"mc", skill:"grammar",
      q:"'I ___ two brothers and one sister.' Choose correctly:",
      opts:[{t:"is",c:false},{t:"are",c:false},{t:"have",c:true},{t:"has",c:false}],
      expl:"I + have (not 'has'). 'Has' is used with He/She/It. 'Have' with I/You/We/They." },
    { id:"E036", type:"sb", skill:"grammar",
      q:"Build a sentence describing someone:",
      words:["My","mother","has","brown","eyes","and","black","hair"],
      correct:"My mother has brown eyes and black hair",
      expl:"Describing appearance: [person] + has + [color] + [feature]. 'Has' for third person." },
    { id:"E037", type:"listening", skill:"listening",
      q:"Listen and choose the correct family description:",
      audio:"Tom has one sister and two brothers. His sister is older than him.",
      opts:[{t:"Tom has two sisters and one brother.",c:false},{t:"Tom has one sister and two brothers. She is older.",c:true},{t:"Tom has one sister and two brothers. He is older.",c:false},{t:"Tom has one brother and two sisters.",c:false}],
      expl:"one sister AND two brothers. 'His sister is older' = she (not he) is older." },
    { id:"E038", type:"mc", skill:"vocabulary",
      q:"What do you use to hear sounds?",
      opts:[{t:"Eyes",c:false},{t:"Ears",c:true},{t:"Mouth",c:false},{t:"Hands",c:false}],
      expl:"Ears=hearing | Eyes=sight | Nose=smell | Tongue=taste | Skin=touch." },
    { id:"E039", type:"fib", skill:"vocabulary",
      q:"Your parent's parent is your ___.",
      blank:"grandparent",
      hint:"Either a grandmother or grandfather.",
      expl:"Parent's parent = grandparent. The 'grand' prefix means one generation above." },
    { id:"E040", type:"dd", skill:"vocabulary",
      q:"Match each sense to its organ:",
      drag:["eyes","ears","tongue"],
      tgts:[{pfx:"Sight →",ok:"eyes"},{pfx:"Hearing →",ok:"ears"},{pfx:"Taste →",ok:"tongue"}],
      expl:"Eyes=sight | Ears=hearing | Nose=smell | Tongue=taste | Skin=touch." },
    { id:"E041", type:"tf", skill:"grammar",
      q:"'She has got a brother' means the same as 'She has a brother'.",
      stmt:"She has got a brother means the same as She has a brother.",
      ans:true,
      expl:"Correct! 'Have got' = 'have' in British English. American English prefers 'have/has'." },
    { id:"E042", type:"mc", skill:"vocabulary",
      q:"How many fingers does one hand have?",
      opts:[{t:"Four",c:false},{t:"Six",c:false},{t:"Five",c:true},{t:"Three",c:false}],
      expl:"Five fingers: thumb, index, middle, ring, little (pinky). Total: 10 fingers." },
    { id:"E043", type:"speaking", skill:"speaking",
      q:"Describe your family. Say this:",
      prompt:"I have a mother, a father, and one sibling.",
      target:"mother father sibling",
      keywords:["mother","father","sibling"],
      expl:"'I have' + family members. 'Sibling' = brother or sister." },
    { id:"E044", type:"sb", skill:"grammar",
      q:"Build a question about family:",
      words:["Do","you","have","any","brothers","or","sisters","?"],
      correct:"Do you have any brothers or sisters ?",
      expl:"Questions with 'have': Do + you + have + any + [noun]? 'Any' is used in questions and negatives." },
    { id:"E045", type:"listening", skill:"listening",
      q:"Listen and identify the body part mentioned:",
      audio:"My left arm hurts after playing tennis for two hours.",
      opts:[{t:"Right leg",c:false},{t:"Left arm",c:true},{t:"Left leg",c:false},{t:"Right arm",c:false}],
      expl:"'left arm' — listen for LEFT vs RIGHT and ARM vs LEG." }
  ]},

  { id:"W1Z4", name:"Boss Exam A1", icon:"👑", type:"boss", cefr:"A1", exercises:[
    { id:"E046", type:"mc", skill:"grammar",
      q:"Choose the grammatically correct sentence:",
      opts:[{t:"She are a doctor.",c:false},{t:"He is a doctor.",c:true},{t:"They is a teacher.",c:false},{t:"I are happy.",c:false}],
      expl:"He/She/It → IS. I → AM. You/We/They → ARE. The most fundamental rule in English." },
    { id:"E047", type:"fib", skill:"vocabulary",
      q:"The color of the sky on a sunny day is ___.",
      blank:"blue",
      hint:"Also the color of the ocean.",
      expl:"Sky = blue. 'Out of the blue' = unexpectedly. Colors are among the first vocabulary you need." },
    { id:"E048", type:"sb", skill:"grammar",
      q:"Build a complete greeting and introduction:",
      words:["Good","morning","my","name","is","Leo","nice","to","meet","you"],
      correct:"Good morning my name is Leo nice to meet you",
      expl:"Greeting + name + social formula. This sequence is used millions of times every day." },
    { id:"E049", type:"dd", skill:"vocabulary",
      q:"Match each family word to its meaning:",
      drag:["nephew","niece","sibling"],
      tgts:[{pfx:"Brother's son →",ok:"nephew"},{pfx:"Sister's daughter →",ok:"niece"},{pfx:"Brother or sister →",ok:"sibling"}],
      expl:"nephew=brother's/sister's son | niece=brother's/sister's daughter | sibling=brother or sister" },
    { id:"E050", type:"tf", skill:"grammar",
      q:"'Have you a pen?' is the most common modern English form.",
      stmt:"Have you a pen? is the most common modern form.",
      ans:false,
      expl:"Modern: 'Do you have a pen?' or 'Have you GOT a pen?' (British). 'Have you a pen?' is archaic." },
    { id:"E051", type:"listening", skill:"listening",
      q:"Listen and count the items:",
      audio:"I have three cats, two dogs, and one fish at home.",
      opts:[{t:"2 cats, 3 dogs, 1 fish",c:false},{t:"3 cats, 2 dogs, 1 fish",c:true},{t:"3 cats, 1 dog, 2 fish",c:false},{t:"3 cats, 2 dogs, 2 fish",c:false}],
      expl:"three(3) cats + two(2) dogs + one(1) fish. Count carefully in order." },
    { id:"E052", type:"mc", skill:"vocabulary",
      q:"Which month comes BEFORE July?",
      opts:[{t:"August",c:false},{t:"May",c:false},{t:"June",c:true},{t:"April",c:false}],
      expl:"Jan Feb Mar Apr May JUN JUL Aug Sep Oct Nov Dec. June=month 6, July=month 7." },
    { id:"E053", type:"fib", skill:"grammar",
      q:"'She ___ from Italy.' Complete with the correct verb.",
      blank:"is",
      hint:"Third person singular of 'to be'.",
      expl:"She + IS. To be: I am / She is / We are. Describes origin, identity, location." },
    { id:"E054", type:"speaking", skill:"speaking",
      q:"Say this sentence about your daily schedule:",
      prompt:"I wake up at seven o'clock every morning.",
      target:"wake seven morning",
      keywords:["wake","seven","morning"],
      expl:"Simple Present for routines: I + base verb (wake up). Time: at + time, every + period." },
    { id:"E055", type:"es", skill:"grammar",
      q:"Click the WRONG word in this sentence:",
      text:"My sister have two children and they is very happy.",
      err:"have",
      fix:"has",
      expl:"'My sister' = third person singular → needs 'HAS'. Also 'they is' → 'they ARE'. First error: have." }
  ]}
]},

/* ══════════════════════════════════════════════════
   W2 · A2 · DAILY LIFE DISTRICT
   ══════════════════════════════════════════════════ */
{ id:"W2", name:"Daily Life District", cefr:"A2", icon:"🏙️", zones:[

  { id:"W2Z1", name:"Daily Routines & Habits", icon:"⏰", type:"lesson", exercises:[
    { id:"E056", type:"mc", skill:"grammar",
      q:"Which sentence uses Simple Present correctly for a routine?",
      opts:[{t:"She is walk to work every day.",c:false},{t:"He walks to work every day.",c:true},{t:"They walk to work yesterday.",c:false},{t:"I walking to work every day.",c:false}],
      expl:"Simple Present for routines: Subject + verb(+s for he/she/it). 'Every day' signals a routine." },
    { id:"E057", type:"fib", skill:"vocabulary",
      q:"I always ___ my teeth before going to bed.",
      blank:"brush",
      hint:"You use a toothbrush and toothpaste.",
      expl:"'Brush your teeth' = the standard collocation. Do twice daily." },
    { id:"E058", type:"dd", skill:"vocabulary",
      q:"Match each meal to the right time of day:",
      drag:["have breakfast","have lunch","have dinner"],
      tgts:[{pfx:"Morning →",ok:"have breakfast"},{pfx:"Midday →",ok:"have lunch"},{pfx:"Evening →",ok:"have dinner"}],
      expl:"breakfast(morning) | lunch(midday) | dinner(evening). 'Supper' = late dinner in some regions." },
    { id:"E059", type:"tf", skill:"grammar",
      q:"'Do she work here?' is grammatically correct.",
      stmt:"Do she work here? is grammatically correct.",
      ans:false,
      expl:"Third person singular needs DOES: 'Does she work here?' With DOES, verb stays base form." },
    { id:"E060", type:"mc", skill:"vocabulary",
      q:"What do we call the morning meal?",
      opts:[{t:"Supper",c:false},{t:"Brunch",c:false},{t:"Breakfast",c:true},{t:"Snack",c:false}],
      expl:"Breakfast = morning meal. Literally 'breaking the fast' after sleeping." },
    { id:"E061", type:"sb", skill:"grammar",
      q:"Build a morning routine sentence:",
      words:["She","wakes","up","at","six","thirty","every","morning"],
      correct:"She wakes up at six thirty every morning",
      expl:"Routine: Subject + verb(+s) + time. 'Wake up' is a phrasal verb. Add -s for she/he/it." },
    { id:"E062", type:"listening", skill:"listening",
      q:"Listen and choose the correct routine:",
      audio:"Pedro gets up at seven, has a quick shower, and reads the news for thirty minutes before work.",
      opts:[{t:"Pedro showers, reads news, then gets up.",c:false},{t:"Pedro gets up at 7, showers, then reads news 30 min.",c:true},{t:"Pedro gets up at 8, showers, and watches TV.",c:false},{t:"Pedro goes straight to work at 7.",c:false}],
      expl:"Sequence: get up(7am) → shower → read news(30 min) → work." },
    { id:"E063", type:"mc", skill:"grammar",
      q:"'He doesn't ___ coffee.' Choose the correct verb form:",
      opts:[{t:"drinks",c:false},{t:"drink",c:true},{t:"drinking",c:false},{t:"drank",c:false}],
      expl:"After DOESN'T, always use the BASE form: doesn't drink (NOT drinks). The -s is in 'doesn't'." },
    { id:"E064", type:"fib", skill:"vocabulary",
      q:"I ___ the bus to school every morning.",
      blank:"take",
      hint:"You 'take' or 'catch' public transport.",
      expl:"'Take the bus/train/subway' is the standard collocation. 'Catch the bus' = hurry to board it." },
    { id:"E065", type:"dd", skill:"grammar",
      q:"Match the frequency adverb to its meaning:",
      drag:["always","sometimes","never"],
      tgts:[{pfx:"100% →",ok:"always"},{pfx:"50% →",ok:"sometimes"},{pfx:"0% →",ok:"never"}],
      expl:"always(100%) > usually(80%) > often(60%) > sometimes(50%) > rarely(20%) > never(0%)." },
    { id:"E066", type:"tf", skill:"grammar",
      q:"Frequency adverbs go AFTER the verb 'to be': 'She is always late.'",
      stmt:"She is always late — adverb after 'to be' is correct.",
      ans:true,
      expl:"With 'to be': Subject + BE + adverb. With other verbs: Subject + adverb + verb." },
    { id:"E067", type:"mc", skill:"vocabulary",
      q:"What is the opposite of 'early'?",
      opts:[{t:"Fast",c:false},{t:"Late",c:true},{t:"Slow",c:false},{t:"Soon",c:false}],
      expl:"Early↔Late (timing). Fast↔Slow (speed). Don't confuse them." },
    { id:"E068", type:"speaking", skill:"speaking",
      q:"Describe your morning routine. Say this:",
      prompt:"Every morning I wake up, have breakfast, and go to work.",
      target:"morning wake breakfast work",
      keywords:["morning","wake","breakfast","work"],
      expl:"Use Simple Present for routines. Sequence words: first, then, after that, finally." },
    { id:"E069", type:"sb", skill:"grammar",
      q:"Build a negative sentence about habits:",
      words:["I","don't","usually","watch","television","before","dinner"],
      correct:"I don't usually watch television before dinner",
      expl:"Negative: Subject + don't/doesn't + frequency adverb + base verb." },
    { id:"E070", type:"listening", skill:"listening",
      q:"Listen and select what the person does NOT do:",
      audio:"I always exercise in the morning, but I never watch TV before breakfast. I sometimes read in the evening.",
      opts:[{t:"Exercise",c:false},{t:"Watch TV before breakfast",c:true},{t:"Read a book",c:false},{t:"Morning exercise",c:false}],
      expl:"The person says 'NEVER watch TV before breakfast' → they do NOT do this." }
  ]},

  { id:"W2Z2", name:"Food, Shopping & Money", icon:"🛒", type:"lesson", exercises:[
    { id:"E071", type:"mc", skill:"vocabulary",
      q:"Which food group do pasta, rice, and bread belong to?",
      opts:[{t:"Dairy",c:false},{t:"Proteins",c:false},{t:"Carbohydrates",c:true},{t:"Vegetables",c:false}],
      expl:"Pasta, rice, bread = carbohydrates (carbs). They give us energy." },
    { id:"E072", type:"fib", skill:"vocabulary",
      q:"'How ___ is this?' — asking about the price.",
      blank:"much",
      hint:"Used for uncountable nouns and prices.",
      expl:"'How much is this?' for prices. 'How many?' for countable items." },
    { id:"E073", type:"dd", skill:"vocabulary",
      q:"Match each item to the correct shop:",
      drag:["bakery","pharmacy","bookshop"],
      tgts:[{pfx:"Bread & cakes →",ok:"bakery"},{pfx:"Medicine →",ok:"pharmacy"},{pfx:"Novels & textbooks →",ok:"bookshop"}],
      expl:"bakery(bread) | pharmacy/chemist(medicine) | bookshop(books)." },
    { id:"E074", type:"tf", skill:"grammar",
      q:"'Some' is used in positive sentences and 'any' in questions and negatives.",
      stmt:"Some = positive; any = questions and negatives.",
      ans:true,
      expl:"Correct! 'I have SOME apples.' 'Do you have ANY apples?' Exception: offers use 'some'." },
    { id:"E075", type:"mc", skill:"vocabulary",
      q:"What does 'It's on sale' mean?",
      opts:[{t:"The item is sold out.",c:false},{t:"The item is at a reduced price.",c:true},{t:"The item is very expensive.",c:false},{t:"The item is only online.",c:false}],
      expl:"'On sale' = discounted. Don't confuse with 'for sale' = available to buy." },
    { id:"E076", type:"sb", skill:"grammar",
      q:"Build a polite shopping request:",
      words:["Could","I","have","two","kilos","of","apples","please","?"],
      correct:"Could I have two kilos of apples please ?",
      expl:"Polite request: Could I have + [quantity] + of + [item] + please? 'Could' is more polite than 'Can'." },
    { id:"E077", type:"listening", skill:"listening",
      q:"Listen and choose the total price:",
      audio:"That will be five pounds and fifty pence, please.",
      opts:[{t:"£5.15",c:false},{t:"£5.50",c:true},{t:"£15.50",c:false},{t:"£5.05",c:false}],
      expl:"'five pounds and fifty pence' = £5.50. 100 pence = 1 pound." },
    { id:"E078", type:"mc", skill:"grammar",
      q:"'There ___ some milk in the fridge.' Choose correctly:",
      opts:[{t:"are",c:false},{t:"is",c:true},{t:"have",c:false},{t:"be",c:false}],
      expl:"'There IS' + uncountable noun (milk, water, rice). 'There ARE' + countable plural." },
    { id:"E079", type:"fib", skill:"vocabulary",
      q:"The opposite of 'cheap' is ___.",
      blank:"expensive",
      hint:"Something that costs a lot of money.",
      expl:"Cheap↔Expensive. Also: affordable(cheap) vs costly, pricey(expensive)." },
    { id:"E080", type:"dd", skill:"vocabulary",
      q:"Match each food to its taste:",
      drag:["sweet","sour","salty"],
      tgts:[{pfx:"Sugar →",ok:"sweet"},{pfx:"Lemon →",ok:"sour"},{pfx:"Chips →",ok:"salty"}],
      expl:"Five tastes: sweet | sour | salty | bitter(coffee) | umami(meat)." },
    { id:"E081", type:"tf", skill:"grammar",
      q:"'How many money do you have?' is grammatically correct.",
      stmt:"How many money do you have? is correct.",
      ans:false,
      expl:"'Money' is uncountable → 'How MUCH money?' Use 'many' with countable nouns." },
    { id:"E082", type:"mc", skill:"vocabulary",
      q:"What is a 'receipt'?",
      opts:[{t:"A list of ingredients.",c:false},{t:"A document proving you paid for something.",c:true},{t:"A discount voucher.",c:false},{t:"A price tag.",c:false}],
      expl:"Receipt = proof of payment. Note: 'recipe' = cooking instructions. The 'p' is silent." },
    { id:"E083", type:"speaking", skill:"speaking",
      q:"You're in a shop. Say this:",
      prompt:"Excuse me, how much is this jacket? I'd like to try it on.",
      target:"much jacket try",
      keywords:["much","jacket","try"],
      expl:"In a shop: 'How much is this?' + 'Could I try it on?' 'Try on' = put on to test fit." },
    { id:"E084", type:"sb", skill:"grammar",
      q:"Build a sentence using 'there are':",
      words:["There","are","twelve","eggs","in","the","fridge"],
      correct:"There are twelve eggs in the fridge",
      expl:"'There are' + countable plural. Location at the end: in the fridge, on the table." },
    { id:"E085", type:"listening", skill:"listening",
      q:"Listen and identify what the customer is looking for:",
      audio:"Excuse me, do you have this dress in a size medium? I prefer it in blue, not red.",
      opts:[{t:"A blue jacket in size large.",c:false},{t:"A blue dress in size medium.",c:true},{t:"A red dress in size small.",c:false},{t:"A blue skirt in size medium.",c:false}],
      expl:"'dress'(not jacket/skirt) + 'size medium' + 'blue, not red' — three details to catch." }
  ]},

  { id:"W2Z3", name:"Places & Directions", icon:"🗺️", type:"lesson", exercises:[
    { id:"E086", type:"mc", skill:"vocabulary",
      q:"Where do you go to borrow books for free?",
      opts:[{t:"Museum",c:false},{t:"Library",c:true},{t:"Theatre",c:false},{t:"Gallery",c:false}],
      expl:"Library = borrow books for free. Bookshop = BUY books." },
    { id:"E087", type:"dd", skill:"vocabulary",
      q:"Match each direction to its meaning:",
      drag:["turn left","go straight","turn right"],
      tgts:[{pfx:"← →",ok:"turn left"},{pfx:"↑ →",ok:"go straight"},{pfx:"→ →",ok:"turn right"}],
      expl:"turn left(←) | go straight(↑) | turn right(→)." },
    { id:"E088", type:"fib", skill:"vocabulary",
      q:"'The supermarket is ___ the bank and the post office.'",
      blank:"between",
      hint:"In the middle of two specific things.",
      expl:"'Between' = in the middle of two things. 'Among' = in the middle of many." },
    { id:"E089", type:"tf", skill:"grammar",
      q:"'Next to' and 'beside' mean the same thing.",
      stmt:"Next to and beside have the same meaning.",
      ans:true,
      expl:"Correct! Both mean 'at the side of'." },
    { id:"E090", type:"mc", skill:"vocabulary",
      q:"What is the OPPOSITE of 'arrive'?",
      opts:[{t:"Travel",c:false},{t:"Leave / Depart",c:true},{t:"Stay",c:false},{t:"Go",c:false}],
      expl:"Arrive↔Depart/Leave. 'The train arrives at 9.' 'The train departs at 9.'" },
    { id:"E091", type:"sb", skill:"grammar",
      q:"Build directions:",
      words:["Go","straight","on","and","then","turn","left","at","the","traffic","lights"],
      correct:"Go straight on and then turn left at the traffic lights",
      expl:"Direction imperatives: Go + direction. 'At the traffic lights' = reference point." },
    { id:"E092", type:"listening", skill:"listening",
      q:"Listen to the directions and choose the destination:",
      audio:"Take the first left, go straight for two blocks, and the museum is on your right, next to the park.",
      opts:[{t:"Museum is on the left, opposite the park.",c:false},{t:"Museum is on the right, next to the park.",c:true},{t:"Museum is straight ahead, behind the park.",c:false},{t:"Museum is on the left, next to the park.",c:false}],
      expl:"'on your right'(not left) + 'next to the park'(not opposite)." },
    { id:"E093", type:"mc", skill:"grammar",
      q:"'Is there a bank ___ here?' Which preposition?",
      opts:[{t:"from",c:false},{t:"at",c:false},{t:"near",c:true},{t:"on",c:false}],
      expl:"'Near here' = close to this location. Very common when exploring a new place." },
    { id:"E094", type:"fib", skill:"vocabulary",
      q:"The plane lands at the ___.",
      blank:"airport",
      hint:"Where planes arrive and depart.",
      expl:"Airport(planes) | port(ships) | train station(trains) | bus station(buses)." },
    { id:"E095", type:"dd", skill:"vocabulary",
      q:"Match each place to what you do there:",
      drag:["hospital","gym","cinema"],
      tgts:[{pfx:"Watch films →",ok:"cinema"},{pfx:"Exercise →",ok:"gym"},{pfx:"See a doctor →",ok:"hospital"}],
      expl:"cinema(films) | gym(exercise) | hospital(medical treatment)." },
    { id:"E096", type:"tf", skill:"grammar",
      q:"'How long does it take?' is asking about distance.",
      stmt:"How long does it take? asks about distance.",
      ans:false,
      expl:"'How long does it take?' asks about TIME. Distance: 'How far is it?'" },
    { id:"E097", type:"mc", skill:"vocabulary",
      q:"What does 'round the corner' mean?",
      opts:[{t:"Very far away.",c:false},{t:"Very close, just past a bend.",c:true},{t:"In a circular building.",c:false},{t:"In the city centre.",c:false}],
      expl:"'Round/around the corner' = very close, just past a turn." },
    { id:"E098", type:"speaking", skill:"speaking",
      q:"Give directions. Say this:",
      prompt:"Go straight on, take the second left, and the hotel is opposite the park.",
      target:"straight left hotel opposite",
      keywords:["straight","left","hotel","opposite"],
      expl:"Good directions: verb + direction + landmark + preposition + reference point." },
    { id:"E099", type:"sb", skill:"grammar",
      q:"Build a polite question asking for location:",
      words:["Excuse","me","could","you","tell","me","where","the","station","is","?"],
      correct:"Excuse me could you tell me where the station is ?",
      expl:"Indirect question: Could you tell me + WHERE + subject + verb (statement order)." },
    { id:"E100", type:"listening", skill:"listening",
      q:"Listen and choose how long the journey takes:",
      audio:"The town centre is about a twenty-minute walk, but by bus it only takes five minutes.",
      opts:[{t:"5 min walk, 20 min by bus",c:false},{t:"20 min walk, 5 min by bus",c:true},{t:"15 min walk, 10 min by bus",c:false},{t:"20 min walk, 20 min by bus",c:false}],
      expl:"walking=20min. bus='only five minutes'. 'Only' signals the faster option." }
  ]},

  { id:"W2Z4", name:"Boss Exam A2", icon:"👑", type:"boss", cefr:"A2", exercises:[
    { id:"E101", type:"mc", skill:"grammar",
      q:"Choose the correct question form for third person:",
      opts:[{t:"Where does she lives?",c:false},{t:"Where does she live?",c:true},{t:"Where she does live?",c:false},{t:"Where is she live?",c:false}],
      expl:"DOES questions: Does + subject + BASE verb (no -s). The -s is in DOES." },
    { id:"E102", type:"fib", skill:"grammar",
      q:"She ___ usually walk to school. She takes the bus. (negative)",
      blank:"doesn't",
      hint:"Negative of 'does' for she/he/it.",
      expl:"Doesn't = does not. Third person negative: doesn't + base verb." },
    { id:"E103", type:"sb", skill:"grammar",
      q:"Build a sentence about frequency:",
      words:["My","father","always","reads","the","newspaper","after","dinner"],
      correct:"My father always reads the newspaper after dinner",
      expl:"Frequency adverb position: Subject + frequency adverb + verb." },
    { id:"E104", type:"listening", skill:"listening",
      q:"Listen and choose the correct information:",
      audio:"The supermarket opens at eight in the morning and closes at nine in the evening, Monday to Saturday. It is closed on Sundays.",
      opts:[{t:"Open 8am-9pm Mon-Sun",c:false},{t:"Open 8am-9pm Mon-Sat, closed Sun",c:true},{t:"Open 9am-8pm Mon-Sat",c:false},{t:"Open 8am-9am Mon-Sat",c:false}],
      expl:"Open: 8am to 9pm. Mon–Sat. Closed: Sunday. Four details to listen for." },
    { id:"E105", type:"mc", skill:"vocabulary",
      q:"What do you say when entering a shop and no one has greeted you?",
      opts:[{t:"Thank you, goodbye.",c:false},{t:"Excuse me, is anyone there?",c:true},{t:"Give me what I want.",c:false},{t:"You're welcome.",c:false}],
      expl:"'Excuse me' gets attention politely in any situation." },
    { id:"E106", type:"dd", skill:"grammar",
      q:"Put the words in the correct order:",
      drag:["usually go","never eat","sometimes take"],
      tgts:[{pfx:"I ___ to the park.",ok:"usually go"},{pfx:"She ___ meat.",ok:"never eat"},{pfx:"We ___ a taxi.",ok:"sometimes take"}],
      expl:"Frequency adverb + base verb. Third person: she never EATS (-s added)." },
    { id:"E107", type:"tf", skill:"grammar",
      q:"'How many' is used with uncountable nouns like water and rice.",
      stmt:"How many is used with water and rice.",
      ans:false,
      expl:"'How MUCH' for uncountable (water, rice, money). 'How MANY' for countable (bottles, coins)." },
    { id:"E108", type:"fib", skill:"vocabulary",
      q:"'It is ___ the corner, you can't miss it!'",
      blank:"around",
      hint:"A common expression meaning very nearby.",
      expl:"'Around/round the corner' = very close." },
    { id:"E109", type:"speaking", skill:"speaking",
      q:"Describe where you live. Say this:",
      prompt:"I live in a flat near the city centre. There is a park opposite my building.",
      target:"live city park opposite",
      keywords:["live","city","park","opposite"],
      expl:"Location vocabulary: in a flat/house | near/close to | opposite/next to | city centre." },
    { id:"E110", type:"es", skill:"grammar",
      q:"Find the grammatical error:",
      text:"She don't have any money so she can't go shopping today.",
      err:"don't",
      fix:"doesn't",
      expl:"'She' = third person singular → DOESN'T. Don't=I/you/we/they. Doesn't=he/she/it." }
  ]}
]},
/* ══════════════════════════════════════════════════
   W3 · B1 · CONVERSATION HUB
   ══════════════════════════════════════════════════ */
{ id:"W3", name:"Conversation Hub", cefr:"B1", icon:"💬", zones:[

  { id:"W3Z1", name:"Past Tenses & Experiences", icon:"🕰️", type:"lesson", exercises:[
    { id:"E111", type:"mc", skill:"grammar",
      q:"Which tense is used for a completed action at a specific past time?",
      opts:[{t:"Present Perfect",c:false},{t:"Simple Past",c:true},{t:"Past Continuous",c:false},{t:"Present Simple",c:false}],
      expl:"Simple Past = completed action at specific time (yesterday, in 2020, last year)." },
    { id:"E112", type:"fib", skill:"grammar",
      q:"She ___ to Paris last summer. (past of 'go')",
      blank:"went",
      hint:"Irregular past tense of 'go'.",
      expl:"go→went (irregular). Also: see→saw, eat→ate, come→came, take→took." },
    { id:"E113", type:"dd", skill:"grammar",
      q:"Match each verb to its Simple Past form:",
      drag:["ate","drove","wrote"],
      tgts:[{pfx:"eat →",ok:"ate"},{pfx:"drive →",ok:"drove"},{pfx:"write →",ok:"wrote"}],
      expl:"Irregular verbs: eat→ate | drive→drove | write→wrote. No -ed rule applies." },
    { id:"E114", type:"tf", skill:"grammar",
      q:"'Have you ever been to Japan?' uses the Present Perfect tense.",
      stmt:"Have you ever been to Japan? uses Present Perfect.",
      ans:true,
      expl:"'Have + past participle' = Present Perfect. 'Ever' is typical for life experiences." },
    { id:"E115", type:"sb", skill:"grammar",
      q:"Build a negative Simple Past sentence:",
      words:["I","didn't","watch","the","film","last","night"],
      correct:"I didn't watch the film last night",
      expl:"Negative Simple Past: Subject + didn't + BASE verb. 'Didn't' carries the past." },
    { id:"E116", type:"mc", skill:"grammar",
      q:"'While I ___ studying, the phone rang.'",
      opts:[{t:"am",c:false},{t:"was",c:true},{t:"were",c:false},{t:"did",c:false}],
      expl:"Past Continuous for background action: was/were + -ing. I/he/she→was. We/you/they→were." },
    { id:"E117", type:"listening", skill:"listening",
      q:"Listen and choose what happened FIRST:",
      audio:"When we arrived at the station, the train had already left.",
      opts:[{t:"We arrived, then the train left.",c:false},{t:"The train left, then we arrived.",c:true},{t:"We arrived and the train was still there.",c:false},{t:"We left before the train arrived.",c:false}],
      expl:"'Had already left' = Past Perfect → happened BEFORE 'arrived'. Past Perfect = the earlier action." },
    { id:"E118", type:"mc", skill:"grammar",
      q:"'I have lived here ___ ten years.' Which preposition?",
      opts:[{t:"since",c:false},{t:"for",c:true},{t:"ago",c:false},{t:"during",c:false}],
      expl:"FOR + duration: for ten years. SINCE + starting point: since 2014. AGO = back from now." },
    { id:"E119", type:"fib", skill:"grammar",
      q:"She has ___ the report. She's very pleased. (very recent)",
      blank:"just finished",
      hint:"Use Present Perfect + 'just' for a very recent action.",
      expl:"'Just' with Present Perfect = very recently completed. Common in British English." },
    { id:"E120", type:"es", skill:"grammar",
      q:"Click the word with the error:",
      text:"She has went to the supermarket twice this week.",
      err:"went",
      fix:"gone",
      expl:"Present Perfect needs PAST PARTICIPLE. go→went(Simple Past)→GONE(Past Participle)." },
    { id:"E121", type:"dd", skill:"grammar",
      q:"Match each sentence to its tense:",
      drag:["Simple Past","Present Perfect","Past Continuous"],
      tgts:[{pfx:"I was reading when...",ok:"Past Continuous"},{pfx:"I visited Rome last year.",ok:"Simple Past"},{pfx:"I have never tried sushi.",ok:"Present Perfect"}],
      expl:"Simple Past: completed, specific time | Present Perfect: experience | Past Continuous: ongoing past action" },
    { id:"E122", type:"tf", skill:"grammar",
      q:"'Since' is used with a specific point in time.",
      stmt:"Since is used with a specific point in time.",
      ans:true,
      expl:"Correct! SINCE = point in time (2020, Monday). FOR = period of time (three years, a week)." },
    { id:"E123", type:"mc", skill:"vocabulary",
      q:"'I've been meaning to call you' suggests:",
      opts:[{t:"I called but you didn't answer.",c:false},{t:"I intended to call but haven't yet.",c:true},{t:"I am calling you right now.",c:false},{t:"I forgot your number.",c:false}],
      expl:"'Been meaning to' = intended to do something for a while but haven't done it yet." },
    { id:"E124", type:"speaking", skill:"speaking",
      q:"Talk about a past experience. Say this:",
      prompt:"I went to London last summer. It was amazing and I visited many museums.",
      target:"went london summer visited museums",
      keywords:["went","london","visited"],
      expl:"Simple Past for specific past events. Irregular: go→went." },
    { id:"E125", type:"listening", skill:"listening",
      q:"Listen and choose the correct tenses used:",
      audio:"I've just been to the doctor. She told me I need to rest for a week.",
      opts:[{t:"Only Simple Past",c:false},{t:"Present Perfect and Simple Past",c:true},{t:"Only Present Perfect",c:false},{t:"Present Perfect and Present Simple",c:false}],
      expl:"'I've just been' = Present Perfect | 'She told me' = Simple Past. Two tenses." }
  ]},

  { id:"W3Z2", name:"Opinions & Discourse", icon:"💡", type:"lesson", exercises:[
    { id:"E126", type:"mc", skill:"vocabulary",
      q:"Which phrase expresses STRONG agreement?",
      opts:[{t:"I suppose so.",c:false},{t:"I couldn't agree more.",c:true},{t:"I'm not sure about that.",c:false},{t:"I see your point, but...",c:false}],
      expl:"'I couldn't agree more' = maximum agreement. 'I suppose so' = weak." },
    { id:"E127", type:"fib", skill:"vocabulary",
      q:"'In my ___, social media has more benefits than drawbacks.'",
      blank:"opinion",
      hint:"Your personal view or perspective.",
      expl:"'In my opinion/view' introduces personal perspectives." },
    { id:"E128", type:"dd", skill:"vocabulary",
      q:"Match each discourse marker to its function:",
      drag:["However","Furthermore","As a result"],
      tgts:[{pfx:"Contrast →",ok:"However"},{pfx:"Addition →",ok:"Furthermore"},{pfx:"Consequence →",ok:"As a result"}],
      expl:"Contrast: however, nevertheless | Addition: furthermore, moreover | Consequence: therefore" },
    { id:"E129", type:"tf", skill:"reading",
      q:"'Nevertheless' and 'however' can both introduce a contrasting idea.",
      stmt:"Nevertheless and however both introduce contrasting ideas.",
      ans:true,
      expl:"Correct! Both signal contrast. 'Nevertheless' implies the contrast is more surprising." },
    { id:"E130", type:"mc", skill:"vocabulary",
      q:"What does 'on the other hand' signal?",
      opts:[{t:"A supporting argument",c:false},{t:"A contrasting viewpoint",c:true},{t:"A conclusion",c:false},{t:"An example",c:false}],
      expl:"'On the other hand' = the OPPOSITE perspective. Used in pairs." },
    { id:"E131", type:"sb", skill:"grammar",
      q:"Build an opinion sentence with contrast:",
      words:["I","think","that","social","media","is","useful","however","it","can","be","addictive"],
      correct:"I think that social media is useful however it can be addictive",
      expl:"Opinion + contrast: [opinion] + however + [contrasting point]." },
    { id:"E132", type:"listening", skill:"listening",
      q:"Listen and identify the speaker's main opinion:",
      audio:"In my view, working from home has many advantages. For example, you save time commuting. However, it can feel isolating.",
      opts:[{t:"Working from home is completely negative.",c:false},{t:"Working from home has advantages but can feel isolating.",c:true},{t:"Working from home only saves commuting time.",c:false},{t:"The speaker has no opinion.",c:false}],
      expl:"'Many advantages'(positive) + 'however feel isolating'(concession). Balanced opinion." },
    { id:"E133", type:"mc", skill:"vocabulary",
      q:"'I take your point, but...' is used to:",
      opts:[{t:"Completely agree.",c:false},{t:"Acknowledge an argument while disagreeing.",c:true},{t:"Ask for clarification.",c:false},{t:"Change the subject.",c:false}],
      expl:"'I take your point' = diplomatic disagreement. Acknowledge before presenting your view." },
    { id:"E134", type:"fib", skill:"vocabulary",
      q:"'The evidence strongly ___ that climate change is man-made.'",
      blank:"suggests",
      hint:"Evidence can hint at or point to something.",
      expl:"Evidence 'suggests/indicates/shows' — NOT 'argues'. Only people argue." },
    { id:"E135", type:"dd", skill:"vocabulary",
      q:"Match each expression to its function:",
      drag:["For instance","In conclusion","Admittedly"],
      tgts:[{pfx:"Give an example →",ok:"For instance"},{pfx:"Sum up →",ok:"In conclusion"},{pfx:"Concede a point →",ok:"Admittedly"}],
      expl:"For instance(example) | In conclusion(ending) | Admittedly(concession)." },
    { id:"E136", type:"tf", skill:"reading",
      q:"A 'rhetorical question' is asked to get a direct answer.",
      stmt:"A rhetorical question is asked to get a direct answer.",
      ans:false,
      expl:"A rhetorical question is asked for EFFECT, not to receive an answer." },
    { id:"E137", type:"mc", skill:"vocabulary",
      q:"What does 'pros and cons' mean?",
      opts:[{t:"Beginners and experts.",c:false},{t:"Advantages and disadvantages.",c:true},{t:"Questions and answers.",c:false},{t:"For and against people.",c:false}],
      expl:"Pros = advantages. Cons = disadvantages. From Latin: pro(for) and contra(against)." },
    { id:"E138", type:"speaking", skill:"speaking",
      q:"Give your opinion on technology. Say this:",
      prompt:"In my opinion, technology has changed our lives for the better, although it also has some disadvantages.",
      target:"opinion technology better disadvantages",
      keywords:["opinion","technology","better","disadvantages"],
      expl:"Balanced opinion: In my opinion + positive + although + concession." },
    { id:"E139", type:"es", skill:"grammar",
      q:"Click the word that does not belong:",
      text:"Despite the difficulties she managed to passed the examination with flying colours.",
      err:"passed",
      fix:"pass",
      expl:"After 'managed to', use the BASE form: 'managed to PASS'. 'Managed to' = was able to." },
    { id:"E140", type:"listening", skill:"listening",
      q:"Listen and choose which side the speaker supports:",
      audio:"While I understand fast food is convenient, I strongly believe cooking at home is far better for your health and wallet.",
      opts:[{t:"The speaker supports fast food.",c:false},{t:"The speaker is neutral.",c:false},{t:"The speaker prefers cooking at home.",c:true},{t:"The speaker is against all food choices.",c:false}],
      expl:"'strongly believe' + 'far better' = strong opinion FOR home cooking." }
  ]},

  { id:"W3Z3", name:"Future & Modal Verbs", icon:"🔮", type:"lesson", exercises:[
    { id:"E141", type:"mc", skill:"grammar",
      q:"Which is the best form for a future PLAN you have already decided?",
      opts:[{t:"I will visit my grandmother.",c:false},{t:"I am going to visit my grandmother.",c:true},{t:"I visit my grandmother.",c:false},{t:"I am visiting someday.",c:false}],
      expl:"'Going to' = pre-decided plan. 'Will' = decision made NOW or predictions." },
    { id:"E142", type:"fib", skill:"grammar",
      q:"'You ___ wear a seatbelt. It's the law!'",
      blank:"must",
      hint:"Strong obligation or legal necessity.",
      expl:"MUST = strong obligation. HAVE TO = external obligation. SHOULD = recommendation." },
    { id:"E143", type:"dd", skill:"grammar",
      q:"Match each modal to its function:",
      drag:["must","should","might"],
      tgts:[{pfx:"Strong obligation →",ok:"must"},{pfx:"Advice →",ok:"should"},{pfx:"Possibility (50%) →",ok:"might"}],
      expl:"must(obligation) | should(advice) | might/could/may(possibility)" },
    { id:"E144", type:"tf", skill:"grammar",
      q:"'Shall' is commonly used in American English for suggestions.",
      stmt:"Shall is common in American English for suggestions.",
      ans:false,
      expl:"'Shall' is British English. Americans use 'Should we...?' or 'Let's...' instead." },
    { id:"E145", type:"mc", skill:"grammar",
      q:"'It ___ rain later — look at those clouds!'",
      opts:[{t:"must",c:false},{t:"might",c:true},{t:"can",c:false},{t:"shall",c:false}],
      expl:"'Might rain' = possibility based on evidence (clouds). Not certainty, just possibility." },
    { id:"E146", type:"sb", skill:"grammar",
      q:"Build a sentence about a future plan:",
      words:["Next","summer","we","are","going","to","travel","around","Europe"],
      correct:"Next summer we are going to travel around Europe",
      expl:"'Going to' + base verb for plans. Pre-decided = 'going to'." },
    { id:"E147", type:"listening", skill:"listening",
      q:"Listen and choose what the person plans to do:",
      audio:"I've decided that I'm going to study medicine next year. I've already applied to three universities.",
      opts:[{t:"She might study medicine someday.",c:false},{t:"She has decided to study medicine next year.",c:true},{t:"She will probably change her mind.",c:false},{t:"She wants to become a teacher.",c:false}],
      expl:"'I've decided' + 'I'm going to study' = definite plan. 'Already applied' confirms it." },
    { id:"E148", type:"mc", skill:"grammar",
      q:"'You ___ smoke in here.' (prohibition)",
      opts:[{t:"shouldn't",c:false},{t:"mustn't",c:true},{t:"needn't",c:false},{t:"wouldn't",c:false}],
      expl:"MUSTN'T = prohibition (not allowed). SHOULDN'T = advice against. NEEDN'T = not necessary." },
    { id:"E149", type:"fib", skill:"grammar",
      q:"'It will ___ be sunny tomorrow.' (adding uncertainty)",
      blank:"probably",
      hint:"This adverb adds uncertainty to a prediction.",
      expl:"'Will probably' = prediction with some uncertainty. 'Might/could/may' also express uncertainty." },
    { id:"E150", type:"es", skill:"grammar",
      q:"Find the modal error:",
      text:"You don't must smoke in the hospital. It is strictly forbidden.",
      err:"don't must",
      fix:"mustn't",
      expl:"MUSTN'T for prohibition. Never add 'don't' before modal verbs." },
    { id:"E151", type:"dd", skill:"grammar",
      q:"Match each modal to a sample sentence:",
      drag:["can","could","would"],
      tgts:[{pfx:"Present ability →",ok:"can"},{pfx:"Past ability →",ok:"could"},{pfx:"Polite request →",ok:"would"}],
      expl:"can=present ability | could=past ability | would=conditional/polite" },
    { id:"E152", type:"tf", skill:"grammar",
      q:"'Don't have to' and 'mustn't' have the same meaning.",
      stmt:"Don't have to and mustn't have the same meaning.",
      ans:false,
      expl:"DON'T HAVE TO = not necessary (but can if you want). MUSTN'T = forbidden." },
    { id:"E153", type:"mc", skill:"grammar",
      q:"'By this time next year, she ___ graduated.'",
      opts:[{t:"will graduate",c:false},{t:"will have graduated",c:true},{t:"is going to graduate",c:false},{t:"graduates",c:false}],
      expl:"Future Perfect: will + have + past participle. Used for actions completed BEFORE a future time." },
    { id:"E154", type:"speaking", skill:"speaking",
      q:"Talk about your future plans. Say this:",
      prompt:"Next year, I'm going to learn a new language and travel to South America.",
      target:"going learn language travel",
      keywords:["going","learn","language","travel"],
      expl:"'Going to' for decided future plans. Verbs after 'going to': base form." },
    { id:"E155", type:"listening", skill:"listening",
      q:"Listen and identify the modals and their meanings:",
      audio:"You should see a doctor about that cough. It might be serious, and you mustn't ignore it.",
      opts:[{t:"should=obligation, might=certainty, mustn't=advice",c:false},{t:"should=advice, might=possibility, mustn't=prohibition",c:true},{t:"should=possibility, might=advice, mustn't=obligation",c:false},{t:"All three express the same meaning.",c:false}],
      expl:"should=advice | might=possibility | mustn't=prohibition. Three distinct modal functions." }
  ]},

  { id:"W3Z4", name:"Boss Exam B1", icon:"👑", type:"boss", cefr:"B1", exercises:[
    { id:"E156", type:"mc", skill:"grammar",
      q:"Choose the correct Present Perfect sentence:",
      opts:[{t:"I have saw that film.",c:false},{t:"I have seen that film before.",c:true},{t:"I have see that film.",c:false},{t:"I seen that film.",c:false}],
      expl:"Present Perfect: have/has + PAST PARTICIPLE. see→saw→SEEN." },
    { id:"E157", type:"sb", skill:"grammar",
      q:"Build a sentence using 'for' + duration:",
      words:["I","have","been","studying","English","for","three","years"],
      correct:"I have been studying English for three years",
      expl:"Present Perfect Continuous: have/has been + -ing + for + duration." },
    { id:"E158", type:"listening", skill:"listening",
      q:"Listen and choose the best summary:",
      audio:"Even though the project was difficult, the team finished it on time and the client was very satisfied.",
      opts:[{t:"The project failed.",c:false},{t:"The team succeeded despite the difficulty.",c:true},{t:"The client was unsatisfied.",c:false},{t:"The project was easy.",c:false}],
      expl:"'Even though' = despite. 'Finished on time' + 'client satisfied' = success." },
    { id:"E159", type:"fib", skill:"vocabulary",
      q:"'___ I agree exercise is important, I find it hard to motivate myself.'",
      blank:"Although",
      hint:"A conjunction that introduces a concession.",
      expl:"Although/while/even though + [conceded point] + [main idea]. B1 concession conjunctions." },
    { id:"E160", type:"mc", skill:"grammar",
      q:"'If I ___ more time, I would travel more.'",
      opts:[{t:"have",c:false},{t:"had",c:true},{t:"will have",c:false},{t:"would have",c:false}],
      expl:"Second Conditional (unreal present): If + Past Simple → would + base verb." },
    { id:"E161", type:"es", skill:"grammar",
      q:"Click the error in this sentence:",
      text:"Despite of the rain the match was played and the home team won.",
      err:"Despite of",
      fix:"Despite",
      expl:"'Despite' never followed by 'of'. Use 'despite + noun' OR 'in spite of + noun'." },
    { id:"E162", type:"dd", skill:"grammar",
      q:"Match the time expression to the correct tense:",
      drag:["yesterday","since 2019","next Monday"],
      tgts:[{pfx:"Simple Past →",ok:"yesterday"},{pfx:"Present Perfect →",ok:"since 2019"},{pfx:"Future plan →",ok:"next Monday"}],
      expl:"yesterday=Simple Past | since=Present Perfect | next Monday=future." },
    { id:"E163", type:"tf", skill:"grammar",
      q:"'She suggested that we go to the cinema' uses the subjunctive.",
      stmt:"She suggested that we go uses the subjunctive.",
      ans:true,
      expl:"After suggest: subjunctive (base form): 'we GO' not 'we should go'." },
    { id:"E164", type:"speaking", skill:"speaking",
      q:"Describe a past experience. Say this:",
      prompt:"Last year I visited Japan for the first time. It was an incredible experience.",
      target:"visited japan first incredible experience",
      keywords:["visited","japan","incredible","experience"],
      expl:"Use Simple Past for past events. 'For the first time' = never done before." },
    { id:"E165", type:"mc", skill:"vocabulary",
      q:"What does 'come across' mean in 'I came across an old photo yesterday'?",
      opts:[{t:"Dropped and broke",c:false},{t:"Found by chance",c:true},{t:"Deliberately searched for",c:false},{t:"Threw away",c:false}],
      expl:"'Come across' = find by accident/chance. Very common phrasal verb." }
  ]}
]},
/* ══════════════════════════════════════════════════
   W4 · B2 · DEBATE ARENA
   ══════════════════════════════════════════════════ */
{ id:"W4", name:"Debate Arena", cefr:"B2", icon:"⚔️", zones:[

  { id:"W4Z1", name:"Complex Grammar", icon:"🧬", type:"lesson", exercises:[
    { id:"E166", type:"mc", skill:"grammar",
      q:"Identify the correct Third Conditional sentence:",
      opts:[{t:"If I study harder, I will pass.",c:false},{t:"If I studied harder, I would pass.",c:false},{t:"If I had studied harder, I would have passed.",c:true},{t:"If I had studied harder, I would pass.",c:false}],
      expl:"3rd Conditional: If + Past Perfect → would have + Past Participle. Expresses regret about the past." },
    { id:"E167", type:"es", skill:"grammar",
      q:"Click the error in this Third Conditional:",
      text:"If she would have called me earlier I would have helped her.",
      err:"would have called",
      fix:"had called",
      expl:"In the IF-clause: use Past Perfect (had called). 'Would have' ONLY in the main clause." },
    { id:"E168", type:"fib", skill:"grammar",
      q:"The report ___ by the team before the deadline. (passive, past simple)",
      blank:"was submitted",
      hint:"Passive Simple Past: was/were + past participle.",
      expl:"Passive: Subject + was/were + past participle. Use when doer is unknown or unimportant." },
    { id:"E169", type:"sb", skill:"grammar",
      q:"Build a passive sentence:",
      words:["The","letter","was","signed","by","the","CEO","yesterday"],
      correct:"The letter was signed by the CEO yesterday",
      expl:"Passive: Subject + was/were + past participle + by + agent + time." },
    { id:"E170", type:"mc", skill:"grammar",
      q:"'She said she ___ going to the gym.' (Reported Speech: original: 'I am going')",
      opts:[{t:"is",c:false},{t:"was",c:true},{t:"will be",c:false},{t:"has been",c:false}],
      expl:"Reported Speech backshift: am/is/are → was/were. Present tense shifts back one." },
    { id:"E171", type:"dd", skill:"grammar",
      q:"Match each direct speech to its correct reported form:",
      drag:["said she was tired","told me he had eaten","asked if I was free"],
      tgts:[{pfx:"'I am tired.' (she) →",ok:"said she was tired"},{pfx:"'I have eaten.' (he) →",ok:"told me he had eaten"},{pfx:"'Are you free?' →",ok:"asked if I was free"}],
      expl:"say/tell + that for statements | ask + if/whether for questions. Backshift: is→was." },
    { id:"E172", type:"tf", skill:"grammar",
      q:"Passive voice is used when the agent (doer) is MORE important than the action.",
      stmt:"Passive is used when the agent is more important.",
      ans:false,
      expl:"Passive is used when the OBJECT/ACTION is more important or the agent is unknown." },
    { id:"E173", type:"mc", skill:"grammar",
      q:"'She had her car ___ at the garage.'",
      opts:[{t:"repaired",c:true},{t:"repair",c:false},{t:"repairing",c:false},{t:"to repair",c:false}],
      expl:"Causative: have + object + past participle. 'Had her car REPAIRED.' = someone did it for her." },
    { id:"E174", type:"fib", skill:"grammar",
      q:"'___ I known the truth, I wouldn't have gone.' (Inverted 3rd conditional)",
      blank:"Had",
      hint:"Formal inverted conditional — remove 'if' and invert.",
      expl:"Inverted: 'Had I known' = 'If I had known.' Formal/literary structure." },
    { id:"E175", type:"listening", skill:"listening",
      q:"Listen and identify the grammatical structure:",
      audio:"The new hospital is being built on the outskirts. It is expected to open next year.",
      opts:[{t:"Active voice, simple present",c:false},{t:"Passive voice, present continuous and simple",c:true},{t:"Passive voice, past simple only",c:false},{t:"Reported speech",c:false}],
      expl:"'is being built' = Present Continuous Passive. 'is expected' = Present Simple Passive." },
    { id:"E176", type:"es", skill:"grammar",
      q:"Click the error in reported speech:",
      text:"She told that she would finish the project by Friday.",
      err:"told that",
      fix:"said that",
      expl:"TELL needs an object: 'told ME that.' SAY goes directly: 'said that.' Never 'told that'." },
    { id:"E177", type:"mc", skill:"grammar",
      q:"'The data collected ___ that the hypothesis was incorrect.'",
      opts:[{t:"prove",c:false},{t:"proves",c:true},{t:"are proving",c:false},{t:"have proven",c:false}],
      expl:"'The data collected' as a concept = singular → 'proves'." },
    { id:"E178", type:"sb", skill:"grammar",
      q:"Build an inverted conditional:",
      words:["Had","the","weather","been","better","we","would","have","gone","to","the","beach"],
      correct:"Had the weather been better we would have gone to the beach",
      expl:"Inverted 3rd Conditional: Had + subject + past participle, subject + would have + result." },
    { id:"E179", type:"speaking", skill:"speaking",
      q:"Express regret using the Third Conditional:",
      prompt:"If I had studied harder, I would have passed the exam.",
      target:"studied harder would passed exam",
      keywords:["studied","harder","would","passed"],
      expl:"3rd Conditional: If + had + participle → would have + participle. Expresses regret." },
    { id:"E180", type:"listening", skill:"listening",
      q:"Listen and identify the conditional type:",
      audio:"If you had taken the earlier train, you wouldn't have missed the meeting.",
      opts:[{t:"First Conditional",c:false},{t:"Second Conditional",c:false},{t:"Third Conditional (unreal past)",c:true},{t:"Zero Conditional",c:false}],
      expl:"If + Past Perfect (had taken) → wouldn't have missed = Third Conditional." }
  ]},

  { id:"W4Z2", name:"Academic Vocabulary", icon:"📚", type:"lesson", exercises:[
    { id:"E181", type:"mc", skill:"vocabulary",
      q:"What does 'ambiguous' mean?",
      opts:[{t:"Extremely clear",c:false},{t:"Open to more than one interpretation",c:true},{t:"Completely false",c:false},{t:"Unnecessarily complex",c:false}],
      expl:"Ambiguous = having multiple possible meanings. 'The results were ambiguous' = unclear." },
    { id:"E182", type:"fib", skill:"vocabulary",
      q:"The scientist conducted the experiment to ___ her hypothesis. (prove it correct)",
      blank:"validate",
      hint:"To prove the accuracy or value of something.",
      expl:"Validate = confirm accuracy. Also: verify, corroborate, substantiate." },
    { id:"E183", type:"dd", skill:"vocabulary",
      q:"Match each formal word to its informal equivalent:",
      drag:["begin","end","help"],
      tgts:[{pfx:"commence →",ok:"begin"},{pfx:"terminate →",ok:"end"},{pfx:"facilitate →",ok:"help"}],
      expl:"commence=begin | terminate=end | facilitate=help/enable." },
    { id:"E184", type:"mc", skill:"vocabulary",
      q:"What does 'mitigate' mean?",
      opts:[{t:"To make something worse",c:false},{t:"To make something less severe",c:true},{t:"To completely eliminate",c:false},{t:"To ignore",c:false}],
      expl:"Mitigate = reduce severity. 'Measures to mitigate climate change.' Opposite: exacerbate." },
    { id:"E185", type:"tf", skill:"vocabulary",
      q:"'Pragmatic' means dealing with things in a realistic, practical way.",
      stmt:"Pragmatic means dealing with things practically.",
      ans:true,
      expl:"Correct! Pragmatic = practical, realistic. Opposite: idealistic, theoretical." },
    { id:"E186", type:"sb", skill:"grammar",
      q:"Build a formal academic sentence:",
      words:["The","evidence","strongly","suggests","that","dietary","habits","affect","cognitive","performance"],
      correct:"The evidence strongly suggests that dietary habits affect cognitive performance",
      expl:"Academic: Subject + adverb(strongly) + suggests + that + clause. More academic than 'shows'." },
    { id:"E187", type:"listening", skill:"listening",
      q:"Listen and choose the formal equivalent:",
      audio:"The committee decided to look into the matter carefully before making any final decisions.",
      opts:[{t:"The committee avoided the matter.",c:false},{t:"The committee chose to investigate thoroughly before concluding.",c:true},{t:"The committee made a hasty decision.",c:false},{t:"The committee delegated the matter.",c:false}],
      expl:"'look into'=investigate | 'carefully'=thoroughly | 'final decisions'=concluding." },
    { id:"E188", type:"mc", skill:"vocabulary",
      q:"What is the meaning of 'proliferate'?",
      opts:[{t:"To decrease rapidly",c:false},{t:"To increase rapidly and spread widely",c:true},{t:"To become more formal",c:false},{t:"To become simplified",c:false}],
      expl:"Proliferate = multiply, spread rapidly. 'Social media platforms have proliferated.'" },
    { id:"E189", type:"fib", skill:"vocabulary",
      q:"This policy is not ___ with our current framework.",
      blank:"compatible",
      hint:"Two things that work well together are this.",
      expl:"Compatible = able to exist together. Incompatible = in conflict." },
    { id:"E190", type:"dd", skill:"vocabulary",
      q:"Match each academic verb to its meaning:",
      drag:["analyse","synthesise","evaluate"],
      tgts:[{pfx:"Break down into parts →",ok:"analyse"},{pfx:"Combine into whole →",ok:"synthesise"},{pfx:"Judge the value of →",ok:"evaluate"}],
      expl:"Bloom's Taxonomy: analyse | synthesise | evaluate | apply | understand | remember." },
    { id:"E191", type:"mc", skill:"vocabulary",
      q:"'The findings corroborate previous research.' What does 'corroborate' mean?",
      opts:[{t:"Contradict",c:false},{t:"Confirm and support",c:true},{t:"Ignore",c:false},{t:"Extend beyond",c:false}],
      expl:"Corroborate = support and confirm. Opposite: refute, contradict." },
    { id:"E192", type:"es", skill:"vocabulary",
      q:"Click the word used incorrectly:",
      text:"The author infers that violence in media has a negative effect on children.",
      err:"infers",
      fix:"implies",
      expl:"The AUTHOR implies (hints). The READER infers (draws a conclusion). Texts imply; readers infer." },
    { id:"E193", type:"tf", skill:"vocabulary",
      q:"'Substantial' and 'considerable' have similar meanings.",
      stmt:"Substantial and considerable are similar in meaning.",
      ans:true,
      expl:"Correct! Both mean 'large in size/amount'. Synonyms: significant, notable, marked." },
    { id:"E194", type:"speaking", skill:"speaking",
      q:"Use academic language to discuss an issue:",
      prompt:"The evidence suggests that physical exercise significantly enhances mental health and cognitive function.",
      target:"evidence suggests exercise mental health",
      keywords:["evidence","suggests","exercise","mental"],
      expl:"Academic speech: evidence suggests (not 'shows'). 'Significantly' = to a great degree." },
    { id:"E195", type:"listening", skill:"listening",
      q:"Listen and choose the best academic paraphrase:",
      audio:"Many people nowadays use their phones too much, causing problems with concentration and sleep.",
      opts:[{t:"Excessive smartphone usage is linked to impaired attention and disrupted sleep.",c:true},{t:"People who use phones are bad at sleeping.",c:false},{t:"Phones should be banned.",c:false},{t:"Concentration depends on the phone type.",c:false}],
      expl:"Academic: 'too much'→'excessive' | 'problems with'→'impaired' | 'concentration'→'attention'." }
  ]},

  { id:"W4Z3", name:"Argumentation & Critical Thinking", icon:"⚖️", type:"lesson", exercises:[
    { id:"E196", type:"mc", skill:"reading",
      q:"What is a 'strawman fallacy'?",
      opts:[{t:"A very strong argument",c:false},{t:"Misrepresenting someone's argument to attack it more easily",c:true},{t:"Using statistics to mislead",c:false},{t:"Citing unreliable sources",c:false}],
      expl:"Strawman = distorting an opponent's argument to make it easier to knock down." },
    { id:"E197", type:"fib", skill:"vocabulary",
      q:"'The government's ___ on healthcare contradicts its stated priorities.'",
      blank:"stance",
      hint:"Your position or attitude on an issue.",
      expl:"Stance = position on an issue. Also: standpoint, viewpoint, position." },
    { id:"E198", type:"dd", skill:"reading",
      q:"Match each logical fallacy to its description:",
      drag:["ad hominem","slippery slope","false dichotomy"],
      tgts:[{pfx:"Attacking the person, not the argument →",ok:"ad hominem"},{pfx:"Claiming one action leads to extreme consequences →",ok:"slippery slope"},{pfx:"Presenting only two options when more exist →",ok:"false dichotomy"}],
      expl:"ad hominem(attack person) | slippery slope(chain of consequences) | false dichotomy(only 2 choices)." },
    { id:"E199", type:"tf", skill:"reading",
      q:"A 'concession' in an argument means you completely abandon your position.",
      stmt:"A concession means completely abandoning your position.",
      ans:false,
      expl:"A concession acknowledges an opposing point WHILE maintaining your overall position." },
    { id:"E200", type:"mc", skill:"vocabulary",
      q:"What does 'to substantiate a claim' mean?",
      opts:[{t:"To make a claim louder",c:false},{t:"To provide evidence supporting a claim",c:true},{t:"To withdraw a claim",c:false},{t:"To exaggerate a claim",c:false}],
      expl:"Substantiate = support with evidence. Synonyms: validate, corroborate, back up." },
    { id:"E201", type:"sb", skill:"grammar",
      q:"Build a concessive argument:",
      words:["Although","this","policy","has","some","merit","its","long-term","consequences","remain","unclear"],
      correct:"Although this policy has some merit its long-term consequences remain unclear",
      expl:"Concession: Although [conceded point] + [main argument]. Shows you see both sides." },
    { id:"E202", type:"listening", skill:"listening",
      q:"Listen and identify the type of argument used:",
      audio:"Studies show that countries with stricter gun laws have lower rates of gun violence. Switzerland is a clear example.",
      opts:[{t:"Emotional appeal with anecdotes",c:false},{t:"Statistical evidence with a case study",c:true},{t:"Personal opinion without support",c:false},{t:"A logical fallacy",c:false}],
      expl:"'Studies show' = statistical evidence | 'Switzerland is a clear example' = case study." },
    { id:"E203", type:"mc", skill:"reading",
      q:"What does 'correlation does not imply causation' mean?",
      opts:[{t:"Two events together proves one caused the other.",c:false},{t:"Two events together doesn't mean one caused the other.",c:true},{t:"Causation is impossible to prove.",c:false},{t:"Correlation means events never happen together.",c:false}],
      expl:"Just because A and B happen together doesn't mean A CAUSES B. Classic critical thinking." },
    { id:"E204", type:"fib", skill:"vocabulary",
      q:"The politician used ___ language to distract from the real issue.",
      blank:"red herring",
      hint:"A misleading distraction in an argument.",
      expl:"Red herring = introducing irrelevant information to distract from the main point." },
    { id:"E205", type:"es", skill:"grammar",
      q:"Click the word with a grammatical error:",
      text:"The hypothesis were supported by three independent studies.",
      err:"were",
      fix:"was",
      expl:"'The hypothesis' = singular → 'WAS supported'. Don't be distracted by 'three studies'." },
    { id:"E206", type:"dd", skill:"vocabulary",
      q:"Match each linking phrase to its rhetorical function:",
      drag:["To illustrate this","Contrary to this","It follows that"],
      tgts:[{pfx:"Give an example →",ok:"To illustrate this"},{pfx:"Express opposition →",ok:"Contrary to this"},{pfx:"Draw a logical conclusion →",ok:"It follows that"}],
      expl:"To illustrate(examples) | Contrary to(opposition) | It follows that(conclusion)." },
    { id:"E207", type:"tf", skill:"reading",
      q:"'Begging the question' means asking for more information.",
      stmt:"Begging the question means asking for more information.",
      ans:false,
      expl:"'Begging the question' is a logical fallacy where the conclusion is assumed in the premise." },
    { id:"E208", type:"mc", skill:"vocabulary",
      q:"Choose the correct use of 'notwithstanding':",
      opts:[{t:"She failed. Notwithstanding, she was brilliant.",c:false},{t:"Notwithstanding the evidence, they refused to reconsider.",c:true},{t:"She worked hard notwithstanding to pass.",c:false},{t:"Notwithstanding, the evidence was clear.",c:false}],
      expl:"Notwithstanding = despite. 'Notwithstanding + noun phrase + main clause.' Very formal." },
    { id:"E209", type:"speaking", skill:"speaking",
      q:"Present a counter-argument politely:",
      prompt:"I see your point, however the evidence suggests a different conclusion.",
      target:"point however evidence suggests conclusion",
      keywords:["point","however","evidence","suggests"],
      expl:"Counter-argument: acknowledge + contrast (however) + evidence + conclusion." },
    { id:"E210", type:"listening", skill:"listening",
      q:"Listen and identify the logical fallacy:",
      audio:"If we allow students to use calculators, next they'll want phones, and soon nobody will learn anything.",
      opts:[{t:"Ad hominem — attacking the person",c:false},{t:"Slippery slope — chain of exaggerated consequences",c:true},{t:"False dichotomy — only two options",c:false},{t:"Red herring — irrelevant distraction",c:false}],
      expl:"Slippery slope: calculators→phones→nobody learns. Exaggerated chain with no evidence." }
  ]},

  { id:"W4Z4", name:"Boss Exam B2", icon:"👑", type:"boss", cefr:"B2", exercises:[
    { id:"E211", type:"es", skill:"grammar",
      q:"Find the grammatical error:",
      text:"The data collected by the team prove that the hypothesis were incorrect.",
      err:"were",
      fix:"was",
      expl:"'The hypothesis' is singular → 'WAS incorrect'. Don't be distracted by 'data'." },
    { id:"E212", type:"mc", skill:"grammar",
      q:"Select the correctly formed reported speech:",
      opts:[{t:"She said she is going to the gym.",c:false},{t:"She said she was going to the gym.",c:true},{t:"She told she was going to the gym.",c:false},{t:"She said she goes to the gym.",c:false}],
      expl:"Backshift: 'is going'→'was going'. 'Told' needs an object: 'told me/him/her'." },
    { id:"E213", type:"fib", skill:"grammar",
      q:"Had I ___ the truth, I wouldn't have attended. (past participle of 'know')",
      blank:"known",
      hint:"Past participle of 'know' for inverted 3rd conditional.",
      expl:"Inverted 3rd conditional: Had + subject + PAST PARTICIPLE. know→known." },
    { id:"E214", type:"sb", skill:"grammar",
      q:"Build a complex formal sentence:",
      words:["Notwithstanding","the","considerable","challenges","the","project","was","completed","on","schedule"],
      correct:"Notwithstanding the considerable challenges the project was completed on schedule",
      expl:"'Notwithstanding + [noun phrase] + [main clause].' Formal concession." },
    { id:"E215", type:"listening", skill:"listening",
      q:"Listen and choose the best summary:",
      audio:"While renewable energy is increasingly viable, the transition from fossil fuels requires investment and faces political resistance.",
      opts:[{t:"Renewable energy is impossible.",c:false},{t:"Renewables are viable but face cost and political challenges.",c:true},{t:"Fossil fuels are better than renewable energy.",c:false},{t:"Political support for renewables is growing rapidly.",c:false}],
      expl:"'Increasingly viable'(positive) + 'requires investment'+'political resistance'(challenges)." },
    { id:"E216", type:"mc", skill:"vocabulary",
      q:"'The proposal was met with widespread ___ from industry leaders.'",
      opts:[{t:"acclaim",c:false},{t:"opposition",c:true},{t:"indifference",c:false},{t:"enthusiasm",c:false}],
      expl:"Opposition = resistance/disagreement. Acclaim = praise. 'Widespread' = affecting many." },
    { id:"E217", type:"dd", skill:"vocabulary",
      q:"Match each B2 word to its simpler equivalent:",
      drag:["require","decrease","predict"],
      tgts:[{pfx:"necessitate →",ok:"require"},{pfx:"diminish →",ok:"decrease"},{pfx:"forecast →",ok:"predict"}],
      expl:"necessitate=require | diminish=decrease | forecast=predict. Academic often uses Latinate words." },
    { id:"E218", type:"tf", skill:"grammar",
      q:"'Unless' means the same as 'if not'.",
      stmt:"Unless means the same as if not.",
      ans:true,
      expl:"Correct! 'Unless you study, you'll fail' = 'If you DON'T study, you'll fail.'" },
    { id:"E219", type:"speaking", skill:"speaking",
      q:"Argue using academic language:",
      prompt:"The evidence strongly suggests that remote work increases productivity and employee satisfaction.",
      target:"evidence remote productivity satisfaction",
      keywords:["evidence","remote","productivity","satisfaction"],
      expl:"Academic: evidence + formal verb + noun phrase + parallel structure." },
    { id:"E220", type:"es", skill:"grammar",
      q:"Find the error in this formal sentence:",
      text:"Despite of the team's best efforts the deadline could not be met.",
      err:"Despite of",
      fix:"Despite",
      expl:"'Despite' never followed by 'of'. Use 'despite + noun' OR 'in spite of + noun'." }
  ]}
]},

/* ══════════════════════════════════════════════════
   W5 · C1 · SCHOLAR'S TOWER
   ══════════════════════════════════════════════════ */
{ id:"W5", name:"Scholar's Tower", cefr:"C1", icon:"🎓", zones:[

  { id:"W5Z1", name:"Advanced Grammar & Style", icon:"✍️", type:"lesson", exercises:[
    { id:"E221", type:"mc", skill:"grammar",
      q:"Which construction is a formal inverted conditional?",
      opts:[{t:"If I were you...",c:false},{t:"Were I to leave now...",c:true},{t:"Unless I leave now...",c:false},{t:"Provided that I leave...",c:false}],
      expl:"'Were I to leave' = inverted conditional. Formal/literary: Were + subject + to + infinitive." },
    { id:"E222", type:"fib", skill:"grammar",
      q:"It is essential that every candidate ___ the form. (formal subjunctive)",
      blank:"complete",
      hint:"Subjunctive: use base form, not 'completes'.",
      expl:"Formal subjunctive: It is [adjective] that + subject + BASE VERB. After: essential, vital, necessary." },
    { id:"E223", type:"es", skill:"grammar",
      q:"Find the word-form error:",
      text:"The board persisted in their conviction that profits would eventual recover.",
      err:"eventual",
      fix:"eventually",
      expl:"'eventual' = adjective. 'Eventually' = adverb — needed here to modify the verb 'recover'." },
    { id:"E224", type:"sb", skill:"grammar",
      q:"Build an inverted conditional (no 'if'):",
      words:["Had","she","arrived","earlier","she","would","have","met","the","director"],
      correct:"Had she arrived earlier she would have met the director",
      expl:"Inverted Past Perfect conditional: Had + subject + past participle → would have + result." },
    { id:"E225", type:"mc", skill:"grammar",
      q:"Choose the correct use of the subjunctive:",
      opts:[{t:"I suggest that she leaves immediately.",c:false},{t:"I suggest that she leave immediately.",c:true},{t:"I suggest that she will leave.",c:false},{t:"I suggest her leaving immediately.",c:false}],
      expl:"Subjunctive after suggest + that + subject + BASE VERB. 'leave' (not 'leaves' or 'will leave')." },
    { id:"E226", type:"dd", skill:"grammar",
      q:"Match each C1 structure to its example:",
      drag:["Subjunctive","Inverted conditional","Cleft sentence"],
      tgts:[{pfx:"It is crucial that he be present.",ok:"Subjunctive"},{pfx:"Were she to resign, it would be catastrophic.",ok:"Inverted conditional"},{pfx:"It was the CEO who made the decision.",ok:"Cleft sentence"}],
      expl:"Subjunctive(base verb after that) | Inverted cond.(Were/Had+inversion) | Cleft(It was+X+that)" },
    { id:"E227", type:"tf", skill:"grammar",
      q:"'Were she to resign' can replace 'If she resigned'.",
      stmt:"Were she to resign can replace If she resigned.",
      ans:true,
      expl:"Correct! Both express a hypothetical situation. 'Were she to resign' is more formal." },
    { id:"E228", type:"listening", skill:"listening",
      q:"Listen and identify the grammatical structure:",
      audio:"Had the committee taken the warnings seriously, this crisis could have been avoided.",
      opts:[{t:"Simple conditional",c:false},{t:"Inverted third conditional: Had + past participle",c:true},{t:"Second conditional",c:false},{t:"Zero conditional",c:false}],
      expl:"'Had the committee taken' = inverted Past Perfect conditional. No 'if'." },
    { id:"E229", type:"mc", skill:"grammar",
      q:"'The report, ___ by a team of experts, was submitted to Parliament.'",
      opts:[{t:"written",c:true},{t:"that was written",c:false},{t:"writing",c:false},{t:"to write",c:false}],
      expl:"Reduced relative clause: 'written by experts' = 'which was written by experts'." },
    { id:"E230", type:"fib", skill:"grammar",
      q:"'Scarcely ___ she sat down when the phone rang.'",
      blank:"had",
      hint:"Past Perfect after 'scarcely/hardly/no sooner'.",
      expl:"'Scarcely had + subject + past participle... when...' Inverted formal literary device." },
    { id:"E231", type:"es", skill:"grammar",
      q:"Find the error in this C1 sentence:",
      text:"The manager insisted that all reports were submitted before the end of the month.",
      err:"were submitted",
      fix:"be submitted",
      expl:"After 'insist that' use subjunctive: 'be submitted'. Formal subjunctive uses base form." },
    { id:"E232", type:"mc", skill:"grammar",
      q:"'It is the quality, not the quantity, ___ impresses the jury.'",
      opts:[{t:"which",c:false},{t:"what",c:false},{t:"that",c:true},{t:"who",c:false}],
      expl:"Cleft sentence: It is + [emphasised element] + that + [rest]. 'That' in cleft sentences." },
    { id:"E233", type:"dd", skill:"grammar",
      q:"Match the C1 structure to its function:",
      drag:["Cleft sentence","Nominalization","Passive infinitive"],
      tgts:[{pfx:"It was fraud that led to the collapse.",ok:"Cleft sentence"},{pfx:"The implementation took months.",ok:"Nominalization"},{pfx:"The suspect is believed to have fled.",ok:"Passive infinitive"}],
      expl:"Cleft(focus) | Nominalization(implement→implementation) | Passive infinitive(is believed to have)" },
    { id:"E234", type:"speaking", skill:"speaking",
      q:"Use a formal inverted conditional:",
      prompt:"Had the government acted sooner, this situation could have been avoided.",
      target:"government acted sooner could avoided",
      keywords:["government","acted","sooner","avoided"],
      expl:"Formal: 'Had + subject + past participle'. 'could have been avoided' = 3rd conditional passive." },
    { id:"E235", type:"listening", skill:"listening",
      q:"Listen and identify the grammatical feature used for emphasis:",
      audio:"It was precisely her refusal to compromise that distinguished her leadership.",
      opts:[{t:"Passive voice",c:false},{t:"Cleft sentence for emphasis",c:true},{t:"Inverted conditional",c:false},{t:"Reported speech",c:false}],
      expl:"'It was + [X] + that...' = cleft sentence. Puts the spotlight on what matters most." }
  ]},

  { id:"W5Z2", name:"Nuanced Vocabulary & Register", icon:"🎭", type:"lesson", exercises:[
    { id:"E236", type:"mc", skill:"vocabulary",
      q:"What is the key difference between 'disinterested' and 'uninterested'?",
      opts:[{t:"They are perfect synonyms.",c:false},{t:"Disinterested=impartial; uninterested=bored/not interested",c:true},{t:"Uninterested=impartial; disinterested=bored",c:false},{t:"Only 'uninterested' is standard.",c:false}],
      expl:"DISINTERESTED = impartial, unbiased. UNINTERESTED = bored, not interested. Critical distinction." },
    { id:"E237", type:"fib", skill:"vocabulary",
      q:"Her ___ response — a slight smile — left everyone wondering. (mysterious)",
      blank:"enigmatic",
      hint:"Difficult to interpret; mysterious.",
      expl:"Enigmatic = mysterious, difficult to interpret. 'An enigmatic smile' = very common collocation." },
    { id:"E238", type:"mc", skill:"reading",
      q:"'The wind whispered secrets through the ancient trees.' What device is this?",
      opts:[{t:"Simile",c:false},{t:"Personification",c:true},{t:"Alliteration",c:false},{t:"Hyperbole",c:false}],
      expl:"Personification = giving human qualities to non-human things. The wind 'whispered'." },
    { id:"E239", type:"dd", skill:"vocabulary",
      q:"Match each word to the one it is most easily confused with:",
      drag:["imply","principle","affect"],
      tgts:[{pfx:"infer (confused with) →",ok:"imply"},{pfx:"principal (confused with) →",ok:"principle"},{pfx:"effect (confused with) →",ok:"affect"}],
      expl:"imply(hints) vs infer(concludes) | principle(rule) vs principal(main) | affect(verb) vs effect(noun)" },
    { id:"E240", type:"tf", skill:"vocabulary",
      q:"'Fortuitous' and 'fortunate' are exact synonyms.",
      stmt:"Fortuitous and fortunate are exact synonyms.",
      ans:false,
      expl:"Fortuitous = happening by CHANCE (good or bad). Fortunate = LUCKY (positive)." },
    { id:"E241", type:"mc", skill:"vocabulary",
      q:"Which word means 'to improve or enhance a situation'?",
      opts:[{t:"exacerbate",c:false},{t:"ameliorate",c:true},{t:"obfuscate",c:false},{t:"prevaricate",c:false}],
      expl:"Ameliorate = to make better. 'Measures to ameliorate poverty.' Opposite: exacerbate." },
    { id:"E242", type:"es", skill:"vocabulary",
      q:"Find the word used incorrectly:",
      text:"The professor's speech evoked a standing ovulation from the entire audience.",
      err:"ovulation",
      fix:"ovation",
      expl:"'Standing ovation' = prolonged applause. 'Ovulation' is a biological term. Classic malapropism." },
    { id:"E243", type:"fib", skill:"vocabulary",
      q:"Her argument was ___ — seemingly reasonable but fundamentally flawed.",
      blank:"specious",
      hint:"Superficially plausible but actually wrong.",
      expl:"Specious = appearing valid but actually fallacious. 'A specious argument' looks convincing." },
    { id:"E244", type:"mc", skill:"vocabulary",
      q:"What does 'laconic' mean when describing speech?",
      opts:[{t:"Extremely wordy",c:false},{t:"Using very few words; brief and direct",c:true},{t:"Unclear and ambiguous",c:false},{t:"Emotionally charged",c:false}],
      expl:"Laconic = brief, minimal words. From Laconia (Sparta), famous for terse speech." },
    { id:"E245", type:"dd", skill:"vocabulary",
      q:"Match each C1 adjective to its meaning:",
      drag:["recalcitrant","ephemeral","perfidious"],
      tgts:[{pfx:"Lasting only a short time →",ok:"ephemeral"},{pfx:"Stubbornly resistant to authority →",ok:"recalcitrant"},{pfx:"Deceitful and untrustworthy →",ok:"perfidious"}],
      expl:"ephemeral=fleeting | recalcitrant=stubbornly disobedient | perfidious=treacherous." },
    { id:"E246", type:"tf", skill:"vocabulary",
      q:"'Whom' can be used as a subject pronoun.",
      stmt:"Whom can be used as a subject pronoun.",
      ans:false,
      expl:"'Whom' is always OBJECTIVE. 'WHO is there?' (subject). 'To WHOM should I address this?' (object)." },
    { id:"E247", type:"mc", skill:"reading",
      q:"What is 'apophasis' as a rhetorical device?",
      opts:[{t:"A metaphor based on natural imagery",c:false},{t:"Drawing attention by claiming not to mention it",c:true},{t:"Repeating words for emphasis",c:false},{t:"An extended comparison",c:false}],
      expl:"Apophasis = mentioning something while claiming not to. 'I won't mention his record...' — you just did!" },
    { id:"E248", type:"sb", skill:"grammar",
      q:"Build a sentence using 'were + subject' (inverted subjunctive):",
      words:["Were","the","allegations","proven","true","the","consequences","would","be","severe"],
      correct:"Were the allegations proven true the consequences would be severe",
      expl:"'Were + subject + adjective/past participle' = formal conditional. Used in formal/legal texts." },
    { id:"E249", type:"speaking", skill:"speaking",
      q:"Use nuanced C1 vocabulary in context:",
      prompt:"The committee's decision was both enigmatic and perfidious, undermining years of trust.",
      target:"enigmatic perfidious trust undermining",
      keywords:["enigmatic","perfidious","trust"],
      expl:"enigmatic(mysterious) + perfidious(treacherous) + undermine(weaken). Lexical precision at C1." },
    { id:"E250", type:"listening", skill:"listening",
      q:"Listen and choose the most accurate description of the speaker's register:",
      audio:"The aforementioned stipulations notwithstanding, the board is inclined to ratify the proposal, albeit with considerable reservations.",
      opts:[{t:"Informal and conversational",c:false},{t:"Neutral and journalistic",c:false},{t:"Highly formal and legalistic",c:true},{t:"Academic but accessible",c:false}],
      expl:"'aforementioned', 'stipulations', 'notwithstanding', 'inclined to ratify', 'albeit' — all highly formal." }
  ]},

  { id:"W5Z3", name:"Rhetoric & Critical Reading", icon:"📜", type:"lesson", exercises:[
    { id:"E251", type:"mc", skill:"reading",
      q:"What is 'anaphora' in rhetoric?",
      opts:[{t:"A metaphor at the end of a speech",c:false},{t:"Repetition of a word at the start of successive clauses",c:true},{t:"An understatement for effect",c:false},{t:"A sudden change of subject",c:false}],
      expl:"Anaphora = repetition at the START of clauses. MLK: 'I have a dream... I have a dream...'" },
    { id:"E252", type:"fib", skill:"vocabulary",
      q:"The text is a ___ of post-colonial anxiety, bearing traces of earlier texts. (layered text)",
      blank:"palimpsest",
      hint:"A manuscript rewritten over; bearing traces of earlier forms.",
      expl:"Palimpsest = parchment reused after erasure. Figuratively: any text with layered history." },
    { id:"E253", type:"mc", skill:"reading",
      q:"What is an 'extended metaphor'?",
      opts:[{t:"A metaphor spanning one sentence",c:false},{t:"A metaphor developed throughout a text",c:true},{t:"A metaphor combining simile and personification",c:false},{t:"A self-contradicting metaphor",c:false}],
      expl:"Extended metaphor = sustained comparison developed across multiple sentences or an entire text." },
    { id:"E254", type:"es", skill:"grammar",
      q:"Find the subtle error:",
      text:"The findings strongly infer that aerobic exercise mitigates cognitive decline.",
      err:"infer",
      fix:"imply",
      expl:"Findings IMPLY (suggest). Only people can INFER (draw a conclusion). Data/findings always 'imply'." },
    { id:"E255", type:"dd", skill:"reading",
      q:"Match each rhetorical device to its definition:",
      drag:["Litotes","Chiasmus","Synecdoche"],
      tgts:[{pfx:"Understatement using negation →",ok:"Litotes"},{pfx:"Inverted parallel structure (AB-BA) →",ok:"Chiasmus"},{pfx:"Part represents the whole →",ok:"Synecdoche"}],
      expl:"Litotes('not bad'=good) | Chiasmus(AB-BA structure) | Synecdoche('All hands on deck'=all people)" },
    { id:"E256", type:"tf", skill:"reading",
      q:"'Irony' always involves saying the opposite of what you mean.",
      stmt:"Irony always involves saying the opposite of what you mean.",
      ans:false,
      expl:"Verbal irony = opposite meaning. But also: situational irony and dramatic irony exist." },
    { id:"E257", type:"mc", skill:"reading",
      q:"What does 'circumlocution' mean?",
      opts:[{t:"Speaking precisely",c:false},{t:"Using many words to express what could be said simply",c:true},{t:"Making a circular argument",c:false},{t:"Speaking about abstract concepts",c:false}],
      expl:"Circumlocution = roundabout language. 'At this present moment in time' = now." },
    { id:"E258", type:"listening", skill:"listening",
      q:"Listen and identify the rhetorical device:",
      audio:"We shall fight on the beaches, we shall fight on the landing grounds, we shall fight in the fields and in the streets.",
      opts:[{t:"Anaphora — repetition of 'we shall fight'",c:true},{t:"Epistrophe — repetition at the end",c:false},{t:"Chiasmus — inverted parallel structure",c:false},{t:"Litotes — understatement",c:false}],
      expl:"Churchill's ANAPHORA: 'we shall fight' repeated at the start of each clause." },
    { id:"E259", type:"mc", skill:"reading",
      q:"'She was not a little upset' uses which device?",
      opts:[{t:"Hyperbole",c:false},{t:"Litotes",c:true},{t:"Metaphor",c:false},{t:"Allusion",c:false}],
      expl:"Litotes = understatement via negation. 'Not a little upset' = very upset." },
    { id:"E260", type:"fib", skill:"vocabulary",
      q:"'The pen is mightier than the sword' is an example of ___.",
      blank:"metonymy",
      hint:"Using one thing to represent something associated with it.",
      expl:"Metonymy: 'pen'=writing/media; 'sword'=military power." },
    { id:"E261", type:"es", skill:"reading",
      q:"Click the word that is used incorrectly:",
      text:"The poem's ambiguous ending allows readers to interpolate their own meaning.",
      err:"interpolate",
      fix:"infer",
      expl:"'Interpolate' = insert into a text. The intended word is 'infer' (draw a conclusion)." },
    { id:"E262", type:"dd", skill:"reading",
      q:"Match each type of irony to its definition:",
      drag:["Verbal irony","Dramatic irony","Situational irony"],
      tgts:[{pfx:"Saying the opposite of what you mean →",ok:"Verbal irony"},{pfx:"Audience knows more than characters →",ok:"Dramatic irony"},{pfx:"Outcome opposite to what was expected →",ok:"Situational irony"}],
      expl:"Verbal(sarcasm) | Dramatic(Romeo&Juliet) | Situational(fire station burns down)." },
    { id:"E263", type:"sb", skill:"grammar",
      q:"Build a sentence using anaphora:",
      words:["We","shall","overcome","we","shall","succeed","we","shall","endure"],
      correct:"We shall overcome we shall succeed we shall endure",
      expl:"Anaphora: 'We shall' repeated three times. Creates rhythm and emotional emphasis." },
    { id:"E264", type:"speaking", skill:"speaking",
      q:"Identify and explain a literary device. Say this:",
      prompt:"That metaphor is an example of personification, giving human qualities to an abstract concept.",
      target:"metaphor personification human abstract",
      keywords:["metaphor","personification","human","abstract"],
      expl:"C1 literary analysis: identify device + define it + explain its application." },
    { id:"E265", type:"listening", skill:"listening",
      q:"Listen and identify the type of irony:",
      audio:"After ten years and three budget overruns, the new library opened. The mayor declared it 'a triumph of efficiency'.",
      opts:[{t:"Verbal irony — mayor says the opposite of the truth",c:true},{t:"Dramatic irony — the audience knows more",c:false},{t:"Situational irony — unexpected outcome",c:false},{t:"No irony — the mayor is sincere",c:false}],
      expl:"Verbal irony: ten years + budget overruns ≠ efficient. Calling it 'a triumph' is sarcasm." }
  ]},

  { id:"W5Z4", name:"Boss Exam C1", icon:"👑", type:"boss", cefr:"C1", exercises:[
    { id:"E266", type:"es", skill:"grammar",
      q:"Find the subtle error:",
      text:"The committee's decision, while understanding, raised serious questions about its mandate.",
      err:"understanding",
      fix:"understandable",
      expl:"'Understandable' = can be understood/is reasonable. 'Understanding' = empathetic/perceptive." },
    { id:"E267", type:"mc", skill:"vocabulary",
      q:"'To prevaricate' means:",
      opts:[{t:"To speak briefly",c:false},{t:"To speak in an evasive, misleading way",c:true},{t:"To predict future events",c:false},{t:"To contradict yourself",c:false}],
      expl:"Prevaricate = to be evasive, avoid giving a direct answer. Often confused with 'procrastinate'." },
    { id:"E268", type:"fib", skill:"grammar",
      q:"'___ the evidence, the jury returned a not-guilty verdict.' (formal: despite)",
      blank:"Notwithstanding",
      hint:"Despite, in spite of (very formal).",
      expl:"Notwithstanding = despite. 'Notwithstanding the evidence...' Used in legal and formal documents." },
    { id:"E269", type:"sb", skill:"grammar",
      q:"Build a complex cleft sentence:",
      words:["It","was","the","lack","of","communication","that","ultimately","caused","the","project","to","fail"],
      correct:"It was the lack of communication that ultimately caused the project to fail",
      expl:"Cleft: 'It was + [X] + that + rest'. Emphasises 'the lack of communication' as THE cause." },
    { id:"E270", type:"listening", skill:"listening",
      q:"Listen and choose the most precise description of the argument:",
      audio:"One might contend that economic growth benefits all. However, empirical evidence suggests growth disproportionately advantages the privileged.",
      opts:[{t:"Simple agreement with the first claim",c:false},{t:"Concession + counter-argument with evidence",c:true},{t:"Two unrelated ideas",c:false},{t:"An emotional appeal with no evidence",c:false}],
      expl:"'One might contend' = presenting a claim. 'However, empirical evidence suggests' = counter + evidence." },
    { id:"E271", type:"mc", skill:"vocabulary",
      q:"'Pellucid' is closest in meaning to:",
      opts:[{t:"Confusing and unclear",c:false},{t:"Perfectly clear and easy to understand",c:true},{t:"Visually beautiful",c:false},{t:"Technically complex",c:false}],
      expl:"Pellucid = translucently clear. Figuratively: perfectly easy to understand. From Latin." },
    { id:"E272", type:"dd", skill:"vocabulary",
      q:"Match each pair of commonly confused C1 words:",
      drag:["reticent","deprecate","mitigate"],
      tgts:[{pfx:"reluctant (confused with) →",ok:"reticent"},{pfx:"depreciate (confused with) →",ok:"deprecate"},{pfx:"militate (confused with) →",ok:"mitigate"}],
      expl:"reticent=reluctant to SPEAK | deprecate=disapprove of | depreciate=decrease in value | mitigate=reduce" },
    { id:"E273", type:"tf", skill:"grammar",
      q:"'Should you require any assistance, please contact us' uses an inverted conditional.",
      stmt:"Should you require assistance uses an inverted conditional.",
      ans:true,
      expl:"Correct! 'Should + subject + verb' = inverted 1st conditional (formal). Very common in formal letters." },
    { id:"E274", type:"speaking", skill:"speaking",
      q:"Use C1 vocabulary to make a critical point:",
      prompt:"The author's specious reasoning and use of red herrings undermine the otherwise compelling argument.",
      target:"specious reasoning undermine compelling",
      keywords:["specious","reasoning","undermine","compelling"],
      expl:"specious(superficially valid but wrong) + undermine(weaken) + compelling(persuasive). C1 critique language." },
    { id:"E275", type:"es", skill:"grammar",
      q:"Find the error in this formally complex sentence:",
      text:"Were the prime minister to resign, the party would of lost its most experienced leader.",
      err:"would of",
      fix:"would have",
      expl:"'Would of' is NEVER correct — it's a misspelling of 'would've' (would have)." }
  ]}
]},
/* ══════════════════════════════════════════════════
   W6 · C2 · MASTERY SUMMIT
   ══════════════════════════════════════════════════ */
{ id:"W6", name:"Mastery Summit", cefr:"C2", icon:"🌟", zones:[

  { id:"W6Z1", name:"Idiomatic Mastery", icon:"🎨", type:"lesson", exercises:[
    { id:"E276", type:"mc", skill:"vocabulary",
      q:"'To bite the bullet' means:",
      opts:[{t:"To eat something very hard",c:false},{t:"To endure a painful situation stoically",c:true},{t:"To make a foolish decision",c:false},{t:"To fire a weapon",c:false}],
      expl:"To bite the bullet = endure pain/difficulty with courage. Origin: soldiers bit bullets during surgery without anaesthetic." },
    { id:"E277", type:"fib", skill:"vocabulary",
      q:"'She ___ the news at the last minute, leaving everyone unprepared.'",
      blank:"dropped a bombshell",
      hint:"A sudden, shocking piece of news.",
      expl:"'Drop a bombshell' = reveal shocking unexpected news. 'She dropped a bombshell by announcing her resignation.'" },
    { id:"E278", type:"dd", skill:"vocabulary",
      q:"Match each idiom to its meaning:",
      drag:["miss the boat","burn bridges","sit on the fence"],
      tgts:[{pfx:"Miss an opportunity →",ok:"miss the boat"},{pfx:"Damage relationships permanently →",ok:"burn bridges"},{pfx:"Avoid committing to a position →",ok:"sit on the fence"}],
      expl:"miss the boat(too late) | burn bridges(destroy relationships) | sit on the fence(avoid taking sides)." },
    { id:"E279", type:"tf", skill:"vocabulary",
      q:"'A blessing in disguise' means something good that seemed bad at first.",
      stmt:"A blessing in disguise means something good that seemed bad at first.",
      ans:true,
      expl:"Correct! 'Losing that job was a blessing in disguise — I found a much better one.'" },
    { id:"E280", type:"mc", skill:"vocabulary",
      q:"'To pull someone's leg' means:",
      opts:[{t:"To physically trip someone",c:false},{t:"To joke or tease someone playfully",c:true},{t:"To help someone escape",c:false},{t:"To hurt someone deliberately",c:false}],
      expl:"'Pull someone's leg' = joke, tease in a friendly way. 'Are you serious?' 'No, just pulling your leg!'" },
    { id:"E281", type:"sb", skill:"vocabulary",
      q:"Build a sentence using the 'iceberg' idiom:",
      words:["What","we","know","about","the","corruption","is","just","the","tip","of","the","iceberg"],
      correct:"What we know about the corruption is just the tip of the iceberg",
      expl:"'Tip of the iceberg' = small visible part of a much larger hidden problem." },
    { id:"E282", type:"listening", skill:"listening",
      q:"Listen and choose the correct interpretation of the idiom:",
      audio:"After months of negotiations, they finally buried the hatchet and agreed to work together.",
      opts:[{t:"They found a weapon and used it.",c:false},{t:"They made peace and ended their conflict.",c:true},{t:"They abandoned the project.",c:false},{t:"They disagreed more strongly.",c:false}],
      expl:"'Bury the hatchet' = make peace, end a conflict. Origin: Native American tradition of burying weapons to symbolise peace." },
    { id:"E283", type:"mc", skill:"vocabulary",
      q:"What does 'to have a chip on your shoulder' mean?",
      opts:[{t:"To be very skilled",c:false},{t:"To carry a grudge or feel easily offended",c:true},{t:"To be wealthy and privileged",c:false},{t:"To be very hungry",c:false}],
      expl:"Chip on shoulder = persistent resentment or inferiority. Origin: 19th-century custom of provoking fights." },
    { id:"E284", type:"fib", skill:"vocabulary",
      q:"'It was a ___ victory — we won but lost our best player.' (costly win named after a king)",
      blank:"Pyrrhic",
      hint:"Named after King Pyrrhus of Epirus, whose victories cost him too much.",
      expl:"Pyrrhic victory = a win that costs so much it's almost as bad as losing." },
    { id:"E285", type:"es", skill:"vocabulary",
      q:"Click the word used incorrectly in this idiomatic context:",
      text:"He was walking on thin water when he made that accusation in front of the board.",
      err:"water",
      fix:"ice",
      expl:"The idiom is 'walking on THIN ICE' = in a dangerous/risky situation. Precision with idioms marks C2." },
    { id:"E286", type:"dd", skill:"vocabulary",
      q:"Match each proverb to its meaning:",
      drag:["Actions speak louder than words","The early bird catches the worm","Don't judge a book by its cover"],
      tgts:[{pfx:"Appearances are misleading →",ok:"Don't judge a book by its cover"},{pfx:"What you do matters more than what you say →",ok:"Actions speak louder than words"},{pfx:"Starting early gives an advantage →",ok:"The early bird catches the worm"}],
      expl:"Proverbs encode cultural wisdom. Using them accurately signals native-like C2 fluency." },
    { id:"E287", type:"mc", skill:"vocabulary",
      q:"'She's a dark horse in this election.' What does 'dark horse' mean?",
      opts:[{t:"A dangerous and aggressive candidate",c:false},{t:"An unknown candidate who might surprisingly win",c:true},{t:"A very popular candidate",c:false},{t:"A candidate with a hidden criminal history",c:false}],
      expl:"Dark horse = an unknown who unexpectedly succeeds. Origin: horse racing, where unknown horses sometimes won." },
    { id:"E288", type:"tf", skill:"vocabulary",
      q:"'Break a leg' is an idiom meaning good luck, used especially in theatre.",
      stmt:"Break a leg means good luck, especially in theatre.",
      ans:true,
      expl:"Correct! 'Break a leg!' = good luck. Saying 'good luck' in theatre was considered bad luck, hence this superstitious alternative." },
    { id:"E289", type:"speaking", skill:"speaking",
      q:"Use two idioms naturally in one sentence:",
      prompt:"Although we missed the boat on that investment, every cloud has a silver lining.",
      target:"missed boat cloud silver lining",
      keywords:["missed","boat","cloud","silver"],
      expl:"'Miss the boat'=miss an opportunity. 'Every cloud has a silver lining'=every bad situation has a positive aspect." },
    { id:"E290", type:"listening", skill:"listening",
      q:"Listen and choose the correct meaning of the idiom:",
      audio:"The new manager really hit the ground running — she implemented three major changes in her first week.",
      opts:[{t:"She made a mistake immediately.",c:false},{t:"She started energetically and achieved results quickly.",c:true},{t:"She ran away from her responsibilities.",c:false},{t:"She started slowly and carefully.",c:false}],
      expl:"'Hit the ground running' = start immediately with great energy. Three changes in first week confirms this." }
  ]},

  { id:"W6Z2", name:"Academic Discourse & Writing", icon:"🖊️", type:"lesson", exercises:[
    { id:"E291", type:"mc", skill:"writing",
      q:"Which opening best suits a formal academic essay?",
      opts:[{t:"Nowadays everyone knows climate change is bad.",c:false},{t:"In recent decades, anthropogenic climate change has attracted considerable scholarly attention.",c:true},{t:"I'm going to talk about climate change in this essay.",c:false},{t:"Climate change: it's a really big problem!",c:false}],
      expl:"Academic essays: passive constructions, formal register, hedging language. Never 'I'm going to talk about'." },
    { id:"E292", type:"fib", skill:"writing",
      q:"'To ___ an argument' means to prove it is wrong. (more formal than 'disprove')",
      blank:"refute",
      hint:"To prove an argument is wrong.",
      expl:"Refute = prove an argument is wrong. Also: rebut, invalidate, counter, challenge." },
    { id:"E293", type:"dd", skill:"writing",
      q:"Match each academic phrase to its function:",
      drag:["It is worth noting that","This is not to say that","Taken together these findings"],
      tgts:[{pfx:"Introduce a nuance →",ok:"It is worth noting that"},{pfx:"Qualify a statement →",ok:"This is not to say that"},{pfx:"Synthesise evidence →",ok:"Taken together these findings"}],
      expl:"'It is worth noting'(nuance) | 'This is not to say'(qualify) | 'Taken together'(synthesise)." },
    { id:"E294", type:"mc", skill:"writing",
      q:"'Hedging language' in academic writing is used to:",
      opts:[{t:"Make strong certain claims",c:false},{t:"Express appropriate uncertainty and caution",c:true},{t:"Avoid taking any position",c:false},{t:"Use informal vocabulary",c:false}],
      expl:"Hedging = expressing uncertainty appropriately. 'This suggests (not proves)...' 'It appears that...' Essential in academic writing." },
    { id:"E295", type:"tf", skill:"writing",
      q:"'Furthermore' and 'Moreover' are used to ADD information, not contrast it.",
      stmt:"Furthermore and Moreover add information, they do not contrast.",
      ans:true,
      expl:"Correct! Furthermore/moreover/in addition = ADDING. Contrast: however, nevertheless, yet." },
    { id:"E296", type:"sb", skill:"writing",
      q:"Build a hedged academic claim:",
      words:["The","evidence","appears","to","suggest","that","regular","exercise","may","reduce","cognitive","decline"],
      correct:"The evidence appears to suggest that regular exercise may reduce cognitive decline",
      expl:"Double hedging: 'appears to suggest' (not 'proves') and 'may reduce' (not 'reduces'). Appropriate academic caution." },
    { id:"E297", type:"listening", skill:"listening",
      q:"Listen and identify the academic technique used:",
      audio:"While it would be an overstatement to claim technology has solved all educational challenges, it is undeniable that digital tools have transformed classroom dynamics.",
      opts:[{t:"Hyperbole and exaggeration",c:false},{t:"Hedging with a balanced concession and claim",c:true},{t:"Simple factual statement",c:false},{t:"Personal anecdote as evidence",c:false}],
      expl:"'While it would be an overstatement...' = hedging/concession. 'It is undeniable that...' = confident main claim." },
    { id:"E298", type:"mc", skill:"writing",
      q:"What is the function of a 'topic sentence' in an academic paragraph?",
      opts:[{t:"To provide detailed evidence",c:false},{t:"To introduce the main idea of the paragraph",c:true},{t:"To conclude the entire essay",c:false},{t:"To cite sources and references",c:false}],
      expl:"Topic sentence = first sentence of a paragraph stating its main idea. All other sentences develop this idea." },
    { id:"E299", type:"fib", skill:"writing",
      q:"'The author's use of metaphor ___ the emotional impact of the passage.' (makes it stronger)",
      blank:"amplifies",
      hint:"To make something stronger or more intense.",
      expl:"Amplify = intensify, increase. Also: heightens, enhances, underscores, accentuates." },
    { id:"E300", type:"es", skill:"writing",
      q:"Click the phrase that breaks academic register:",
      text:"The study demonstrates a clear correlation between socioeconomic status and educational attainment which is really interesting.",
      err:"really interesting",
      fix:"noteworthy",
      expl:"'Really interesting' = informal. Academic: 'noteworthy', 'significant', 'of particular interest'. Never 'really' in academic writing." },
    { id:"E301", type:"dd", skill:"writing",
      q:"Match each citation phrase to its function:",
      drag:["According to","As demonstrated by","It has been argued that"],
      tgts:[{pfx:"Attribute a fact to a source →",ok:"According to"},{pfx:"Use evidence as proof →",ok:"As demonstrated by"},{pfx:"Present a position with possible disagreement →",ok:"It has been argued that"}],
      expl:"According to(attribution) | As demonstrated by(proof) | It has been argued that(distanced claim)." },
    { id:"E302", type:"tf", skill:"writing",
      q:"In academic writing, the conclusion should introduce new arguments not in the body.",
      stmt:"The conclusion should introduce new arguments.",
      ans:false,
      expl:"Incorrect! The conclusion should SUMMARISE and synthesise. New arguments in conclusions confuse readers." },
    { id:"E303", type:"mc", skill:"writing",
      q:"Which word best fills: 'The results ___ the initial hypothesis, requiring further investigation.'",
      opts:[{t:"confirmed",c:false},{t:"contradicted",c:false},{t:"problematised",c:true},{t:"deleted",c:false}],
      expl:"'Problematised' = made more complex, raised questions about. Shows nuanced thinking at C2." },
    { id:"E304", type:"speaking", skill:"speaking",
      q:"Open an academic argument formally. Say this:",
      prompt:"It has been argued that globalisation disproportionately benefits developed nations, notwithstanding the opportunities it creates for emerging economies.",
      target:"globalisation disproportionately notwithstanding emerging",
      keywords:["globalisation","disproportionately","notwithstanding","emerging"],
      expl:"C2 academic opener: distanced claim + complex adverb + concession. Sophisticated discourse at the highest level." },
    { id:"E305", type:"listening", skill:"listening",
      q:"Listen and choose the best description of the discourse structure:",
      audio:"It would be remiss to overlook the socioeconomic dimensions of this debate. That said, the cultural factors, while significant, must be considered within a broader systemic framework.",
      opts:[{t:"Simple two-sided argument",c:false},{t:"Layered argument acknowledging complexity while establishing a hierarchy of factors",c:true},{t:"Straightforward rejection of one view",c:false},{t:"Informal personal opinion",c:false}],
      expl:"'Remiss to overlook' + 'That said' + 'while significant, within a broader framework' = complex layered argumentation." }
  ]},

  { id:"W6Z3", name:"Precision, Nuance & Mastery", icon:"💎", type:"lesson", exercises:[
    { id:"E306", type:"mc", skill:"vocabulary",
      q:"What is the difference between 'credulous' and 'credible'?",
      opts:[{t:"They are synonyms — both mean believable.",c:false},{t:"Credulous=too ready to believe; credible=believable/trustworthy",c:true},{t:"Credible=gullible; credulous=worthy of trust",c:false},{t:"Both mean untrustworthy.",c:false}],
      expl:"Credulous = too easily believing (gullible). Credible = worthy of belief, trustworthy. Often confused at C2." },
    { id:"E307", type:"fib", skill:"vocabulary",
      q:"'The report was ___ — full of jargon and impossible to understand.' (excessively complex)",
      blank:"abstruse",
      hint:"Difficult to understand because of excessive complexity.",
      expl:"Abstruse = unnecessarily complicated. 'An abstruse philosophical treatise.' From Latin abstrusus (hidden away)." },
    { id:"E308", type:"dd", skill:"vocabulary",
      q:"Match each precise C2 word to its nuanced meaning:",
      drag:["taciturn","garrulous","loquacious"],
      tgts:[{pfx:"Tends to use very few words →",ok:"taciturn"},{pfx:"Excessively talkative and rambling →",ok:"garrulous"},{pfx:"Tending to talk a great deal →",ok:"loquacious"}],
      expl:"taciturn(habitually silent) | garrulous(annoyingly talkative) | loquacious(talkative, not necessarily annoying). Nuance matters at C2!" },
    { id:"E309", type:"es", skill:"vocabulary",
      q:"Click the word used imprecisely:",
      text:"The politician's speech was intentionally ambivalent, designed to appeal to all voters without committing to any policy.",
      err:"ambivalent",
      fix:"ambiguous",
      expl:"AMBIGUOUS = open to multiple interpretations. AMBIVALENT = having mixed feelings. Speech was ambiguous (deliberately unclear)." },
    { id:"E310", type:"mc", skill:"vocabulary",
      q:"'Tendentious' writing is best described as:",
      opts:[{t:"Accurate and objective",c:false},{t:"Promoting a particular viewpoint; not impartial",c:true},{t:"Related to medical tendons",c:false},{t:"Extremely difficult to read",c:false}],
      expl:"Tendentious = promoting a particular point of view; biased towards a cause. 'Tendentious journalism' = pushing an agenda." },
    { id:"E311", type:"tf", skill:"vocabulary",
      q:"'Enervate' means to give energy to someone.",
      stmt:"Enervate means to give energy to someone.",
      ans:false,
      expl:"Common trap! ENERVATE = to DRAIN of energy, to weaken. NOT to energise. 'The heat enervated the workers.'" },
    { id:"E312", type:"mc", skill:"reading",
      q:"What is 'bathos' in literary writing?",
      opts:[{t:"A climactic moment of great emotion",c:false},{t:"An anticlimactic shift from the elevated to the trivial",c:true},{t:"An extended metaphor comparing two unlike things",c:false},{t:"The use of sound to convey meaning",c:false}],
      expl:"Bathos = sudden descent from the sublime to the ridiculous. 'She suffered tragedy — and then burnt her toast.'" },
    { id:"E313", type:"fib", skill:"vocabulary",
      q:"'Her response was marked by an almost ___ attention to irrelevant detail.' (excessively concerned with minutiae)",
      blank:"pedantic",
      hint:"Excessively concerned with minor details and rules.",
      expl:"Pedantic = excessively focused on minor details or formal correctness. 'A pedantic professor' corrects trivial errors." },
    { id:"E314", type:"dd", skill:"vocabulary",
      q:"Match each literary term to its definition:",
      drag:["hubris","catharsis","hamartia"],
      tgts:[{pfx:"Excessive pride leading to downfall →",ok:"hubris"},{pfx:"Emotional release through art →",ok:"catharsis"},{pfx:"Fatal flaw in a tragic hero →",ok:"hamartia"}],
      expl:"hubris(excessive pride→nemesis) | catharsis(emotional release through tragedy) | hamartia(hero's fatal flaw). Greek tragic theory." },
    { id:"E315", type:"mc", skill:"vocabulary",
      q:"'Solecism' refers to:",
      opts:[{t:"A grammatical error only",c:false},{t:"A social breach only",c:false},{t:"Both a grammatical error and a social breach, depending on context",c:true},{t:"A rhetorical device",c:false}],
      expl:"Solecism = (1) grammatical error ('I seen him') (2) a social blunder. Both uses are correct. From Soli, a Greek colony known for poor Greek." },
    { id:"E316", type:"es", skill:"grammar",
      q:"Find the logical or grammatical error in this formal claim:",
      text:"The lack of evidence for the theory do not necessarily mean the theory is false.",
      err:"do not",
      fix:"does not",
      expl:"'The lack' = singular subject → 'does not'. Don't be distracted by 'evidence' — 'lack' is the head noun." },
    { id:"E317", type:"sb", skill:"grammar",
      q:"Build a sentence with precise C2 vocabulary:",
      words:["Her","garrulous","nature","notwithstanding","she","was","capable","of","moments","of","pellucid","clarity"],
      correct:"Her garrulous nature notwithstanding she was capable of moments of pellucid clarity",
      expl:"garrulous(excessively talkative) + notwithstanding(despite) + pellucid(crystal clear). C2 precision in lexis and grammar." },
    { id:"E318", type:"tf", skill:"vocabulary",
      q:"'Obstreperous' and 'obstinate' mean the same thing.",
      stmt:"Obstreperous and obstinate mean the same thing.",
      ans:false,
      expl:"OBSTINATE = stubbornly refusing to change one's mind. OBSTREPEROUS = noisily resisting control; rowdy. Related but distinct." },
    { id:"E319", type:"speaking", skill:"speaking",
      q:"Use precise C2 vocabulary to critique a text. Say this:",
      prompt:"The tendentious and abstruse nature of the report undermines its credibility with a general readership.",
      target:"tendentious abstruse undermines credibility",
      keywords:["tendentious","abstruse","undermines","credibility"],
      expl:"tendentious(biased) + abstruse(unnecessarily complex) + undermine(weaken) + credibility(trustworthiness). Precision defines C2 mastery." },
    { id:"E320", type:"listening", skill:"listening",
      q:"Listen and choose the most precise interpretation:",
      audio:"The minister's position was, to put it charitably, ambiguous — what some would call strategic, others mere obfuscation.",
      opts:[{t:"The minister was clearly committed to the policy.",c:false},{t:"The minister's deliberate vagueness could be seen as strategy or deception.",c:true},{t:"The minister was confused about the policy.",c:false},{t:"The minister changed position during the speech.",c:false}],
      expl:"'Charitably, ambiguous' = being kind about vagueness. 'Strategic'(positive spin) vs 'obfuscation'(hiding truth). Two readings of deliberate vagueness." }
  ]},

  { id:"W6Z4", name:"Boss Exam C2", icon:"👑", type:"boss", cefr:"C2", exercises:[
    { id:"E321", type:"mc", skill:"vocabulary",
      q:"'Perspicacious' is closest in meaning to:",
      opts:[{t:"Excessively cautious and slow",c:false},{t:"Having a ready insight into things; shrewd",c:true},{t:"Unnecessarily verbose",c:false},{t:"Deliberately obscure",c:false}],
      expl:"Perspicacious = having sharp, perceptive insight. 'A perspicacious observer' quickly grasps what others miss. From Latin perspicax (sharp-sighted)." },
    { id:"E322", type:"fib", skill:"vocabulary",
      q:"'The editor demanded a more ___ prose style — every unnecessary word cut.' (concise and elegant)",
      blank:"lapidary",
      hint:"Engraved in stone; hence concise, precise and finely crafted.",
      expl:"Lapidary = (of written style) concise and elegantly expressed. 'A lapidary sentence' is gem-like in its precision." },
    { id:"E323", type:"es", skill:"grammar",
      q:"Click the subtle error in this C2 sentence:",
      text:"The extent to which globalisation exacerbates inequality remains a matter of considerable scholarly debate, as does it's effects on cultural homogenisation.",
      err:"it's",
      fix:"its",
      expl:"'it's' = it is (contraction). 'its' = possessive. 'its effects' needs the possessive form. Classic error even at advanced levels." },
    { id:"E324", type:"mc", skill:"reading",
      q:"What is 'ekphrasis' in literary writing?",
      opts:[{t:"A type of metaphor comparing unlike things",c:false},{t:"A written description of a visual work of art",c:true},{t:"A sudden change of narrator",c:false},{t:"An address to an absent person",c:false}],
      expl:"Ekphrasis = a vivid, detailed literary description of a visual artwork. Keats's 'Ode on a Grecian Urn' is a famous example." },
    { id:"E325", type:"sb", skill:"grammar",
      q:"Build a complex formal argument opener:",
      words:["Notwithstanding","the","prevailing","consensus","one","must","not","discount","the","possibility","that","alternative","interpretations","remain","valid"],
      correct:"Notwithstanding the prevailing consensus one must not discount the possibility that alternative interpretations remain valid",
      expl:"Notwithstanding(despite) + prevailing consensus(dominant view) + not discount(consider) + alternative interpretations. Full C2 academic hedging." },
    { id:"E326", type:"listening", skill:"listening",
      q:"Listen and identify the precise rhetorical technique:",
      audio:"The Prime Minister, never one to shy away from understatement, described the economic collapse as 'a slight inconvenience'.",
      opts:[{t:"Hyperbole — deliberate exaggeration",c:false},{t:"Litotes — understatement via negation",c:false},{t:"Meiosis — deliberate understatement for ironic effect",c:true},{t:"Anaphora — repetition at the start of clauses",c:false}],
      expl:"Meiosis = deliberate understatement (distinct from litotes). Describing an economic collapse as 'a slight inconvenience' is ironic meiosis. Note: 'never one to shy away from understatement' = ironic frame." },
    { id:"E327", type:"mc", skill:"vocabulary",
      q:"What does 'tmesis' describe in linguistics?",
      opts:[{t:"The repetition of a word at the end of clauses",c:false},{t:"Inserting a word into the middle of another word or phrase",c:true},{t:"A grammatical error in subject-verb agreement",c:false},{t:"The use of sound symbolism",c:false}],
      expl:"Tmesis = inserting a word into another: 'abso-blooming-lutely', 'un-freaking-believable'. Common in informal English, fascinating to linguists." },
    { id:"E328", type:"dd", skill:"vocabulary",
      q:"Match each precise C2 term to its correct definition:",
      drag:["verisimilitude","pastiche","polyphony"],
      tgts:[{pfx:"The quality of appearing true or real →",ok:"verisimilitude"},{pfx:"A work imitating another's style →",ok:"pastiche"},{pfx:"Multiple distinct voices or themes →",ok:"polyphony"}],
      expl:"verisimilitude(appearing real) | pastiche(stylistic imitation) | polyphony(many voices, from music to literature). Advanced literary/critical vocabulary." },
    { id:"E329", type:"tf", skill:"vocabulary",
      q:"'Sycophantic' behaviour means offering sincere, well-deserved praise.",
      stmt:"Sycophantic behaviour means offering sincere, well-deserved praise.",
      ans:false,
      expl:"Sycophantic = excessively and insincerely flattering, especially to gain personal advantage. 'A sycophantic assistant' praises the boss to gain favour, not out of genuine admiration." },
    { id:"E330", type:"speaking", skill:"speaking",
      q:"Use C2 precision to express a nuanced critical position:",
      prompt:"The perspicacious reader will detect a tension between the author's stated intentions and the tendentious subtext of the narrative.",
      target:"perspicacious tension tendentious subtext narrative",
      keywords:["perspicacious","tension","tendentious","subtext"],
      expl:"perspicacious(sharply perceptive) + tension(conflict) + tendentious(promoting a hidden agenda) + subtext(underlying meaning). Full C2 literary-critical register." }
  ]}
]}

]};/* end DB */

/* ═══════════════════════════════════════════════════════════
   SHOP DB  (condensed)
   ═══════════════════════════════════════════════════════════ */
const SHOP = [
  { id:"sk-default", name:"Classic Bull",  desc:"Your original avatar.",       price:0,   emoji:"🐂", css:"sk-default" },
  { id:"sk-hacker",  name:"Hacker Cap",    desc:"Code your way to fluency.",   price:80,  emoji:"👨‍💻", css:"sk-hacker" },
  { id:"sk-fire",    name:"Fire Scholar",  desc:"Burning with vocabulary.",    price:120, emoji:"🦊", css:"sk-fire" },
  { id:"sk-ocean",   name:"Ocean Mind",    desc:"Deep as the sea, calm too.",  price:180, emoji:"🐋", css:"sk-ocean" },
];

/* ═══════════════════════════════════════════════════════════
   SESSION  (6 radar skills: vocab, grammar, reading,
   listening, speaking, writing)
   ═══════════════════════════════════════════════════════════ */
let S = {
  profile:  { name:"", skin:"sk-default", joined: new Date().toISOString().split("T")[0] },
  eco:      { coins:150, xp:0 },
  radar:    { vocabulary:18, grammar:14, reading:12, listening:10, speaking:8, writing:10 },
  prog:     { worlds:["W1"], zones:[], stars:{}, weak:[] },
  inv:      { skins:["sk-default"] },
  bots:     null
};

/* ═══════════════════════════════════════════════════════════
   STORE
   ═══════════════════════════════════════════════════════════ */
const Store = {
  K:"bull_v6",
  save() {
    try { localStorage.setItem(this.K, btoa(unescape(encodeURIComponent(JSON.stringify(S))))); }
    catch(e) {}
  },
  load() {
    try {
      const r = localStorage.getItem(this.K);
      if (!r) return false;
      const p = JSON.parse(decodeURIComponent(escape(atob(r))));
      if (!p || !p.profile) return false;
      S.profile = Object.assign({}, S.profile, p.profile || {});
      S.eco     = Object.assign({}, S.eco,     p.eco     || {});
      S.radar   = Object.assign({}, S.radar,   p.radar   || {});
      S.prog    = Object.assign({}, S.prog,    p.prog    || {});
      S.inv     = Object.assign({}, S.inv,     p.inv     || {});
      if (p.bots) S.bots = p.bots;
      return true;
    } catch(e) { return false; }
  }
};

/* ═══════════════════════════════════════════════════════════
   AUDIO
   ═══════════════════════════════════════════════════════════ */
const Aud = {
  ctx: null,
  init() { try { this.ctx = new(window.AudioContext || window.webkitAudioContext)(); } catch(e) {} },
  _t(f, d, type="sine", v=.18) {
    if (!this.ctx) return;
    try {
      const o = this.ctx.createOscillator(), g = this.ctx.createGain();
      o.connect(g); g.connect(this.ctx.destination);
      o.type = type; o.frequency.setValueAtTime(f, this.ctx.currentTime);
      g.gain.setValueAtTime(v, this.ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(.001, this.ctx.currentTime + d);
      o.start(); o.stop(this.ctx.currentTime + d);
    } catch(e) {}
  },
  ok()   { this._t(520,.09); setTimeout(()=>this._t(660,.09),95); setTimeout(()=>this._t(790,.2),190); },
  ng()   { this._t(200,.15,"sawtooth",.12); setTimeout(()=>this._t(150,.2,"sawtooth",.08),160); },
  done() { [520,660,790,1050].forEach((f,i)=>setTimeout(()=>this._t(f,.18),i*95)); },
  coin() { this._t(1050,.07); setTimeout(()=>this._t(1320,.12),70); }
};

/* ═══════════════════════════════════════════════════════════
   TOAST + COIN FX
   ═══════════════════════════════════════════════════════════ */
function toast(msg, cls="t-inf", ms=2700) {
  const b = document.getElementById("toast-box");
  const el = document.createElement("div");
  el.className = "toast " + cls;
  const icons = {"t-ok":"✅","t-err":"❌","t-inf":"ℹ️","t-gold":"🪙"};
  el.innerHTML = `<span>${icons[cls]||"•"}</span><span>${msg}</span>`;
  b.appendChild(el);
  setTimeout(() => { el.style.opacity="0"; el.style.transform="translateY(-8px)"; setTimeout(()=>el.remove(),350); }, ms);
}

function coinFx(amt, x, y) {
  const el = document.createElement("div");
  el.className = "coin-fx";
  el.textContent = `+${amt}🪙`;
  el.style.left = (x - 28) + "px";
  el.style.top  = (y - 18) + "px";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

/* ═══════════════════════════════════════════════════════════
   ROUTER  ← THE FIX: pure .scr/.active, no ID overrides
   ═══════════════════════════════════════════════════════════ */
const Router = {
  cur: null, prev: null,
  init() {
    document.querySelectorAll(".nb[data-t]").forEach(b => {
      b.addEventListener("click", () => this.go(b.dataset.t));
    });
  },
  go(id) {
    if (this.cur === id) return;
    this.prev = this.cur;
    document.querySelectorAll(".scr").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (!el) { console.error("Screen not found:", id); return; }
    el.classList.add("active");
    el.scrollTop = 0;
    this.cur = id;
    document.querySelectorAll(".nb").forEach(b => b.classList.toggle("on", b.dataset.t === id));
    ({
      "s-map":  () => MapS.render(),
      "s-gym":  () => GymS.render(),
      "s-pro":  () => ProS.render(),
      "s-shop": () => ShopS.render(),
      "s-rank": () => RankS.render()
    })[id]?.();
  },
  openEx(zone) {
    document.getElementById("nav").classList.add("off");
    document.getElementById("user-chip").classList.add("off");
    Ex.start(zone, false);
    this.go("s-ex");
  },
  closeEx() {
    document.getElementById("nav").classList.remove("off");
    if (S.profile.name) document.getElementById("user-chip").classList.remove("off");
    // Stop any speech
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    if (Ex._recog) { try { Ex._recog.stop(); } catch(e){} }
    this.go(this.prev || "s-map");
  }
};

/* ═══════════════════════════════════════════════════════════
   MAP SCREEN
   ═══════════════════════════════════════════════════════════ */
const MapS = {
  render() {
    document.getElementById("hc-map").textContent = S.eco.coins;
    document.getElementById("hx-map").textContent = S.eco.xp;
    const body = document.getElementById("map-body");
    body.innerHTML = "";
    const wCls = { A1:"w-a1", B1:"w-b1", C1:"w-c1", A2:"w-a1", B2:"w-b1", C2:"w-c1" };

    DB.worlds.forEach((world, wi) => {
      const unlocked = S.prog.worlds.includes(world.id);
      const done = world.zones.filter(z => S.prog.zones.includes(z.id)).length;

      const card = document.createElement("div");
      card.className = `world-card ${wCls[world.cefr]||"w-a1"}`;

      const head = document.createElement("div");
      head.className = "world-head";
      head.innerHTML = `
        <div class="world-gem">${unlocked ? world.icon : "🔒"}</div>
        <div class="world-info">
          <div class="world-name">${unlocked ? world.name : "🔒 " + world.name}</div>
          <div class="world-cefr">${world.cefr} Level · ${done}/${world.zones.length} zones complete</div>
        </div>
        <span class="world-chev">▾</span>`;

      const zonesDiv = document.createElement("div");
      zonesDiv.className = "world-zones";

      world.zones.forEach((zone, zi) => {
        const prevDone = zi === 0 || S.prog.zones.includes(world.zones[zi-1].id);
        const lck = !unlocked || !prevDone;
        const zdone = S.prog.zones.includes(zone.id);
        const stars = S.prog.stars[zone.id] || 0;
        const boss = zone.type === "boss";
        const starsStr = zdone ? "⭐".repeat(stars) + "☆".repeat(3-stars) : lck ? "" : "☆☆☆";

        const row = document.createElement("div");
        row.className = "zone-row" + (lck?" lck":"") + (zdone?" done":"") + (boss?" boss-zone":"");
        row.innerHTML = `
          <div class="zone-ico">${lck ? "🔒" : zone.icon}</div>
          <div class="zone-info">
            <div class="zone-name">${zone.name}</div>
            <div class="zone-sub">${zone.exercises.length} exercises · ${boss ? "👑 Boss Exam" : "Lesson"}</div>
          </div>
          <div class="zone-stars">${starsStr}</div>`;

        if (!lck) row.addEventListener("click", () => Router.openEx(zone));
        else row.addEventListener("click", () => toast("Complete the previous zone first!", "t-inf"));
        zonesDiv.appendChild(row);
      });

      head.addEventListener("click", () => {
        if (!unlocked) { toast("Complete the previous world to unlock!", "t-inf"); return; }
        card.classList.toggle("open");
      });

      card.appendChild(head);
      card.appendChild(zonesDiv);
      body.appendChild(card);

      // Auto-open first incomplete unlocked world
      if (unlocked && done < world.zones.length) {
        const anyPrevComplete = wi === 0 || S.prog.zones.includes(DB.worlds[wi-1].zones[DB.worlds[wi-1].zones.length-1].id);
        if (anyPrevComplete) card.classList.add("open");
      }
    });
  }
};

/* ═══════════════════════════════════════════════════════════
   EXERCISE ENGINE
   ═══════════════════════════════════════════════════════════ */
const Ex = {
  zone:null, exs:[], idx:0, lives:3, ML:3,
  nOk:0, tot:0, sXP:0, sCN:0, ans:false, gym:false,
  _recog: null,
  _synth: null,

  /* flat exercise map */
  _exMap: null,
  getExMap() {
    if (!this._exMap) {
      this._exMap = {};
      DB.worlds.forEach(w => w.zones.forEach(z => z.exercises.forEach(e => { this._exMap[e.id] = e; })));
    }
    return this._exMap;
  },

  start(zone, gym=false) {
    this.zone=zone; this.exs=[...zone.exercises]; this.idx=0;
    this.lives=this.ML; this.nOk=0; this.tot=0;
    this.sXP=0; this.sCN=0; this.ans=false; this.gym=gym;
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    this.render();
  },

  render() {
    if (this.idx >= this.exs.length) { this._showDone(); return; }
    const ex = this.exs[this.idx];
    this.ans = false; this.tot++;

    const pct = (this.idx / this.exs.length) * 100;
    document.getElementById("ep-fill").style.width = pct + "%";
    document.getElementById("ep-lbl").textContent = `${this.idx+1} / ${this.exs.length}`;
    document.getElementById("ex-lives").textContent = "❤️".repeat(this.lives) + "🖤".repeat(this.ML - this.lives);

    const body = document.getElementById("ex-body");
    body.innerHTML = "";

    // Skill tag + question
    const qw = document.createElement("div");
    qw.className = "ex-q-wrap";
    qw.innerHTML = `
      <div><span class="stag sk-${ex.skill}">${this._ski(ex.skill)} ${ex.skill}</span></div>
      <p class="ex-q">${ex.q}</p>`;
    body.appendChild(qw);

    const con = document.createElement("div");
    con.className = "ex-con"; con.id = "ex-con";
    body.appendChild(con);

    // Route to type renderer
    const map = { mc:this._mc, dd:this._dd, sb:this._sb, fib:this._fib, tf:this._tf, es:this._es, listening:this._listening, speaking:this._speaking };
    (map[ex.type] || this._mc).call(this, ex, con);

    // Feedback & Next
    const fb = document.createElement("div");
    fb.id = "ex-fb"; fb.className = "ex-fb";
    fb.innerHTML = `<div class="fb-top"><span class="fb-icon" id="fb-ico"></span><span class="fb-title" id="fb-tit"></span></div>
      <div class="fb-body" id="fb-body"></div><div class="fb-rew" id="fb-rew"></div>`;
    body.appendChild(fb);

    const nb = document.createElement("button");
    nb.className = "btn-next"; nb.id = "ex-nxt";
    nb.textContent = this.idx + 1 >= this.exs.length ? "🏁 Finish!" : "Continue →";
    nb.addEventListener("click", () => { this.idx++; this.render(); });
    body.appendChild(nb);
  },

  _ski(s) {
    return { vocabulary:"📖", grammar:"🔤", reading:"👁️", listening:"👂", speaking:"🎤", writing:"✍️" }[s] || "📚";
  },

  /* ── MULTIPLE CHOICE ── */
  _mc(ex, con) {
    const L = ["A","B","C","D"];
    ex.opts.forEach((o, i) => {
      const btn = document.createElement("button");
      btn.className = "mc-opt";
      btn.innerHTML = `<span class="mc-letter">${L[i]}</span><span>${o.t}</span>`;
      btn.addEventListener("click", ev => {
        if (this.ans) return;
        this.ans = true;
        con.querySelectorAll(".mc-opt").forEach(b => b.disabled = true);
        if (o.c) { btn.classList.add("cor"); this._cor(ex, ev.clientX, ev.clientY); }
        else {
          btn.classList.add("wrg");
          con.querySelectorAll(".mc-opt").forEach((b, j) => { if (ex.opts[j]?.c) b.classList.add("cor"); });
          this._wrg(ex);
        }
      });
      con.appendChild(btn);
    });
  },

  /* ── TRUE / FALSE ── */
  _tf(ex, con) {
    const stmt = document.createElement("p");
    stmt.className = "tf-stmt"; stmt.textContent = `"${ex.stmt}"`;
    con.appendChild(stmt);
    const wrap = document.createElement("div");
    wrap.className = "tf-wrap";
    const tBtn = document.createElement("button"), fBtn = document.createElement("button");
    tBtn.className = "tf-btn tf-t"; tBtn.innerHTML = "✓ TRUE";
    fBtn.className = "tf-btn tf-f"; fBtn.innerHTML = "✗ FALSE";
    const h = a => {
      if (this.ans) return; this.ans = true;
      tBtn.disabled = fBtn.disabled = true;
      if (a === ex.ans) { (a ? tBtn : fBtn).classList.add("cor"); this._cor(ex, 0, 0); }
      else { (a ? tBtn : fBtn).classList.add("wrg"); (ex.ans ? tBtn : fBtn).classList.add("cor"); this._wrg(ex); }
    };
    tBtn.addEventListener("click", () => h(true));
    fBtn.addEventListener("click", () => h(false));
    wrap.appendChild(tBtn); wrap.appendChild(fBtn); con.appendChild(wrap);
  },

  /* ── FILL IN BLANK ── */
  _fib(ex, con) {
    const hint = document.createElement("p");
    hint.className = "fib-hint"; hint.textContent = "💡 " + ex.hint;
    const inp = document.createElement("input");
    inp.className = "fib-inp"; inp.placeholder = "Type your answer…";
    inp.autocomplete = "off"; inp.spellcheck = false;
    const btn = document.createElement("button");
    btn.className = "btn-check"; btn.textContent = "✓ Check Answer";
    btn.addEventListener("click", () => {
      if (this.ans) return;
      const v = inp.value.trim().toLowerCase();
      const oks = ex.blank.toLowerCase().split("/").map(x => x.trim());
      this.ans = true;
      if (oks.includes(v)) { inp.classList.add("cor"); this._cor(ex, 0, 0); }
      else { inp.classList.add("wrg"); inp.value = ex.blank; this._wrg(ex); }
    });
    inp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
    con.appendChild(hint); con.appendChild(inp); con.appendChild(btn);
  },

  /* ════════════════════════════════════════
     DRAG & DROP  — FIX
     Uses chipId (unique per element) not word text.
     ════════════════════════════════════════ */
  _dd(ex, con) {
    // Pool of draggable chips
    const pool = document.createElement("div");
    pool.className = "dd-pool";

    let dragId = null; // currently dragged chipId

    // Shuffle
    const shuffled = [...ex.drag].sort(() => Math.random() - .5);

    shuffled.forEach((word, i) => {
      const chipId = `chip_${i}`;
      const chip = document.createElement("div");
      chip.className = "chip chip-word";
      chip.textContent = word;
      chip.dataset.chipId = chipId;
      chip.dataset.word = word;
      chip.draggable = true;

      chip.addEventListener("dragstart", e => {
        dragId = chipId;
        chip.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", chipId + "|" + word);
      });
      chip.addEventListener("dragend", () => {
        chip.classList.remove("dragging");
      });
      // Touch: click to cycle through unfilled zones
      chip.addEventListener("click", () => {
        if (this.ans || chip.classList.contains("used")) return;
        const zones = con.querySelectorAll(".dd-zone:not([data-filled])");
        if (zones.length === 0) return;
        const zone = zones[0];
        this._fillZone(zone, chip, word, chipId, con, ex);
      });

      pool.appendChild(chip);
    });

    con.appendChild(pool);

    // Drop targets
    const tgtsDiv = document.createElement("div");
    tgtsDiv.className = "dd-targets";

    ex.tgts.forEach((t, ti) => {
      const row = document.createElement("div");
      row.className = "dd-row";
      row.innerHTML = `<span class="dd-pfx">${t.pfx}</span>`;

      const zone = document.createElement("div");
      zone.className = "dd-zone";
      zone.dataset.ok = t.ok;
      zone.dataset.idx = ti;
      zone.textContent = "Drop here";

      zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("over"); });
      zone.addEventListener("dragleave", () => zone.classList.remove("over"));
      zone.addEventListener("drop", e => {
        e.preventDefault();
        zone.classList.remove("over");
        if (zone.dataset.filled) return;
        const payload = e.dataTransfer.getData("text/plain");
        const [cId, word] = payload.split("|");
        const chip = pool.querySelector(`[data-chip-id="${cId}"]`);
        if (chip) this._fillZone(zone, chip, word, cId, con, ex);
      });

      row.appendChild(zone);
      tgtsDiv.appendChild(row);
    });
    con.appendChild(tgtsDiv);
  },

  _fillZone(zone, chip, word, chipId, con, ex) {
    zone.dataset.filled = chipId;
    zone.dataset.filledWord = word;
    zone.textContent = word;
    zone.classList.add("filled");
    chip.classList.add("used");
    chip.draggable = false;

    // Check if all zones are filled
    const allZones = Array.from(con.querySelectorAll(".dd-zone"));
    if (!allZones.every(z => z.dataset.filled)) return;
    if (this.ans) return;
    this.ans = true;

    let allOk = true;
    allZones.forEach(z => {
      if ((z.dataset.filledWord || "") !== z.dataset.ok) {
        allOk = false;
        z.classList.remove("filled");
        z.classList.add("bad");
      }
    });
    allOk ? this._cor(ex, 0, 0) : this._wrg(ex);
  },

  /* ════════════════════════════════════════
     SENTENCE BUILDER — FIX
     Each word chip has a unique slotId.
     Placed tracks {slotId, word} pairs.
     ════════════════════════════════════════ */
  _sb(ex, con) {
    const zone = document.createElement("div");
    zone.className = "sb-zone"; zone.id = "sb-zone";
    const hintEl = document.createElement("em");
    hintEl.textContent = "Tap words to build the sentence…";
    zone.appendChild(hintEl);

    const pool = document.createElement("div");
    pool.className = "sb-chip-pool";

    // placed = array of {slotId, word}
    const placed = [];

    // Shuffle words — each gets a unique slotId even if same text
    const shuffled = [...ex.words].sort(() => Math.random() - .5);
    const chips = {};

    shuffled.forEach((word, i) => {
      const slotId = `slot_${i}`;
      const chip = document.createElement("div");
      chip.className = "sb-chip";
      chip.textContent = word;
      chip.dataset.slotId = slotId;
      chip.dataset.word = word;
      chips[slotId] = chip;

      const addToZone = () => {
        if (this.ans || chip.classList.contains("used")) return;
        // Create in-zone token
        const tok = document.createElement("div");
        tok.className = "sb-chip in-zone";
        tok.textContent = word;
        tok.dataset.slotId = slotId;

        tok.addEventListener("click", () => {
          if (this.ans) return;
          // Remove from placed
          const pi = placed.findIndex(p => p.slotId === slotId);
          if (pi > -1) placed.splice(pi, 1);
          tok.remove();
          chip.classList.remove("used");
          chip.draggable = true;
          if (!zone.querySelector(".sb-chip")) zone.appendChild(hintEl);
        });

        hintEl.remove();
        zone.appendChild(tok);
        chip.classList.add("used");
        chip.draggable = false;
        placed.push({ slotId, word });
      };

      chip.addEventListener("click", addToZone);
      chip.draggable = true;
      chip.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", slotId + "|" + word);
        chip.classList.add("dragging");
      });
      chip.addEventListener("dragend", () => chip.classList.remove("dragging"));
      pool.appendChild(chip);
    });

    // Drop on zone
    zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("over"); });
    zone.addEventListener("dragleave", () => zone.classList.remove("over"));
    zone.addEventListener("drop", e => {
      e.preventDefault();
      zone.classList.remove("over");
      const payload = e.dataTransfer.getData("text/plain");
      const [sId, word] = payload.split("|");
      const chip = chips[sId];
      if (chip && !chip.classList.contains("used")) {
        // simulate click
        chip.dispatchEvent(new Event("click"));
      }
    });

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn-check"; checkBtn.textContent = "✓ Check Sentence";
    checkBtn.addEventListener("click", () => {
      if (this.ans) return;
      if (!placed.length) { toast("Build your sentence first!", "t-inf"); return; }
      this.ans = true;
      const built = placed.map(p => p.word).join(" ");
      if (built.toLowerCase().trim() === ex.correct.toLowerCase().trim()) this._cor(ex, 0, 0);
      else this._wrg(ex);
    });

    con.appendChild(zone);
    con.appendChild(pool);
    con.appendChild(checkBtn);
  },

  /* ── ERROR SPOTTING ── */
  _es(ex, con) {
    if (ex.noerr) {
      const txt = document.createElement("p");
      txt.className = "es-text"; txt.textContent = ex.text;
      const note = document.createElement("p");
      note.style.cssText = "font-size:.78rem;color:var(--t3);margin-top:8px";
      note.textContent = "This sentence may be correct. Click a word to flag an error, or click 'No Error'.";
      const btn = document.createElement("button");
      btn.className = "btn-check"; btn.textContent = "✓ No Error — Sentence is Correct";
      btn.addEventListener("click", () => { if (this.ans) return; this.ans = true; this._cor(ex, 0, 0); });
      con.appendChild(txt); con.appendChild(note); con.appendChild(btn); return;
    }
    const note = document.createElement("p");
    note.style.cssText = "font-size:.78rem;color:var(--t3);margin-bottom:10px";
    note.textContent = "Click the word containing the grammatical error.";
    con.appendChild(note);
    const txt = document.createElement("p");
    txt.className = "es-text";
    ex.text.split(" ").forEach(raw => {
      const sp = document.createElement("span");
      sp.className = "word-sp"; sp.textContent = raw + " ";
      const clean = raw.replace(/[.,!?;:"]/g, "");
      sp.addEventListener("click", () => {
        if (this.ans) return;
        document.querySelectorAll(".word-sp").forEach(s => s.classList.remove("sel"));
        this.ans = true;
        if (clean.toLowerCase() === ex.err.toLowerCase()) {
          sp.classList.add("wOK"); this._cor(ex, 0, 0);
        } else {
          sp.classList.add("wBAD");
          document.querySelectorAll(".word-sp").forEach(s => {
            if (s.textContent.trim().replace(/[.,!?;:"]/g,"").toLowerCase() === ex.err.toLowerCase()) s.classList.add("wOK");
          });
          this._wrg(ex);
        }
      });
      txt.appendChild(sp);
    });
    con.appendChild(txt);
    const noBtn = document.createElement("button");
    noBtn.className = "btn-check sec"; noBtn.style.marginTop = "10px";
    noBtn.textContent = "✗ No Error in This Sentence";
    noBtn.addEventListener("click", () => { if (this.ans) return; this.ans = true; this._wrg(ex); });
    con.appendChild(noBtn);
  },

  /* ════════════════════════════════════════
     LISTENING EXERCISE
     Uses SpeechSynthesis API
     ════════════════════════════════════════ */
  _listening(ex, con) {
    const card = document.createElement("div");
    card.className = "listen-card";

    // Wave visualiser
    const wave = document.createElement("div");
    wave.className = "listen-wave";
    for (let i = 0; i < 6; i++) {
      const b = document.createElement("div");
      b.className = "wave-bar paused";
      wave.appendChild(b);
    }
    card.appendChild(wave);

    const listenBtn = document.createElement("button");
    listenBtn.className = "btn-listen";
    listenBtn.innerHTML = "🔊 Play Audio";

    const listenNote = document.createElement("p");
    listenNote.style.cssText = "font-size:.75rem;color:var(--t3);margin-top:-6px";
    listenNote.textContent = "Listen carefully, then choose the answer below.";

    let played = false;
    let playCount = 0;

    const playAudio = () => {
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(ex.audio);
        utt.lang = "en-US"; utt.rate = 0.88; utt.pitch = 1;
        utt.onstart = () => {
          listenBtn.innerHTML = "🔊 Playing…";
          listenBtn.classList.add("playing");
          wave.querySelectorAll(".wave-bar").forEach(b => b.classList.remove("paused"));
        };
        utt.onend = () => {
          listenBtn.innerHTML = playCount >= 1 ? "🔊 Play Again" : "🔊 Play Again";
          listenBtn.classList.remove("playing");
          wave.querySelectorAll(".wave-bar").forEach(b => b.classList.add("paused"));
          played = true; playCount++;
        };
        window.speechSynthesis.speak(utt);
      } else {
        toast("Speech synthesis not supported in this browser.", "t-err", 3000);
        played = true;
      }
    };

    listenBtn.addEventListener("click", playAudio);
    card.appendChild(listenBtn);
    card.appendChild(listenNote);
    con.appendChild(card);

    // MC options (only shown after first play? No — show always so UX is clear)
    const optsDiv = document.createElement("div");
    optsDiv.className = "ex-con";
    optsDiv.style.marginTop = "8px";
    const L = ["A","B","C","D"];
    ex.opts.forEach((o, i) => {
      const btn = document.createElement("button");
      btn.className = "mc-opt";
      btn.innerHTML = `<span class="mc-letter">${L[i]}</span><span>${o.t}</span>`;
      btn.addEventListener("click", ev => {
        if (this.ans) return;
        this.ans = true;
        window.speechSynthesis && window.speechSynthesis.cancel();
        wave.querySelectorAll(".wave-bar").forEach(b => b.classList.add("paused"));
        optsDiv.querySelectorAll(".mc-opt").forEach(b => b.disabled = true);
        if (o.c) { btn.classList.add("cor"); this._cor(ex, ev.clientX, ev.clientY); }
        else {
          btn.classList.add("wrg");
          optsDiv.querySelectorAll(".mc-opt").forEach((b, j) => { if (ex.opts[j]?.c) b.classList.add("cor"); });
          this._wrg(ex);
        }
      });
      optsDiv.appendChild(btn);
    });
    con.appendChild(optsDiv);

    // Auto-play on render
    setTimeout(playAudio, 600);
  },

  /* ════════════════════════════════════════
     SPEAKING EXERCISE — v2
     Fixes: mobile compat, onend-before-onresult,
     continuous mode, AudioContext unlock, timeout
     ════════════════════════════════════════ */
  _speaking(ex, con) {
    const card = document.createElement("div");
    card.className = "speak-card";

    const prompt = document.createElement("p");
    prompt.className = "speak-prompt"; prompt.textContent = ex.prompt;
    card.appendChild(prompt);

    const label = document.createElement("p");
    label.className = "speak-label"; label.textContent = "🎤 Tap the mic, then speak clearly";
    card.appendChild(label);

    const micBtn = document.createElement("button");
    micBtn.className = "btn-mic"; micBtn.innerHTML = "🎤";

    const status = document.createElement("p");
    status.className = "speak-status"; status.textContent = "Press the mic button to start";

    const transcript = document.createElement("div");
    transcript.className = "speak-transcript"; transcript.textContent = "Your speech will appear here…";

    card.appendChild(micBtn); card.appendChild(status); card.appendChild(transcript);
    con.appendChild(card);

    // Evaluate button
    const checkBtn = document.createElement("button");
    checkBtn.className = "btn-check"; checkBtn.textContent = "✓ Evaluate My Answer";
    checkBtn.style.display = "none";

    // Fallback text input
    const fallback = document.createElement("div");
    fallback.className = "speak-fallback";
    const fallbackNote = document.createElement("p");
    fallbackNote.style.cssText = "font-size:.75rem;color:var(--t3)";
    fallbackNote.textContent = "No mic? Type your answer below:";
    const fbInp = document.createElement("input");
    fbInp.className = "fib-inp"; fbInp.placeholder = "Type what you would say…";
    fbInp.autocomplete = "off";
    fallback.appendChild(fallbackNote); fallback.appendChild(fbInp);
    con.appendChild(fallback); con.appendChild(checkBtn);

    let finalTranscript = "";
    let gotResult = false;
    let stopTimer = null;
    let recording = false;

    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

    // ── No API at all ──
    if (!SpeechRec) {
      status.textContent = "Speech API not available — type your answer below.";
      micBtn.style.display = "none";
      fallback.classList.add("visible");
      checkBtn.style.display = "block";
      checkBtn.addEventListener("click", () => {
        if (this.ans) return;
        this._evalSpeak(ex, fbInp.value.trim().toLowerCase());
      });
      fbInp.addEventListener("keydown", e => { if (e.key === "Enter") checkBtn.click(); });
      return;
    }

    // ── Build a fresh recognizer each time (required on Safari/iOS) ──
    const buildRecog = () => {
      const r = new SpeechRec();
      r.lang = "en-US";
      r.continuous = true;          // continuous = true prevents premature stop on mobile
      r.interimResults = true;
      r.maxAlternatives = 2;
      return r;
    };

    let recog = buildRecog();
    this._recog = recog;

    const stopRecording = (reason) => {
      if (!recording) return;
      recording = false;
      clearTimeout(stopTimer);
      try { recog.stop(); } catch(e) {}
      micBtn.classList.remove("recording");
      micBtn.innerHTML = "🎤";
      if (gotResult && finalTranscript) {
        status.textContent = "✅ Captured — check your answer below.";
        status.classList.remove("active");
        checkBtn.style.display = "block";
        transcript.textContent = finalTranscript;
      } else if (reason === "timeout" && !gotResult) {
        status.textContent = "⚠️ No speech detected — try again or type below.";
        status.classList.remove("active");
        fallback.classList.add("visible");
        checkBtn.style.display = "block";
      } else {
        status.textContent = "Tap mic to try again.";
        status.classList.remove("active");
        if (finalTranscript) checkBtn.style.display = "block";
      }
    };

    recog.onresult = e => {
      gotResult = true;
      let interimText = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const res = e.results[i];
        if (res.isFinal) {
          finalTranscript += " " + res[0].transcript.toLowerCase();
          finalTranscript = finalTranscript.trim();
        } else {
          interimText = res[0].transcript;
        }
      }
      transcript.textContent = finalTranscript
        ? finalTranscript + (interimText ? " " + interimText : "")
        : interimText || "Listening…";
      // Reset auto-stop timer on each new word
      clearTimeout(stopTimer);
      stopTimer = setTimeout(() => stopRecording("silence"), 2500);
    };

    recog.onspeechstart = () => {
      status.textContent = "🎙️ Speech detected — keep speaking!";
      clearTimeout(stopTimer);
    };

    recog.onspeechend = () => {
      // Don't stop immediately — wait for onresult to fire
      stopTimer = setTimeout(() => stopRecording("silence"), 800);
    };

    recog.onerror = e => {
      recording = false; clearTimeout(stopTimer);
      micBtn.classList.remove("recording"); micBtn.innerHTML = "🎤";
      status.classList.remove("active");
      if (e.error === "not-allowed" || e.error === "permission-denied") {
        status.textContent = "🚫 Mic permission denied — type your answer below.";
        fallback.classList.add("visible");
        checkBtn.style.display = "block";
        micBtn.style.opacity = "0.4";
        micBtn.style.pointerEvents = "none";
      } else if (e.error === "no-speech") {
        status.textContent = "No speech heard — tap mic and try again.";
      } else if (e.error === "network") {
        status.textContent = "Network error — type your answer below.";
        fallback.classList.add("visible");
        checkBtn.style.display = "block";
      } else {
        status.textContent = `Error (${e.error}) — type below instead.`;
        fallback.classList.add("visible");
        checkBtn.style.display = "block";
      }
    };

    recog.onend = () => {
      // onend may fire before onresult on some browsers
      // If we still have recording=true, give a tiny grace period
      if (recording) {
        setTimeout(() => stopRecording("ended"), 300);
      }
    };

    micBtn.addEventListener("click", () => {
      if (this.ans) return;

      // Unlock AudioContext on mobile (user gesture requirement)
      if (Aud.ctx && Aud.ctx.state === "suspended") {
        Aud.ctx.resume().catch(() => {});
      }

      if (recording) {
        stopRecording("manual"); return;
      }

      // Fresh recognizer for each session (Safari/iOS requirement)
      try { recog.stop(); } catch(e) {}
      recog = buildRecog();
      this._recog = recog;
      gotResult = false; finalTranscript = "";
      transcript.textContent = "Listening…";

      // Attach handlers to the new recognizer instance
      recog.onresult = e => {
        gotResult = true;
        let interimText = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          if (res.isFinal) { finalTranscript += " " + res[0].transcript.toLowerCase(); finalTranscript = finalTranscript.trim(); }
          else { interimText = res[0].transcript; }
        }
        transcript.textContent = finalTranscript ? finalTranscript + (interimText ? " " + interimText : "") : interimText || "Listening…";
        clearTimeout(stopTimer);
        stopTimer = setTimeout(() => stopRecording("silence"), 2500);
      };
      recog.onspeechstart = () => { status.textContent = "🎙️ Speech detected!"; clearTimeout(stopTimer); };
      recog.onspeechend  = () => { stopTimer = setTimeout(() => stopRecording("silence"), 800); };
      recog.onerror = e => {
        recording = false; clearTimeout(stopTimer);
        micBtn.classList.remove("recording"); micBtn.innerHTML = "🎤"; status.classList.remove("active");
        if (e.error === "not-allowed" || e.error === "permission-denied") {
          status.textContent = "🚫 Mic denied — type below."; fallback.classList.add("visible"); checkBtn.style.display = "block";
          micBtn.style.opacity = "0.4"; micBtn.style.pointerEvents = "none";
        } else { status.textContent = `Error (${e.error}) — type below.`; fallback.classList.add("visible"); checkBtn.style.display = "block"; }
      };
      recog.onend = () => { if (recording) setTimeout(() => stopRecording("ended"), 300); };

      try {
        recog.start();
        recording = true;
        micBtn.classList.add("recording");
        micBtn.innerHTML = "⏹";
        status.textContent = "🔴 Recording — speak now!";
        status.classList.add("active");
        // Safety timeout: auto-stop after 15 seconds
        stopTimer = setTimeout(() => stopRecording("timeout"), 15000);
      } catch(err) {
        recording = false;
        status.textContent = "Could not start mic — type below.";
        fallback.classList.add("visible"); checkBtn.style.display = "block";
        console.error("SpeechRecognition start error:", err);
      }
    });

    checkBtn.addEventListener("click", () => {
      if (this.ans) return;
      if (recording) stopRecording("manual");
      const t = finalTranscript.trim() || fbInp.value.trim().toLowerCase();
      if (!t) { toast("Please say or type something first!", "t-inf"); return; }
      this._evalSpeak(ex, t);
    });

    fbInp.addEventListener("keydown", e => { if (e.key === "Enter") checkBtn.click(); });
    fbInp.addEventListener("input", () => { if (fbInp.value.trim()) checkBtn.style.display = "block"; });

    // Always show the text-type toggle
    const fbToggle = document.createElement("button");
    fbToggle.className = "btn-check sec"; fbToggle.style.marginTop = "8px";
    fbToggle.textContent = "⌨️ Type instead of speaking";
    fbToggle.addEventListener("click", () => {
      fallback.classList.toggle("visible");
      fbToggle.textContent = fallback.classList.contains("visible") ? "🎤 Use mic instead" : "⌨️ Type instead of speaking";
    });
    con.appendChild(fbToggle);
  },

  _evalSpeak(ex, transcript) {
    if (this.ans) return;
    this.ans = true;
    const t = transcript.toLowerCase().replace(/[.,!?;:'"]/g, "");
    // Check: must contain a minimum number of keywords
    const hits = ex.keywords.filter(kw => t.includes(kw.toLowerCase()));
    const pass = hits.length >= Math.ceil(ex.keywords.length * 0.5);
    if (pass) this._cor(ex, 0, 0);
    else this._wrg(ex);
  },

  /* ── CORRECT ── */
  _cor(ex, cx, cy) {
    const coins = this.gym ? 20 : 10;
    const xp    = this.gym ? 40 : 20;
    this.nOk++; this.sXP += xp; this.sCN += coins;
    S.eco.coins += coins; S.eco.xp += xp;
    S.radar[ex.skill] = Math.min(100, (S.radar[ex.skill] || 0) + 3);
    if (this.gym) S.prog.weak = S.prog.weak.filter(id => id !== ex.id);
    Store.save(); Aud.ok(); this._hud();
    if (cx && cy) coinFx(coins, cx, cy);
    this._fb(true, ex.expl, coins, xp);
  },

  /* ── WRONG ── */
  _wrg(ex) {
    this.lives = Math.max(0, this.lives - 1);
    document.getElementById("ex-lives").textContent = "❤️".repeat(this.lives) + "🖤".repeat(this.ML - this.lives);
    if (!S.prog.weak.includes(ex.id)) S.prog.weak.push(ex.id);
    Store.save(); Aud.ng();
    const c = document.getElementById("ex-con");
    if (c) { c.classList.add("shk"); setTimeout(() => c.classList.remove("shk"), 400); }
    this._fb(false, ex.expl, 0, 0);
    if (this.lives <= 0) {
      setTimeout(() => {
        toast("No lives left! Restarting…", "t-err", 2200);
        setTimeout(() => this.start(this.zone, this.gym), 2300);
      }, 1400);
    }
  },

  /* ── FEEDBACK ── */
  _fb(ok, expl, coins, xp) {
    const fb = document.getElementById("ex-fb");
    document.getElementById("fb-ico").textContent = ok ? "🎉" : "💡";
    document.getElementById("fb-tit").textContent = ok ? "Correct! Well done!" : "Not quite — study the explanation:";
    document.getElementById("fb-body").textContent = expl || "";
    document.getElementById("fb-rew").innerHTML = ok && coins
      ? `<div class="rew-tag rw-c">🪙 +${coins}</div><div class="rew-tag rw-x">⚡ +${xp} XP</div>${this.gym ? '<div class="rew-tag rw-g">🔥 2× Gym Bonus</div>' : ""}`
      : "";
    fb.className = `ex-fb show ${ok ? "ok" : "ng"}`;
    const nb = document.getElementById("ex-nxt");
    nb.className = `btn-next show ${ok ? "ok" : "ng"}`;
    nb.textContent = this.idx + 1 >= this.exs.length ? "🏁 Finish!" : "Continue →";
  },

  /* ── HUD UPDATE ── */
  _hud() {
    ["hc-map","hc-gym"].forEach(id => { const e = document.getElementById(id); if (e) e.textContent = S.eco.coins; });
    const x = document.getElementById("hx-map"); if (x) x.textContent = S.eco.xp;
  },

  /* ── DONE SCREEN ── */
  _showDone() {
    const total = this.exs.length;
    const acc   = Math.round((this.nOk / total) * 100);
    const stars = acc >= 90 ? 3 : acc >= 60 ? 2 : 1;
    const boss  = this.zone?.type === "boss";
    const pass  = boss && acc >= 80;

    document.getElementById("d-acc").textContent = acc + "%";
    document.getElementById("d-xp").textContent  = "+" + this.sXP;
    document.getElementById("d-cn").textContent  = "+" + this.sCN;

    for (let i = 1; i <= 3; i++) {
      const s = document.getElementById("ds" + i);
      s.textContent = i <= stars ? "⭐" : "☆";
      s.style.opacity = "0";
    }

    document.getElementById("d-title").textContent = pass
      ? "🏆 Boss Defeated!"
      : boss ? "📚 Almost There!"
      : ["Zone Complete!", "Excellent!", "Brilliant!", "Keep it up!"][Math.floor(Math.random() * 4)];

    document.getElementById("d-sub").textContent = pass
      ? `${this.zone.cefr} Boss Exam passed! Certificate unlocked!`
      : boss ? `Need 80%+ to pass. You scored ${acc}%. Try again!`
      : `${this.nOk} correct out of ${total}.`;

    if (this.zone && acc >= 60 && !S.prog.zones.includes(this.zone.id)) S.prog.zones.push(this.zone.id);
    if (this.zone) { const e = S.prog.stars[this.zone.id] || 0; if (stars > e) S.prog.stars[this.zone.id] = stars; }

    if (pass) {
      const wIdx = DB.worlds.findIndex(w => w.id === this.zone.id.split("Z")[0]);
      if (wIdx >= 0 && wIdx < DB.worlds.length - 1) {
        const nw = DB.worlds[wIdx + 1];
        if (!S.prog.worlds.includes(nw.id)) {
          S.prog.worlds.push(nw.id);
          toast(`🌍 ${nw.name} Unlocked!`, "t-ok", 3500);
        }
      }
    }

    Store.save(); Aud.done();
    const gb = document.getElementById("gbadge");
    if (gb) gb.classList.toggle("off", S.prog.weak.length === 0);

    document.getElementById("s-done").classList.add("show");
    document.getElementById("d-cont").onclick = () => {
      document.getElementById("s-done").classList.remove("show");
      Router.closeEx();
      if (pass) setTimeout(() => Cert.gen(this.zone.cefr), 700);
    };
  }
};

/* ═══════════════════════════════════════════════════════════
   GYM SCREEN
   ═══════════════════════════════════════════════════════════ */
const GymS = {
  render() {
    document.getElementById("hc-gym").textContent = S.eco.coins;
    const body = document.getElementById("gym-body");
    const wk = S.prog.weak;
    const em = Ex.getExMap();

    if (!wk.length) {
      body.innerHTML = `<div class="gym-empty"><span class="ge-ico">🎯</span><h3 class="ge-title">No Weaknesses Yet!</h3><p class="ge-desc">Complete lessons on the Map to fill your Gym training queue. Keep making mistakes — that's how you learn!</p></div>`;
      document.getElementById("gbadge").classList.add("off");
      return;
    }

    document.getElementById("gbadge").classList.remove("off");
    const gex = wk.slice(0, 10).map(id => em[id]).filter(Boolean);
    const icons = { vocabulary:"📖", grammar:"🔤", reading:"👁️", listening:"👂", speaking:"🎤", writing:"✍️" };

    body.innerHTML = `
      <div class="gym-hero">
        <span class="gym-ico">💪</span>
        <h3 class="gym-title">Weakness Training</h3>
        <p class="gym-desc">Practice ${gex.length} exercises you found difficult. Earn <strong style="color:var(--gold)">2× Bull Coins</strong> for each one you master!</p>
      </div>
      <div class="wk-list" id="wk-list"></div>`;

    const list = document.getElementById("wk-list");
    gex.forEach(ex => {
      const item = document.createElement("div"); item.className = "wk-item";
      item.innerHTML = `
        <div class="wk-ico">${icons[ex.skill]||"📚"}</div>
        <div class="wk-info">
          <div class="wk-q">${ex.q.substring(0,58)}${ex.q.length>58?"…":""}</div>
          <div class="wk-id">${ex.skill.toUpperCase()} · ${ex.type}</div>
        </div>`;
      list.appendChild(item);
    });

    const startBtn = document.createElement("button");
    startBtn.className = "btn-gym"; startBtn.textContent = "⚡ Start Gym Session";
    startBtn.addEventListener("click", () => {
      const gz = { id:"GYM", name:"Gym Session", type:"lesson", exercises: gex.sort(() => Math.random()-.5) };
      Ex.start(gz, true);
      Router.go("s-ex");
      document.getElementById("nav").classList.add("off");
      document.getElementById("user-chip").classList.add("off");
    });
    body.appendChild(startBtn);
  }
};

/* ═══════════════════════════════════════════════════════════
   PROFILE SCREEN
   Hexagonal radar — 6 skills
   ═══════════════════════════════════════════════════════════ */
const ProS = {
  SKILLS: [
    { k:"vocabulary", l:"Vocabulary", c:"#4a7cf7" },
    { k:"grammar",    l:"Grammar",    c:"#2dd4bf" },
    { k:"reading",    l:"Reading",    c:"#a78bfa" },
    { k:"listening",  l:"#fbbf24",    c:"#fbbf24", l2:"Listening" },
    { k:"speaking",   l:"Speaking",   c:"#fb7185" },
    { k:"writing",    l:"Writing",    c:"#d4a843" }
  ],

  render() {
    const { profile:p, eco, radar, prog, inv } = S;
    const lv   = Math.floor(eco.xp / 500) + 1;
    const xIn  = eco.xp % 500;
    const xPct = Math.min(100, Math.round(xIn / 500 * 100));
    const dz   = prog.zones.length;
    const tz   = DB.worlds.reduce((a, w) => a + w.zones.length, 0);
    const sk   = SHOP.find(s => s.id === p.skin) || SHOP[0];

    // Update nav avatar
    const navAv = document.getElementById("nav-av");
    const navNm = document.getElementById("nav-nm");
    if (navAv) navAv.textContent = sk.emoji;
    if (navNm) navNm.textContent = p.name ? p.name.split(" ")[0].substring(0,8) : "Profile";

    document.getElementById("pro-body").innerHTML = `
      <div class="pro-hero">
        <div class="av-wrap">
          <div class="av-ring ${sk.css}">${sk.emoji}</div>
          <span class="av-lv">Lv.${lv}</span>
        </div>
        <h2 class="pro-name">${p.name || "Student"}</h2>
        <p class="pro-title">${this._title(lv)}</p>
        <div class="pro-stats">
          <div class="pro-stat"><div class="ps-val" style="color:var(--gold)">${eco.coins}</div><div class="ps-lbl">Coins</div></div>
          <div class="pro-stat"><div class="ps-val" style="color:var(--purp)">${eco.xp}</div><div class="ps-lbl">Total XP</div></div>
          <div class="pro-stat"><div class="ps-val">${dz}/${tz}</div><div class="ps-lbl">Zones</div></div>
          <div class="pro-stat"><div class="ps-val" style="color:var(--err)">${prog.weak.length}</div><div class="ps-lbl">Weak</div></div>
        </div>
      </div>

      <div class="pro-section">
        <div class="sec-lbl">Level Progress</div>
        <div class="xp-card">
          <div class="xp-row"><span>Level ${lv}</span><span>${xIn} / 500 XP to Level ${lv+1}</span></div>
          <div class="xp-track"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
        </div>
      </div>

      <div class="pro-section">
        <div class="sec-lbl">Skill Radar — 6 Dimensions</div>
        <div class="radar-wrap"><canvas id="radar-cv" width="260" height="260"></canvas></div>
        <div class="radar-legend">${this._legend()}</div>
      </div>

      <div class="divider"></div>
      <div class="pro-section">
        <div class="sec-lbl">Account</div>
        <p style="font-size:.82rem;color:var(--t2);margin-bottom:6px">Signed in as <strong style="color:var(--t1)">${p.name || "Student"}</strong> · Member since ${p.joined}</p>
      </div>
      <button class="btn-logout" id="btn-logout">🚪 Sign Out & Reset Progress</button>
    `;

    // Logout handler
    document.getElementById("btn-logout").addEventListener("click", () => {
      if (!confirm("⚠️ This will erase ALL your progress and sign you out. Are you sure?")) return;
      localStorage.removeItem(Store.K);
      toast("Signed out. Reloading…", "t-inf", 1500);
      setTimeout(() => location.reload(), 1600);
    });

    requestAnimationFrame(() => {
      const f = document.getElementById("xp-fill");
      if (f) f.style.width = xPct + "%";
      const cv = document.getElementById("radar-cv");
      if (cv) this._drawRadar(cv);
    });
  },

  _title(lv) {
    if (lv >= 20) return "C2 Master · The Apex";
    if (lv >= 16) return "C1 Advanced · The Connoisseur";
    if (lv >= 12) return "B2 Upper-Intermediate · The Debater";
    if (lv >= 8)  return "B1 Intermediate · The Conversationalist";
    if (lv >= 4)  return "A2 Elementary · The Explorer";
    return "A1 Beginner · The Initiate";
  },

  _legend() {
    return this.SKILLS.map(s => {
      const val = S.radar[s.k] || 0;
      return `
        <div class="rl-item">
          <div class="rl-dot" style="background:${s.c}"></div>
          <span>${s.l2 || s.l}</span>
          <div class="rl-bar"><div class="rl-fill" style="width:${val}%;background:${s.c}"></div></div>
          <span class="rl-pct">${val}%</span>
        </div>`;
    }).join("");
  },

  /* ── HEXAGONAL RADAR (6 axes) ── */
  _drawRadar(canvas) {
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const cx = W / 2, cy = H / 2;
    const maxR = Math.min(W, H) * 0.34;
    const N = 6; // hexagon

    ctx.clearRect(0, 0, W, H);

    // Helper: angle for axis i (start from top, go clockwise)
    const angle = i => (Math.PI * 2 / N) * i - Math.PI / 2;

    // Grid rings (concentric hexagons)
    [0.25, 0.5, 0.75, 1.0].forEach(p => {
      ctx.beginPath();
      for (let i = 0; i < N; i++) {
        const a = angle(i), r = maxR * p;
        const x = cx + r * Math.cos(a), y = cy + r * Math.sin(a);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.strokeStyle = "rgba(255,255,255,0.07)";
      ctx.lineWidth = 1;
      ctx.stroke();
    });

    // Axis lines
    for (let i = 0; i < N; i++) {
      const a = angle(i);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + maxR * Math.cos(a), cy + maxR * Math.sin(a));
      ctx.strokeStyle = "rgba(255,255,255,0.09)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // Skill data polygon
    const skills = this.SKILLS;
    ctx.beginPath();
    skills.forEach((s, i) => {
      const a = angle(i);
      const r = ((S.radar[s.k] || 0) / 100) * maxR;
      const x = cx + r * Math.cos(a), y = cy + r * Math.sin(a);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.fillStyle = "rgba(212,168,67,0.14)";
    ctx.fill();
    ctx.strokeStyle = "rgba(212,168,67,0.7)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Dots per skill
    skills.forEach((s, i) => {
      const a = angle(i);
      const r = ((S.radar[s.k] || 0) / 100) * maxR;
      const x = cx + r * Math.cos(a), y = cy + r * Math.sin(a);
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fillStyle = s.c;
      ctx.fill();
    });

    // Labels
    skills.forEach((s, i) => {
      const a = angle(i);
      const lr = maxR + 22;
      const lx = cx + lr * Math.cos(a);
      const ly = cy + lr * Math.sin(a) + 4;
      ctx.font = "600 9.5px 'DM Sans', sans-serif";
      ctx.fillStyle = "rgba(240,238,232,0.6)";
      ctx.textAlign = "center";
      ctx.fillText(s.l2 || s.l, lx, ly);
    });
  }
};

/* ═══════════════════════════════════════════════════════════
   SHOP SCREEN
   ═══════════════════════════════════════════════════════════ */
const ShopS = {
  render() {
    const owned  = S.inv.skins;
    const active = S.profile.skin || "sk-default";
    const coins  = S.eco.coins;
    const body   = document.getElementById("shop-body");

    body.innerHTML = `
      <div class="bal-banner">
        <span class="bb-ico">🪙</span>
        <div><div class="bb-lbl">Your Balance</div><div class="bb-val">${coins}</div></div>
      </div>
      <div class="shop-section-lbl">Avatar Skins</div>
      <div class="shop-grid" id="shop-grid"></div>`;

    const grid = document.getElementById("shop-grid");

    SHOP.forEach(item => {
      const isOwned    = owned.includes(item.id);
      const isEquipped = active === item.id;
      const canAfford  = coins >= item.price;

      const card = document.createElement("div");
      card.className = `shop-card${isOwned?" owned":""}${isEquipped?" equip":""}`;
      card.innerHTML = `
        <div class="sc-av ${item.css}">${item.emoji}</div>
        <div class="sc-name">${item.name}</div>
        <div class="sc-desc">${item.desc}</div>
        <div class="sc-price">${item.price === 0 ? '<span style="color:var(--ok)">FREE</span>' : `🪙 ${item.price}`}</div>`;

      let btn = document.createElement("button");
      if (isEquipped) {
        btn.className = "sh-btn sb-equipped"; btn.disabled = true; btn.textContent = "✓ Equipped";
      } else if (isOwned) {
        btn.className = "sh-btn sb-equip"; btn.textContent = "Equip";
        btn.addEventListener("click", () => this._equip(item.id));
      } else {
        btn.className = "sh-btn sb-buy"; btn.disabled = !canAfford;
        btn.textContent = canAfford ? `🪙 ${item.price}` : `🔒 ${item.price}`;
        btn.addEventListener("click", ev => this._buy(item, ev));
      }
      card.appendChild(btn);
      grid.appendChild(card);
    });
  },

  _buy(item, ev) {
    if (S.eco.coins < item.price) { toast("Not enough Bull Coins!", "t-err"); return; }
    S.eco.coins -= item.price;
    S.inv.skins.push(item.id);
    Store.save(); Aud.coin();
    coinFx(-item.price, ev.clientX, ev.clientY);
    toast(`${item.name} unlocked! 🎉`, "t-ok");
    this.render();
  },

  _equip(id) {
    S.profile.skin = id;
    Store.save();
    updateNavUser();   // updates nav + chip
    toast("Skin equipped! 🎉", "t-inf");
    this.render();
  }
};

/* ═══════════════════════════════════════════════════════════
   RANK SCREEN
   ═══════════════════════════════════════════════════════════ */
const RankS = {
  _bNames: ["Alex_Pro","Sarah99","GamerEng","LunaESL","MaxWords","JennyB2","TopEnglish","CefrMaster","WordSmith","GramBot"],
  _bEmoji: ["🦊","🐺","🦅","🐯","🦁","🦈","🐻","🦝","🐼","🦋"],

  _initBots() {
    if (!S.bots) {
      S.bots = this._bNames.map((n, i) => ({
        name:n, emoji:this._bEmoji[i % this._bEmoji.length],
        xp: Math.floor(Math.random() * 3000) + 300
      }));
    }
    S.bots.forEach(b => { b.xp += Math.floor(Math.random() * 55); });
    Store.save();
  },

  render() {
    this._initBots();
    const skinData = SHOP.find(s => s.id === (S.profile.skin || "sk-default")) || SHOP[0];
    const all = [...S.bots.map(b => ({...b})), { name: S.profile.name || "You", emoji: skinData.emoji, xp: S.eco.xp, isU: true }]
      .sort((a, b) => b.xp - a.xp);
    const ur = all.findIndex(p => p.isU) + 1;
    const body = document.getElementById("rank-body");

    const top3 = all.slice(0, 3);
    let podHtml = '<div class="podium-area">';
    [1, 0, 2].forEach(i => {
      if (!top3[i]) return;
      const p = top3[i], rk = i + 1;
      const medals = ["🥇","🥈","🥉"];
      podHtml += `<div class="pod-pos">
        <div class="pod-av">${p.emoji}</div>
        <div class="pod-name">${p.name}</div>
        <div class="pod-xp">${p.xp.toLocaleString()} XP</div>
        <div class="pod-blk pb${rk}">${medals[i]}</div>
      </div>`;
    });
    podHtml += "</div>";

    const note = `<p class="rank-note">You are <strong style="color:var(--gold)">#${ur}</strong> of ${all.length}. ${ur > 1 ? `<span style="color:var(--purp)">${all[ur-2].xp - S.eco.xp + 1} XP</span> to move up!` : "🏆 You're leading!"}</p>`;

    let tbl = `<div class="rank-tbl"><div class="rank-hd"><span>#</span><span>Player</span><span style="text-align:right">XP</span></div>`;
    all.forEach((p, i) => {
      const rk = i + 1;
      const pc = rk === 1 ? "g" : rk === 2 ? "s" : rk === 3 ? "b" : "";
      const pl = rk === 1 ? "🥇" : rk === 2 ? "🥈" : rk === 3 ? "🥉" : rk;
      tbl += `<div class="rank-row${p.isU?" you":""}">
        <span class="rr-pos ${pc}">${pl}</span>
        <div class="rr-player"><div class="rr-av">${p.emoji}</div><span class="rr-nm">${p.name}${p.isU?" (You)":""}</span></div>
        <span class="rr-xp">${p.xp.toLocaleString()}</span>
      </div>`;
    });
    tbl += "</div>";
    body.innerHTML = podHtml + note + tbl;
  }
};

/* ═══════════════════════════════════════════════════════════
   CERTIFICATE
   ═══════════════════════════════════════════════════════════ */
const Cert = {
  CEFR_DATA: {
    A1:{ color:"#4a7cf7", color2:"#2a4cb0", label:"A1 — Beginner",     desc:"Foundation of English" },
    A2:{ color:"#2dd4bf", color2:"#0e9b8a", label:"A2 — Elementary",   desc:"Everyday Communication" },
    B1:{ color:"#f59e0b", color2:"#b36e08", label:"B1 — Intermediate", desc:"Independent User" },
    B2:{ color:"#a78bfa", color2:"#6d4fc7", label:"B2 — Upper-Intermediate", desc:"Confident Communicator" },
    C1:{ color:"#d4a843", color2:"#8c6e1f", label:"C1 — Advanced",     desc:"Effective Operational Proficiency" },
    C2:{ color:"#f4657a", color2:"#b03048", label:"C2 — Mastery",      desc:"Full Professional Mastery" },
  },

  gen(cefr) {
    const modal  = document.getElementById("s-cert");
    const canvas = document.getElementById("cert-canvas");
    const ctx    = canvas.getContext("2d");
    const W = 800, H = 560;
    canvas.width  = W;
    canvas.height = H;
    canvas.style.width  = "100%";
    canvas.style.height = "auto";

    const cd = this.CEFR_DATA[cefr] || this.CEFR_DATA["A1"];

    // ── Background ──
    const bgGrad = ctx.createLinearGradient(0, 0, W, H);
    bgGrad.addColorStop(0,   "#06060e");
    bgGrad.addColorStop(0.5, "#0c0c1a");
    bgGrad.addColorStop(1,   "#10101e");
    ctx.fillStyle = bgGrad; ctx.fillRect(0, 0, W, H);

    // ── Corner decorative gradient blooms ──
    const bloom = (x, y, r, color) => {
      const g = ctx.createRadialGradient(x, y, 0, x, y, r);
      g.addColorStop(0, color + "22");
      g.addColorStop(1, "transparent");
      ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);
    };
    bloom(0,   0,   220, cd.color);
    bloom(W,   H,   220, cd.color2);
    bloom(0,   H,   140, "#d4a843");
    bloom(W,   0,   140, "#d4a843");

    // ── Outer ornate border ──
    const borderGrad = ctx.createLinearGradient(0, 0, W, H);
    borderGrad.addColorStop(0,   cd.color);
    borderGrad.addColorStop(0.5, "#d4a843");
    borderGrad.addColorStop(1,   cd.color2);
    ctx.strokeStyle = borderGrad;
    ctx.lineWidth = 4;
    ctx.strokeRect(14, 14, W - 28, H - 28);

    // Inner thin border
    ctx.strokeStyle = "rgba(212,168,67,0.25)";
    ctx.lineWidth = 1;
    ctx.strokeRect(24, 24, W - 48, H - 48);

    // ── Corner ornaments ──
    const corners = [[34,34],[W-34,34],[34,H-34],[W-34,H-34]];
    corners.forEach(([cx, cy]) => {
      ctx.strokeStyle = cd.color + "99";
      ctx.lineWidth = 2;
      // L-shape corner
      const sz = 22;
      const sx = cx < W/2 ? 1 : -1, sy = cy < H/2 ? 1 : -1;
      ctx.beginPath(); ctx.moveTo(cx, cy + sy*sz); ctx.lineTo(cx, cy); ctx.lineTo(cx + sx*sz, cy); ctx.stroke();
      // Small diamond
      ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2);
      ctx.fillStyle = cd.color + "cc"; ctx.fill();
    });

    // ── Side decorative lines ──
    const drawSideLine = (x, y1, y2, alpha) => {
      ctx.strokeStyle = `rgba(212,168,67,${alpha})`;
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 6]);
      ctx.beginPath(); ctx.moveTo(x, y1); ctx.lineTo(x, y2); ctx.stroke();
      ctx.setLineDash([]);
    };
    drawSideLine(48, 60, H-60, 0.2);
    drawSideLine(W-48, 60, H-60, 0.2);

    // ── Header seal area ──
    // Circular watermark behind seal
    const sealX = W/2, sealY = 115;
    const outerRing = ctx.createRadialGradient(sealX, sealY, 30, sealX, sealY, 68);
    outerRing.addColorStop(0, "rgba(212,168,67,0.08)");
    outerRing.addColorStop(1, "transparent");
    ctx.fillStyle = outerRing; ctx.beginPath(); ctx.arc(sealX, sealY, 68, 0, Math.PI*2); ctx.fill();

    // Decorative ring
    ctx.beginPath(); ctx.arc(sealX, sealY, 58, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(212,168,67,0.3)"; ctx.lineWidth = 1.5;
    ctx.setLineDash([3, 5]); ctx.stroke(); ctx.setLineDash([]);

    ctx.beginPath(); ctx.arc(sealX, sealY, 50, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(212,168,67,0.18)"; ctx.lineWidth = 1; ctx.stroke();

    // Bull emoji centered
    ctx.font = "52px serif";
    ctx.textAlign = "center";
    ctx.fillText("🐂", sealX, sealY + 18);

    // ── Academy name ──
    ctx.font = "bold 11px 'Syne',sans-serif";
    ctx.fillStyle = cd.color;
    ctx.letterSpacing = "0.3em";
    ctx.textAlign = "center";
    ctx.fillText("BULL ENGLISH ACADEMY", W/2, 186);
    ctx.letterSpacing = "0";

    // Ornamental divider
    const drawDivider = (y, w, color) => {
      const half = w / 2;
      const gd = ctx.createLinearGradient(W/2 - half, y, W/2 + half, y);
      gd.addColorStop(0, "transparent");
      gd.addColorStop(0.2, color);
      gd.addColorStop(0.8, color);
      gd.addColorStop(1, "transparent");
      ctx.fillStyle = gd;
      ctx.fillRect(W/2 - half, y - 0.5, w, 1);
    };
    drawDivider(196, 420, "rgba(212,168,67,0.45)");
    // Diamond center
    ctx.save();
    ctx.translate(W/2, 196);
    ctx.rotate(Math.PI/4);
    ctx.fillStyle = cd.color; ctx.fillRect(-4, -4, 8, 8);
    ctx.restore();

    // ── "Certificate of Achievement" ──
    ctx.font = "italic 13px 'DM Sans',sans-serif";
    ctx.fillStyle = "rgba(240,238,232,0.5)";
    ctx.textAlign = "center";
    ctx.fillText("CERTIFICATE OF ACHIEVEMENT", W/2, 222);

    // ── "This is to certify that" ──
    ctx.font = "12px 'DM Sans',sans-serif";
    ctx.fillStyle = "rgba(240,238,232,0.38)";
    ctx.fillText("This is to certify that", W/2, 260);

    // ── Student name ──
    ctx.font = "bold 42px 'DM Sans',sans-serif";
    ctx.fillStyle = "#f0eee8";
    ctx.shadowColor = cd.color + "55";
    ctx.shadowBlur = 16;
    ctx.fillText(S.profile.name || "Student", W/2, 316);
    ctx.shadowBlur = 0;

    // Name underline
    const nameW = ctx.measureText(S.profile.name || "Student").width;
    const unGrad = ctx.createLinearGradient(W/2 - nameW/2, 0, W/2 + nameW/2, 0);
    unGrad.addColorStop(0, "transparent");
    unGrad.addColorStop(0.15, cd.color + "bb");
    unGrad.addColorStop(0.85, cd.color + "bb");
    unGrad.addColorStop(1, "transparent");
    ctx.fillStyle = unGrad;
    ctx.fillRect(W/2 - nameW/2 - 16, 324, nameW + 32, 1.5);

    // ── "has successfully completed" ──
    ctx.font = "13px 'DM Sans',sans-serif";
    ctx.fillStyle = "rgba(240,238,232,0.4)";
    ctx.fillText("has successfully completed the CEFR Boss Examination for", W/2, 356);

    // ── CEFR badge ──
    const badgeW = 260, badgeH = 46;
    const bx = W/2 - badgeW/2, by = 370;
    const bdg = ctx.createLinearGradient(bx, by, bx + badgeW, by);
    bdg.addColorStop(0, cd.color2);
    bdg.addColorStop(1, cd.color);
    ctx.fillStyle = bdg;
    ctx.beginPath(); ctx.roundRect(bx, by, badgeW, badgeH, 10); ctx.fill();
    // Badge inner border
    ctx.strokeStyle = "rgba(255,255,255,0.25)"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.roundRect(bx+2, by+2, badgeW-4, badgeH-4, 8); ctx.stroke();

    ctx.font = "bold 16px 'Syne',sans-serif";
    ctx.fillStyle = "#ffffff";
    ctx.textAlign = "center";
    ctx.fillText(cd.label, W/2, by + 21);
    ctx.font = "10px 'DM Sans',sans-serif";
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.fillText(cd.desc, W/2, by + 37);

    // ── Bottom divider ──
    drawDivider(436, 480, "rgba(212,168,67,0.3)");

    // ── Footer row ──
    const issueDate = new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
    const score = "Score: ≥80%";

    ctx.font = "10px 'DM Sans',sans-serif";
    ctx.fillStyle = "rgba(240,238,232,0.28)";
    ctx.textAlign = "left";
    ctx.fillText("📅 Issued: " + issueDate, 60, 464);
    ctx.textAlign = "center";
    ctx.fillText("CEFR Level " + cefr + " · Common European Framework of Reference", W/2, 464);
    ctx.textAlign = "right";
    ctx.fillText("✓ " + score, W - 60, 464);

    // ── Micro decorative dots at footer ──
    [W/2 - 120, W/2 - 60, W/2, W/2 + 60, W/2 + 120].forEach((x, i) => {
      ctx.beginPath(); ctx.arc(x, 480, 2, 0, Math.PI*2);
      ctx.fillStyle = i === 2 ? cd.color : "rgba(212,168,67,0.3)";
      ctx.fill();
    });

    // ── Watermark ──
    ctx.save();
    ctx.globalAlpha = 0.03;
    ctx.font = "bold 110px 'Syne',sans-serif";
    ctx.fillStyle = cd.color;
    ctx.textAlign = "center";
    ctx.translate(W/2, H/2 + 30);
    ctx.rotate(-Math.PI / 12);
    ctx.fillText("CERTIFIED", 0, 0);
    ctx.restore();

    modal.classList.add("show");

    document.getElementById("btn-cert-dl").onclick = () => {
      const a = document.createElement("a");
      a.download = `BullAcademy_${cefr}_Certificate.png`;
      a.href = canvas.toDataURL("image/png", 1.0);
      a.click();
      toast("Certificate downloaded! 🎓", "t-ok");
    };
    document.getElementById("btn-cert-cl").onclick = () => modal.classList.remove("show");
  }
};

/* ═══════════════════════════════════════════════════════════
   CLOSE EXERCISE BUTTON
   ═══════════════════════════════════════════════════════════ */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("ex-close").addEventListener("click", () => {
    if (!confirm("Exit this exercise? Progress will be lost.")) return;
    document.getElementById("s-done").classList.remove("show");
    Router.closeEx();
  });

  // User chip → navigate to Profile
  const chip = document.getElementById("user-chip");
  if (chip) chip.addEventListener("click", () => Router.go("s-pro"));
});

/* ═══════════════════════════════════════════════════════════
   ONBOARDING (no 'this' binding — uses plain variable)
   ═══════════════════════════════════════════════════════════ */
function initOnboarding() {
  let selLv = "A1";

  document.getElementById("lvl-grid").querySelectorAll(".lv-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".lv-btn").forEach(b => b.classList.remove("sel"));
      btn.classList.add("sel");
      selLv = btn.dataset.lv;
    });
  });

  document.getElementById("btn-start").addEventListener("click", () => {
    const inp  = document.getElementById("inp-name");
    const name = inp.value.trim();
    if (!name) {
      inp.classList.add("has-err"); inp.focus();
      toast("Please enter your name first!", "t-err");
      setTimeout(() => inp.classList.remove("has-err"), 1600);
      return;
    }

    S.profile.name = name;
    S.eco = { coins:150, xp:0 };

    const lvlOrder = ["A1","A2","B1","B2","C1","C2"];
    const si = Math.max(0, lvlOrder.indexOf(selLv));
    S.prog.worlds = [];
    for (let i = 0; i <= si; i++) S.prog.worlds.push(`W${i+1}`);
    // Only 3 worlds — cap
    S.prog.worlds = S.prog.worlds.filter(w => ["W1","W2","W3"].includes(w));

    Store.save();

    // THE KEY FIX: just manipulate classes, let the CSS do the work
    document.getElementById("s-splash").classList.remove("active");
    document.getElementById("nav").classList.remove("off");
    updateNavUser();
    Router.go("s-map");
    toast(`Welcome, ${name}! 🐂 Let's begin!`, "t-ok", 3200);
  });
}

/* ═══════════════════════════════════════════════════════════
   BOOTSTRAP
   ═══════════════════════════════════════════════════════════ */
function updateNavUser() {
  const sk = SHOP.find(s => s.id === (S.profile.skin || "sk-default")) || SHOP[0];
  const navAv = document.getElementById("nav-av");
  const navNm = document.getElementById("nav-nm");
  if (navAv) navAv.textContent = sk.emoji;
  if (navNm) navNm.textContent = S.profile.name ? S.profile.name.split(" ")[0].substring(0,8) : "Profile";

  // Update fixed user chip
  const chip   = document.getElementById("user-chip");
  const ucAv   = document.getElementById("uc-av");
  const ucName = document.getElementById("uc-name");
  if (chip && S.profile.name) {
    ucAv.textContent   = sk.emoji;
    ucName.textContent = S.profile.name;
    chip.classList.remove("off");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  Aud.init();
  const has = Store.load();
  Router.init();

  if (has && S.profile.name && S.profile.name !== "") {
    document.getElementById("s-splash").classList.remove("active");
    document.getElementById("nav").classList.remove("off");
    updateNavUser();
    const gb = document.getElementById("gbadge");
    if (gb) gb.classList.toggle("off", S.prog.weak.length === 0);
    Router.go("s-map");
  } else {
    // Splash has 'active' from HTML — just init onboarding
    initOnboarding();
  }
});
</script>
</body>
</html>
